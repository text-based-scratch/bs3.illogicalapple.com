"use strict";
/*!
This file is generated from source files in https://github.com/forkphorus/forkphorus
Please see the README for more information.

License for forkphorus:
The MIT License (MIT)

Copyright (c) 2013-2017 Nathan Dinsmore
Copyright (c) 2019-2021 Thomas Weber

Permission is hereby granted, free of charge, to any person obtaining a copy of
this software and associated documentation files (the "Software"), to deal in
the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
the Software, and to permit persons to whom the Software is furnished to do so,
subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

Parts of forkphorus are based on Sulfurous (https://sulfurous.aau.at/) and Scratch (https://scratch.mit.edu/)

License for Sulfurous:
The MIT License (MIT)
Copyright (c) 2013-2014 Nathan Dinsmore
Copyright (c) 2016 Mittagskogel
Copyright (c) 2017-2020 FRALEX

Permission is hereby granted, free of charge, to any person obtaining a copy of
this software and associated documentation files (the "Software"), to deal in
the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
the Software, and to permit persons to whom the Software is furnished to do so,
subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

License for Scratch:
Copyright (c) 2016, Massachusetts Institute of Technology
All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.

2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.

3. Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/if(!("Promise"in window))throw new Error("Browser does not support Promise");var P,P,P,P,P,P,P,P,P,P,P,P,P,P,P,P,P,P,P;!function(t){!function(t){t.debug=!1,t.useWebGL=!1,t.supportVideoSensing=!1,t.experimentalOptimizations=!1,t.scale=window.devicePixelRatio||1,t.PROJECT_API="https://projects.scratch.mit.edu/$id"}(t.config||(t.config={}))}(P||(P={})),function(t){!function(e){if(e.context=window.AudioContext?new AudioContext:window.webkitAudioContext?new window.webkitAudioContext:null,e.context){var n=e.context.createGain();n.gain.value=.5,n.connect(e.context.destination)}e.drums=[{name:"SnareDrum",baseRatio:.5946035575013605,loop:!1,loopStart:null,loopEnd:null,attackEnd:0,holdEnd:0,decayEnd:0},{name:"Tom",baseRatio:.5946035575013605,loop:!1,loopStart:null,loopEnd:null,attackEnd:0,holdEnd:0,decayEnd:0},{name:"SideStick",baseRatio:.5946035575013605,loop:!1,loopStart:null,loopEnd:null,attackEnd:0,holdEnd:0,decayEnd:0},{name:"Crash",baseRatio:.8908987181403393,loop:!1,loopStart:null,loopEnd:null,attackEnd:0,holdEnd:0,decayEnd:0},{name:"HiHatOpen",baseRatio:.9438743126816935,loop:!1,loopStart:null,loopEnd:null,attackEnd:0,holdEnd:0,decayEnd:0},{name:"HiHatClosed",baseRatio:.5946035575013605,loop:!1,loopStart:null,loopEnd:null,attackEnd:0,holdEnd:0,decayEnd:0},{name:"Tambourine",baseRatio:.5946035575013605,loop:!1,loopStart:null,loopEnd:null,attackEnd:0,holdEnd:0,decayEnd:0},{name:"Clap",baseRatio:.5946035575013605,loop:!1,loopStart:null,loopEnd:null,attackEnd:0,holdEnd:0,decayEnd:0},{name:"Claves",baseRatio:.5946035575013605,loop:!1,loopStart:null,loopEnd:null,attackEnd:0,holdEnd:0,decayEnd:0},{name:"WoodBlock",baseRatio:.7491535384383408,loop:!1,loopStart:null,loopEnd:null,attackEnd:0,holdEnd:0,decayEnd:0},{name:"Cowbell",baseRatio:.5946035575013605,loop:!1,loopStart:null,loopEnd:null,attackEnd:0,holdEnd:0,decayEnd:0},{name:"Triangle",baseRatio:.8514452780229479,loop:!0,loopStart:.7638548752834468,loopEnd:.7825396825396825,attackEnd:0,holdEnd:0,decayEnd:2},{name:"Bongo",baseRatio:.5297315471796477,loop:!1,loopStart:null,loopEnd:null,attackEnd:0,holdEnd:0,decayEnd:0},{name:"Conga",baseRatio:.7954545454545454,loop:!0,loopStart:.1926077097505669,loopEnd:.20403628117913833,attackEnd:0,holdEnd:0,decayEnd:2},{name:"Cabasa",baseRatio:.5946035575013605,loop:!1,loopStart:null,loopEnd:null,attackEnd:0,holdEnd:0,decayEnd:0},{name:"GuiroLong",baseRatio:.5946035575013605,loop:!1,loopStart:null,loopEnd:null,attackEnd:0,holdEnd:0,decayEnd:0},{name:"Vibraslap",baseRatio:.8408964152537145,loop:!1,loopStart:null,loopEnd:null,attackEnd:0,holdEnd:0,decayEnd:0},{name:"Cuica",baseRatio:.7937005259840998,loop:!1,loopStart:null,loopEnd:null,attackEnd:0,holdEnd:0,decayEnd:0}],e.instruments=[[{top:38,name:"AcousticPiano_As3",baseRatio:.5316313272700484,loop:!0,loopStart:.465578231292517,loopEnd:.7733786848072562,attackEnd:0,holdEnd:.1,decayEnd:22.1},{top:44,name:"AcousticPiano_C4",baseRatio:.5905141892259927,loop:!0,loopStart:.6334693877551021,loopEnd:.8605442176870748,attackEnd:0,holdEnd:.1,decayEnd:20.1},{top:51,name:"AcousticPiano_G4",baseRatio:.8843582887700535,loop:!0,loopStart:.5532879818594104,loopEnd:.5609977324263039,attackEnd:0,holdEnd:.08,decayEnd:18.08},{top:62,name:"AcousticPiano_C6",baseRatio:2.3557692307692304,loop:!0,loopStart:.5914739229024943,loopEnd:.6020861678004535,attackEnd:0,holdEnd:.08,decayEnd:16.08},{top:70,name:"AcousticPiano_F5",baseRatio:1.5776515151515151,loop:!0,loopStart:.5634920634920635,loopEnd:.5879818594104308,attackEnd:0,holdEnd:.04,decayEnd:14.04},{top:77,name:"AcousticPiano_Ds6",baseRatio:2.800762112139358,loop:!0,loopStart:.560907029478458,loopEnd:.5836281179138322,attackEnd:0,holdEnd:.02,decayEnd:10.02},{top:85,name:"AcousticPiano_Ds6",baseRatio:2.800762112139358,loop:!0,loopStart:.560907029478458,loopEnd:.5836281179138322,attackEnd:0,holdEnd:0,decayEnd:8},{top:90,name:"AcousticPiano_Ds6",baseRatio:2.800762112139358,loop:!0,loopStart:.560907029478458,loopEnd:.5836281179138322,attackEnd:0,holdEnd:0,decayEnd:6},{top:96,name:"AcousticPiano_D7",baseRatio:5.275119617224881,loop:!0,loopStart:.3380498866213152,loopEnd:.34494331065759637,attackEnd:0,holdEnd:0,decayEnd:3},{top:128,name:"AcousticPiano_D7",baseRatio:5.275119617224881,loop:!0,loopStart:.3380498866213152,loopEnd:.34494331065759637,attackEnd:0,holdEnd:0,decayEnd:2}],[{top:48,name:"ElectricPiano_C2",baseRatio:.14870515241435123,loop:!0,loopStart:.6956009070294784,loopEnd:.7873015873015873,attackEnd:0,holdEnd:.08,decayEnd:10.08},{top:74,name:"ElectricPiano_C4",baseRatio:.5945685670261941,loop:!0,loopStart:.5181859410430839,loopEnd:.5449433106575964,attackEnd:0,holdEnd:.04,decayEnd:8.04},{top:128,name:"ElectricPiano_C4",baseRatio:.5945685670261941,loop:!0,loopStart:.5181859410430839,loopEnd:.5449433106575964,attackEnd:0,holdEnd:0,decayEnd:6}],[{top:128,name:"Organ_G2",baseRatio:.22283731584620914,loop:!0,loopStart:.05922902494331066,loopEnd:.1510204081632653,attackEnd:0,holdEnd:0,decayEnd:0}],[{top:40,name:"AcousticGuitar_F3",baseRatio:.3977272727272727,loop:!0,loopStart:1.6628117913832199,loopEnd:1.6685260770975057,attackEnd:0,holdEnd:0,decayEnd:15},{top:56,name:"AcousticGuitar_F3",baseRatio:.3977272727272727,loop:!0,loopStart:1.6628117913832199,loopEnd:1.6685260770975057,attackEnd:0,holdEnd:0,decayEnd:13.5},{top:60,name:"AcousticGuitar_F3",baseRatio:.3977272727272727,loop:!0,loopStart:1.6628117913832199,loopEnd:1.6685260770975057,attackEnd:0,holdEnd:0,decayEnd:12},{top:67,name:"AcousticGuitar_F3",baseRatio:.3977272727272727,loop:!0,loopStart:1.6628117913832199,loopEnd:1.6685260770975057,attackEnd:0,holdEnd:0,decayEnd:8.5},{top:72,name:"AcousticGuitar_F3",baseRatio:.3977272727272727,loop:!0,loopStart:1.6628117913832199,loopEnd:1.6685260770975057,attackEnd:0,holdEnd:0,decayEnd:7},{top:83,name:"AcousticGuitar_F3",baseRatio:.3977272727272727,loop:!0,loopStart:1.6628117913832199,loopEnd:1.6685260770975057,attackEnd:0,holdEnd:0,decayEnd:5.5},{top:128,name:"AcousticGuitar_F3",baseRatio:.3977272727272727,loop:!0,loopStart:1.6628117913832199,loopEnd:1.6685260770975057,attackEnd:0,holdEnd:0,decayEnd:4.5}],[{top:40,name:"ElectricGuitar_F3",baseRatio:.39615522817103843,loop:!0,loopStart:1.5733333333333333,loopEnd:1.5848072562358,attackEnd:0,holdEnd:0,decayEnd:15},{top:56,name:"ElectricGuitar_F3",baseRatio:.39615522817103843,loop:!0,loopStart:1.5733333333333333,loopEnd:1.5848072562358277,attackEnd:0,holdEnd:0,decayEnd:13.5},{top:60,name:"ElectricGuitar_F3",baseRatio:.39615522817103843,loop:!0,loopStart:1.5733333333333333,loopEnd:1.5848072562358277,attackEnd:0,holdEnd:0,decayEnd:12},{top:67,name:"ElectricGuitar_F3",baseRatio:.39615522817103843,loop:!0,loopStart:1.5733333333333333,loopEnd:1.5848072562358277,attackEnd:0,holdEnd:0,decayEnd:8.5},{top:72,name:"ElectricGuitar_F3",baseRatio:.39615522817103843,loop:!0,loopStart:1.5733333333333333,loopEnd:1.5848072562358277,attackEnd:0,holdEnd:0,decayEnd:7},{top:83,name:"ElectricGuitar_F3",baseRatio:.39615522817103843,loop:!0,loopStart:1.5733333333333333,loopEnd:1.5848072562358277,attackEnd:0,holdEnd:0,decayEnd:5.5},{top:128,name:"ElectricGuitar_F3",baseRatio:.39615522817103843,loop:!0,loopStart:1.5733333333333333,loopEnd:1.5848072562358277,attackEnd:0,holdEnd:0,decayEnd:4.5}],[{top:34,name:"ElectricBass_G1",baseRatio:.11111671034065712,loop:!0,loopStart:1.9007709750566892,loopEnd:1.9212244897959183,attackEnd:0,holdEnd:0,decayEnd:17},{top:48,name:"ElectricBass_G1",baseRatio:.11111671034065712,loop:!0,loopStart:1.9007709750566892,loopEnd:1.9212244897959183,attackEnd:0,holdEnd:0,decayEnd:14},{top:64,name:"ElectricBass_G1",baseRatio:.11111671034065712,loop:!0,loopStart:1.9007709750566892,loopEnd:1.9212244897959183,attackEnd:0,holdEnd:0,decayEnd:12},{top:128,name:"ElectricBass_G1",baseRatio:.11111671034065712,loop:!0,loopStart:1.9007709750566892,loopEnd:1.9212244897959183,attackEnd:0,holdEnd:0,decayEnd:10}],[{top:38,name:"Pizz_G2",baseRatio:.21979665071770335,loop:!0,loopStart:.3879365079365079,loopEnd:.3982766439909297,attackEnd:0,holdEnd:0,decayEnd:5},{top:45,name:"Pizz_G2",baseRatio:.21979665071770335,loop:!0,loopStart:.3879365079365079,loopEnd:.3982766439909297,attackEnd:0,holdEnd:.012,decayEnd:4.012},{top:56,name:"Pizz_A3",baseRatio:.503654636820466,loop:!0,loopStart:.5197278911564626,loopEnd:.5287528344671202,attackEnd:0,holdEnd:0,decayEnd:4},{top:64,name:"Pizz_A3",baseRatio:.503654636820466,loop:!0,loopStart:.5197278911564626,loopEnd:.5287528344671202,attackEnd:0,holdEnd:0,decayEnd:3.2},{top:72,name:"Pizz_E4",baseRatio:.7479647218453188,loop:!0,loopStart:.7947845804988662,loopEnd:.7978231292517007,attackEnd:0,holdEnd:0,decayEnd:2.8},{top:80,name:"Pizz_E4",baseRatio:.7479647218453188,loop:!0,loopStart:.7947845804988662,loopEnd:.7978231292517007,attackEnd:0,holdEnd:0,decayEnd:2.2},{top:128,name:"Pizz_E4",baseRatio:.7479647218453188,loop:!0,loopStart:.7947845804988662,loopEnd:.7978231292517007,attackEnd:0,holdEnd:0,decayEnd:1.5}],[{top:41,name:"Cello_C2",baseRatio:.14870515241435123,loop:!0,loopStart:.3876643990929705,loopEnd:.40294784580498866,attackEnd:0,holdEnd:0,decayEnd:0},{top:52,name:"Cello_As2",baseRatio:.263755980861244,loop:!0,loopStart:.3385487528344671,loopEnd:.35578231292517004,attackEnd:0,holdEnd:0,decayEnd:0},{top:62,name:"Violin_D4",baseRatio:.6664047388781432,loop:!0,loopStart:.48108843537414964,loopEnd:.5151927437641723,attackEnd:0,holdEnd:0,decayEnd:0},{top:75,name:"Violin_A4",baseRatio:.987460815047022,loop:!0,loopStart:.14108843537414967,loopEnd:.15029478458049886,attackEnd:.07,holdEnd:.07,decayEnd:.07},{top:128,name:"Violin_E5",baseRatio:1.4885238523852387,loop:!0,loopStart:.10807256235827664,loopEnd:.1126530612244898,attackEnd:0,holdEnd:0,decayEnd:0}],[{top:30,name:"BassTrombone_A2_3",baseRatio:.24981872564125807,loop:!0,loopStart:.061541950113378686,loopEnd:.10702947845804989,attackEnd:0,holdEnd:0,decayEnd:0},{top:40,name:"BassTrombone_A2_2",baseRatio:.24981872564125807,loop:!0,loopStart:.08585034013605441,loopEnd:.13133786848072562,attackEnd:0,holdEnd:0,decayEnd:0},{top:55,name:"Trombone_B3",baseRatio:.5608240680183126,loop:!0,loopStart:.12,loopEnd:.17673469387755103,attackEnd:0,holdEnd:0,decayEnd:0},{top:88,name:"Trombone_B3",baseRatio:.5608240680183126,loop:!0,loopStart:.12,loopEnd:.17673469387755103,attackEnd:.05,holdEnd:.05,decayEnd:.05},{top:128,name:"Trumpet_E5",baseRatio:1.4959294436906376,loop:!0,loopStart:.1307936507936508,loopEnd:.14294784580498865,attackEnd:0,holdEnd:0,decayEnd:0}],[{top:128,name:"Clarinet_C4",baseRatio:.5940193965517241,loop:!0,loopStart:.6594104308390023,loopEnd:.7014965986394558,attackEnd:0,holdEnd:0,decayEnd:0}],[{top:40,name:"TenorSax_C3",baseRatio:.2971698113207547,loop:!0,loopStart:.4053968253968254,loopEnd:.4895238095238095,attackEnd:0,holdEnd:0,decayEnd:0},{top:50,name:"TenorSax_C3",baseRatio:.2971698113207547,loop:!0,loopStart:.4053968253968254,loopEnd:.4895238095238095,attackEnd:.02,holdEnd:.02,decayEnd:.02},{top:59,name:"TenorSax_C3",baseRatio:.2971698113207547,loop:!0,loopStart:.4053968253968254,loopEnd:.4895238095238095,attackEnd:.04,holdEnd:.04,decayEnd:.04},{top:67,name:"AltoSax_A3",baseRatio:.49814747876378096,loop:!0,loopStart:.3875736961451247,loopEnd:.4103854875283447,attackEnd:0,holdEnd:0,decayEnd:0},{top:75,name:"AltoSax_A3",baseRatio:.49814747876378096,loop:!0,loopStart:.3875736961451247,loopEnd:.4103854875283447,attackEnd:.02,holdEnd:.02,decayEnd:.02},{top:80,name:"AltoSax_A3",baseRatio:.49814747876378096,loop:!0,loopStart:.3875736961451247,loopEnd:.4103854875283447,attackEnd:.02,holdEnd:.02,decayEnd:.02},{top:128,name:"AltoSax_C6",baseRatio:2.3782742681047764,loop:!0,loopStart:.05705215419501134,loopEnd:.0838095238095238,attackEnd:0,holdEnd:0,decayEnd:0}],[{top:61,name:"Flute_B5_2",baseRatio:2.255113636363636,loop:!0,loopStart:.08430839002267573,loopEnd:.10244897959183673,attackEnd:0,holdEnd:0,decayEnd:0},{top:128,name:"Flute_B5_1",baseRatio:2.255113636363636,loop:!0,loopStart:.10965986394557824,loopEnd:.12780045351473923,attackEnd:0,holdEnd:0,decayEnd:0}],[{top:128,name:"WoodenFlute_C5",baseRatio:1.1892952324548416,loop:!0,loopStart:.5181859410430839,loopEnd:.7131065759637188,attackEnd:0,holdEnd:0,decayEnd:0}],[{top:57,name:"Bassoon_C3",baseRatio:.29700969827586204,loop:!0,loopStart:.11011337868480725,loopEnd:.19428571428571428,attackEnd:0,holdEnd:0,decayEnd:0},{top:67,name:"Bassoon_C3",baseRatio:.29700969827586204,loop:!0,loopStart:.11011337868480725,loopEnd:.19428571428571428,attackEnd:.04,holdEnd:.04,decayEnd:.04},{top:76,name:"Bassoon_C3",baseRatio:.29700969827586204,loop:!0,loopStart:.11011337868480725,loopEnd:.19428571428571428,attackEnd:.08,holdEnd:.08,decayEnd:.08},{top:84,name:"EnglishHorn_F3",baseRatio:.39601293103448276,loop:!0,loopStart:.341859410430839,loopEnd:.4049886621315193,attackEnd:.04,holdEnd:.04,decayEnd:.04},{top:128,name:"EnglishHorn_D4",baseRatio:.6699684005833739,loop:!0,loopStart:.22027210884353743,loopEnd:.23723356009070296,attackEnd:0,holdEnd:0,decayEnd:0}],[{top:39,name:"Choir_F3",baseRatio:.3968814788643197,loop:!0,loopStart:.6352380952380953,loopEnd:1.8721541950113378,attackEnd:0,holdEnd:0,decayEnd:0},{top:50,name:"Choir_F3",baseRatio:.3968814788643197,loop:!0,loopStart:.6352380952380953,loopEnd:1.8721541950113378,attackEnd:.04,holdEnd:.04,decayEnd:.04},{top:61,name:"Choir_F3",baseRatio:.3968814788643197,loop:!0,loopStart:.6352380952380953,loopEnd:1.8721541950113378,attackEnd:.06,holdEnd:.06,decayEnd:.06},{top:72,name:"Choir_F4",baseRatio:.7928898424161845,loop:!0,loopStart:.7415419501133786,loopEnd:2.1059410430839,attackEnd:0,holdEnd:0,decayEnd:0},{top:128,name:"Choir_F5",baseRatio:1.5879576065654504,loop:!0,loopStart:.836281179138322,loopEnd:2.0585487528344673,attackEnd:0,holdEnd:0,decayEnd:0}],[{top:38,name:"Vibraphone_C3",baseRatio:.29829545454545453,loop:!0,loopStart:.2812698412698413,loopEnd:.28888888888888886,attackEnd:0,holdEnd:.1,decayEnd:8.1},{top:48,name:"Vibraphone_C3",baseRatio:.29829545454545453,loop:!0,loopStart:.2812698412698413,loopEnd:.28888888888888886,attackEnd:0,holdEnd:.1,decayEnd:7.6},{top:59,name:"Vibraphone_C3",baseRatio:.29829545454545453,loop:!0,loopStart:.2812698412698413,loopEnd:.28888888888888886,attackEnd:0,holdEnd:.06,decayEnd:7.06},{top:70,name:"Vibraphone_C3",baseRatio:.29829545454545453,loop:!0,loopStart:.2812698412698413,loopEnd:.28888888888888886,attackEnd:0,holdEnd:.04,decayEnd:6.04},{top:78,name:"Vibraphone_C3",baseRatio:.29829545454545453,loop:!0,loopStart:.2812698412698413,loopEnd:.28888888888888886,attackEnd:0,holdEnd:.02,decayEnd:5.02},{top:86,name:"Vibraphone_C3",baseRatio:.29829545454545453,loop:!0,loopStart:.2812698412698413,loopEnd:.28888888888888886,attackEnd:0,holdEnd:0,decayEnd:4},{top:128,name:"Vibraphone_C3",baseRatio:.29829545454545453,loop:!0,loopStart:.2812698412698413,loopEnd:.28888888888888886,attackEnd:0,holdEnd:0,decayEnd:3}],[{top:128,name:"MusicBox_C4",baseRatio:.5937634640241276,loop:!0,loopStart:.6475283446712018,loopEnd:.6666666666666666,attackEnd:0,holdEnd:0,decayEnd:2}],[{top:128,name:"SteelDrum_D5",baseRatio:1.3660402567543959,loop:!1,loopStart:-45351473922902495e-21,loopEnd:-45351473922902495e-21,attackEnd:0,holdEnd:0,decayEnd:2}],[{top:128,name:"Marimba_C4",baseRatio:.5946035575013605,loop:!1,loopStart:-45351473922902495e-21,loopEnd:-45351473922902495e-21,attackEnd:0,holdEnd:0,decayEnd:0}],[{top:80,name:"SynthLead_C4",baseRatio:.5942328422565577,loop:!0,loopStart:.006122448979591836,loopEnd:.06349206349206349,attackEnd:0,holdEnd:0,decayEnd:0},{top:128,name:"SynthLead_C6",baseRatio:2.3760775862068964,loop:!0,loopStart:.005623582766439909,loopEnd:.01614512471655329,attackEnd:0,holdEnd:0,decayEnd:0}],[{top:38,name:"SynthPad_A3",baseRatio:.4999105065330231,loop:!0,loopStart:.1910204081632653,loopEnd:3.9917006802721087,attackEnd:.05,holdEnd:.05,decayEnd:.05},{top:50,name:"SynthPad_A3",baseRatio:.4999105065330231,loop:!0,loopStart:.1910204081632653,loopEnd:3.9917006802721087,attackEnd:.08,holdEnd:.08,decayEnd:.08},{top:62,name:"SynthPad_A3",baseRatio:.4999105065330231,loop:!0,loopStart:.1910204081632653,loopEnd:3.9917006802721087,attackEnd:.11,holdEnd:.11,decayEnd:.11},{top:74,name:"SynthPad_A3",baseRatio:.4999105065330231,loop:!0,loopStart:.1910204081632653,loopEnd:3.9917006802721087,attackEnd:.15,holdEnd:.15,decayEnd:.15},{top:86,name:"SynthPad_A3",baseRatio:.4999105065330231,loop:!0,loopStart:.1910204081632653,loopEnd:3.9917006802721087,attackEnd:.2,holdEnd:.2,decayEnd:.2},{top:128,name:"SynthPad_C6",baseRatio:2.3820424708835755,loop:!0,loopStart:.11678004535147392,loopEnd:.41732426303854875,attackEnd:0,holdEnd:0,decayEnd:0}]];const s={AcousticGuitar_F3:"sb2/instruments/AcousticGuitar_F3_22k.wav",AcousticPiano_As3:"sb2/instruments/AcousticPiano(5)_A%233_22k.wav",AcousticPiano_C4:"sb2/instruments/AcousticPiano(5)_C4_22k.wav",AcousticPiano_G4:"sb2/instruments/AcousticPiano(5)_G4_22k.wav",AcousticPiano_F5:"sb2/instruments/AcousticPiano(5)_F5_22k.wav",AcousticPiano_C6:"sb2/instruments/AcousticPiano(5)_C6_22k.wav",AcousticPiano_Ds6:"sb2/instruments/AcousticPiano(5)_D%236_22k.wav",AcousticPiano_D7:"sb2/instruments/AcousticPiano(5)_D7_22k.wav",AltoSax_A3:"sb2/instruments/AltoSax_A3_22K.wav",AltoSax_C6:"sb2/instruments/AltoSax(3)_C6_22k.wav",Bassoon_C3:"sb2/instruments/Bassoon_C3_22k.wav",BassTrombone_A2_2:"sb2/instruments/BassTrombone_A2(2)_22k.wav",BassTrombone_A2_3:"sb2/instruments/BassTrombone_A2(3)_22k.wav",Cello_C2:"sb2/instruments/Cello(3b)_C2_22k.wav",Cello_As2:"sb2/instruments/Cello(3)_A%232_22k.wav",Choir_F3:"sb2/instruments/Choir(4)_F3_22k.wav",Choir_F4:"sb2/instruments/Choir(4)_F4_22k.wav",Choir_F5:"sb2/instruments/Choir(4)_F5_22k.wav",Clarinet_C4:"sb2/instruments/Clarinet_C4_22k.wav",ElectricBass_G1:"sb2/instruments/ElectricBass(2)_G1_22k.wav",ElectricGuitar_F3:"sb2/instruments/ElectricGuitar(2)_F3(1)_22k.wav",ElectricPiano_C2:"sb2/instruments/ElectricPiano_C2_22k.wav",ElectricPiano_C4:"sb2/instruments/ElectricPiano_C4_22k.wav",EnglishHorn_D4:"sb2/instruments/EnglishHorn(1)_D4_22k.wav",EnglishHorn_F3:"sb2/instruments/EnglishHorn(1)_F3_22k.wav",Flute_B5_1:"sb2/instruments/Flute(3)_B5(1)_22k.wav",Flute_B5_2:"sb2/instruments/Flute(3)_B5(2)_22k.wav",Marimba_C4:"sb2/instruments/Marimba_C4_22k.wav",MusicBox_C4:"sb2/instruments/MusicBox_C4_22k.wav",Organ_G2:"sb2/instruments/Organ(2)_G2_22k.wav",Pizz_A3:"sb2/instruments/Pizz(2)_A3_22k.wav",Pizz_E4:"sb2/instruments/Pizz(2)_E4_22k.wav",Pizz_G2:"sb2/instruments/Pizz(2)_G2_22k.wav",SteelDrum_D5:"sb2/instruments/SteelDrum_D5_22k.wav",SynthLead_C4:"sb2/instruments/SynthLead(6)_C4_22k.wav",SynthLead_C6:"sb2/instruments/SynthLead(6)_C6_22k.wav",SynthPad_A3:"sb2/instruments/SynthPad(2)_A3_22k.wav",SynthPad_C6:"sb2/instruments/SynthPad(2)_C6_22k.wav",TenorSax_C3:"sb2/instruments/TenorSax(1)_C3_22k.wav",Trombone_B3:"sb2/instruments/Trombone_B3_22k.wav",Trumpet_E5:"sb2/instruments/Trumpet_E5_22k.wav",Vibraphone_C3:"sb2/instruments/Vibraphone_C3_22k.wav",Violin_D4:"sb2/instruments/Violin(2)_D4_22K.wav",Violin_A4:"sb2/instruments/Violin(3)_A4_22k.wav",Violin_E5:"sb2/instruments/Violin(3b)_E5_22k.wav",WoodenFlute_C5:"sb2/instruments/WoodenFlute_C5_22k.wav",BassDrum:"sb2/drums/BassDrum(1b)_22k.wav",Bongo:"sb2/drums/Bongo_22k.wav",Cabasa:"sb2/drums/Cabasa(1)_22k.wav",Clap:"sb2/drums/Clap(1)_22k.wav",Claves:"sb2/drums/Claves(1)_22k.wav",Conga:"sb2/drums/Conga(1)_22k.wav",Cowbell:"sb2/drums/Cowbell(3)_22k.wav",Crash:"sb2/drums/Crash(2)_22k.wav",Cuica:"sb2/drums/Cuica(2)_22k.wav",GuiroLong:"sb2/drums/GuiroLong(1)_22k.wav",GuiroShort:"sb2/drums/GuiroShort(1)_22k.wav",HiHatClosed:"sb2/drums/HiHatClosed(1)_22k.wav",HiHatOpen:"sb2/drums/HiHatOpen(2)_22k.wav",HiHatPedal:"sb2/drums/HiHatPedal(1)_22k.wav",Maracas:"sb2/drums/Maracas(1)_22k.wav",SideStick:"sb2/drums/SideStick(1)_22k.wav",SnareDrum:"sb2/drums/SnareDrum(1)_22k.wav",Tambourine:"sb2/drums/Tambourine(3)_22k.wav",Tom:"sb2/drums/Tom(1)_22k.wav",Triangle:"sb2/drums/Triangle(1)_22k.wav",Vibraslap:"sb2/drums/Vibraslap(1)_22k.wav",WoodBlock:"sb2/drums/WoodBlock(1)_22k.wav"},i={};function r(e){return t.io.getAssetManager().loadSoundbankFile(s[e]).then((e=>t.audio.decodeAudio(e))).then((t=>i[e]=t))}e.loadSoundbankSB2=function(n){if(!e.context)return Promise.resolve();const o=[];for(const e in s)if(!i[e]){const s=t.utils.settled(r(e));o.push(s),n&&n.addTask(new t.io.PromiseTask(s))}return Promise.all(o)},e.playSpan=function(t,n,s,r){if(!e.context)throw new Error("Cannot playSpan without an AudioContext");const o=i[t.name];if(!o)throw new Error("No soundbank entry named: "+t.name);const a=e.context.createBufferSource(),l=e.context.createGain();a.buffer=o,(a.loop=t.loop)&&(a.loopStart=t.loopStart,a.loopEnd=t.loopEnd),a.connect(l),l.connect(r);const h=e.context.currentTime;a.playbackRate.value=Math.pow(2,(n-69)/12)/t.baseRatio;const c=l.gain;return c.value=0,c.setValueAtTime(0,h),t.attackEnd<s?(c.linearRampToValueAtTime(1,h+t.attackEnd),t.decayTime>0&&t.holdEnd<s?(c.linearRampToValueAtTime(1,h+t.holdEnd),t.decayEnd<s?c.linearRampToValueAtTime(0,h+t.decayEnd):c.linearRampToValueAtTime(1-(s-t.holdEnd)/t.decayTime,h+s)):c.linearRampToValueAtTime(1,h+s)):c.linearRampToValueAtTime(1,h+s),c.linearRampToValueAtTime(0,h+s+.02267573696),a.start(h),a.stop(h+s+.02267573696),a},e.connectNode=function(t){t.connect(n)};const o=[7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767],a=[-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8];e.decodeAudio=function(t){return e.context?new Promise(((n,s)=>{!function(t,n){var s=new DataView(t);if(1380533830!==s.getUint32(0)||1463899717!==s.getUint32(8))return n(new Error("Unrecognized audio format"));for(var i={},r=12,l=s.byteLength-8;r<l;)i[String.fromCharCode(s.getUint8(r),s.getUint8(r+1),s.getUint8(r+2),s.getUint8(r+3))]=r,r+=8+s.getUint32(r+4,!0);var h=s.getUint16(20,!0),c=(s.getUint16(22,!0),s.getUint32(24,!0));if(s.getUint32(28,!0),s.getUint16(32,!0),s.getUint16(34,!0),17===h){var d,u,p,m,f=(s.getUint16(38,!0)-1)/2+4,g=s.getUint32(i.fact+8,!0),b=e.context.createBuffer(1,g,c),w=b.getChannelData(0),S=0,E=-1,y=i.data+8;r=y;for(var v=0;;)if((r-y)%f==0&&E<0){if(r>=s.byteLength)break;d=s.getInt16(r,!0),r+=2,S=s.getUint8(r),r+=1,r++,S>88&&(S=88),w[v++]=d/32767}else{if(E<0){if(r>=s.byteLength)break;E=s.getUint8(r),r+=1,p=15&E}else p=E>>4&15,E=-1;u=o[S],m=0,4&p&&(m+=u),2&p&&(m+=u>>1),1&p&&(m+=u>>2),m+=u>>3,(S+=a[p])>88&&(S=88),S<0&&(S=0),(d+=8&p?-m:m)>32767&&(d=32767),d<-32768&&(d=-32768),w[v++]=d/32768}return n(null,b)}n(new Error("Unrecognized WAV format "+h))}(t,(function(i,r){r?n(r):e.context.decodeAudioData(t,(function(t){n(t)}),(function(t){s(`Could not decode audio: ${i} | ${t}`)}))}))})):Promise.reject(new Error("No audio context"))}}(t.audio||(t.audio={}))}(P||(P={})),function(t){!function(e){class n{constructor(){this.x=0,this.y=0,this.z=255,this.a=1,this.mode=0,this.css="rgba(0, 0, 255, 1)"}setRGBA(t){this.x=t>>16&255,this.y=t>>8&255,this.z=255&t,this.a=(t>>24&255)/255||1,this.css="rgba("+this.x+", "+this.y+", "+this.z+", "+this.a+")",this.mode=0}setShiftedRGBA(t){this.setRGBA(t),this.toHSVA()}toHSLA(){switch(this.mode){case 0:{this.mode=1;const e=t.utils.rgbToHSL(this.x,this.y,this.z);this.x=e[0],this.y=100*e[1],this.z=100*e[2];break}case 2:{this.mode=1;const e=t.utils.hsvToHSL(this.x,this.y/100,this.z/100);this.x=e[0],this.y=100*e[1],this.z=100*e[2];break}}}toHSVA(){switch(this.mode){case 0:{this.mode=2;const e=t.utils.rgbToHSV(this.x,this.y,this.z);this.x=e[0],this.y=100*e[1],this.z=100*e[2];break}case 1:{this.mode=2;const e=t.utils.hslToHSV(this.x,this.y/100,this.z/100);this.x=e[0],this.y=100*e[1],this.z=100*e[2];break}}}toParts(){switch(this.mode){case 0:return[this.x,this.y,this.z,this.a];case 2:{const e=t.utils.hsvToRGB(this.x/360,this.y/100,this.z/100);return[e[0],e[1],e[2],this.a]}case 1:{const e=t.utils.hslToRGB(this.x/360,this.y/100,this.z/100);return[e[0],e[1],e[2],this.a]}}}toCSS(){switch(this.mode){case 0:return this.css;case 1:return"hsla("+this.x+","+this.y+"%,"+(this.z>100?200-this.z:this.z)+"%,"+this.a+")";case 2:{const e=t.utils.hsvToRGB(this.x/360,this.y/100,this.z/100);return"rgba("+e[0]+", "+e[1]+", "+e[2]+", "+this.a+")"}}}setParam(e,n){switch(this.toHSVA(),e){case"color":this.x=360*n/100%360,this.x<0&&(this.x+=360);break;case"saturation":this.y=t.utils.clamp(n,0,100);break;case"brightness":this.z=t.utils.clamp(n,0,100);break;case"transparency":this.a=1-n/100,this.a>1&&(this.a=1),this.a<0&&(this.a=0)}}changeParam(e,n){switch(this.toHSVA(),e){case"color":this.x=(this.x+360*n/100)%360,this.x<0&&(this.x+=360);break;case"saturation":this.y=t.utils.clamp(this.y+n,0,100);break;case"brightness":this.z=t.utils.clamp(this.z+n,0,100);break;case"transparency":this.a=Math.max(0,Math.min(1,this.a-n/100))}}copy(t){this.x=t.x,this.y=t.y,this.z=t.z,this.a=t.a,this.css=t.css,this.mode=t.mode}}e.PenColor=n;class s{constructor(){this.isStage=!1,this.isSprite=!1,this.isClone=!1,this.visible=!0,this.scratchX=0,this.scratchY=0,this.name="",this.costumes=[],this.currentCostumeIndex=0,this.sounds=[],this.soundRefs={},this.instrument=0,this.volume=1,this.node=null,this.activeSounds=new Set,this.watchers={},this.listWatchers={},this.vars={},this.lists={},this.saying=!1,this.thinking=!1,this.sayId=0,this.procedures={},this.listeners={whenClicked:[],whenCloned:[],whenGreenFlag:[],whenIReceive:{},whenKeyPressed:{},whenSceneStarts:{},edgeActivated:[]},this.fns=[],this.filters={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,brightness:0,ghost:0},this.soundFilters={pitch:0},this.penSize=1,this.penColor=new n,this.isPenDown=!1}addSound(t){this.soundRefs[t.name]=t,this.sounds.push(t)}showVariable(t,e){let n=this.watchers[t];if(!n){const e=this.createVariableWatcher(this,t);if(!e)return;e.init(),this.watchers[t]=n=e,this.stage.allWatchers.push(n)}n.setVisible(e)}showList(t,e){let n=this.listWatchers[t];if(!n){const e=this.createListWatcher(this,t);if(!e)return;e.init(),this.listWatchers[t]=n=e,this.stage.allWatchers.push(n)}n.setVisible(e)}showNextCostume(){this.currentCostumeIndex=(this.currentCostumeIndex+1)%this.costumes.length,this.saying&&o(this)&&this.updateBubble()}showPreviousCostume(){var t=this.costumes.length;this.currentCostumeIndex=(this.currentCostumeIndex+t-1)%t,this.saying&&o(this)&&this.updateBubble()}getCostumeName(){return this.costumes[this.currentCostumeIndex]?this.costumes[this.currentCostumeIndex].name:""}setCostume(t){if("number"!=typeof t){t=""+t;for(var e=0;e<this.costumes.length;e++)if(this.costumes[e].name===t)return this.currentCostumeIndex=e,void(this.saying&&o(this)&&this.updateBubble());if(t===(this.isSprite?"next costume":"next backdrop"))return void this.showNextCostume();if(t===(this.isSprite?"previous costume":"previous backdrop"))return void this.showPreviousCostume();if(!isFinite(t)||!/\d/.test(t))return}(Number.isNaN(t)||t===1/0||t===-1/0)&&(t=1),(e=(Math.floor(t)-1)%this.costumes.length)<0&&(e+=this.costumes.length),this.currentCostumeIndex=e,o(this)&&this.saying&&this.updateBubble()}setFilter(t,e){switch(t){case"ghost":e<0&&(e=0),e>100&&(e=100);break;case"brightness":e<-100&&(e=-100),e>100&&(e=100);break;case"color":if(e===1/0)break;(e%=200)<0&&(e+=200)}this.filters[t]=e}changeFilter(t,e){this.setFilter(t,this.filters[t]+e)}resetFilters(){this.filters={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,brightness:0,ghost:0},this.soundFilters={pitch:0}}setSoundFilter(t,e){if(e=e||0,"pitch"===t.toLowerCase())this.soundFilters.pitch=e,this.stage.removeLimits||(this.soundFilters.pitch>360&&(this.soundFilters.pitch=360),this.soundFilters.pitch<-360&&(this.soundFilters.pitch=-360))}changeSoundFilter(t,e){if("pitch"===t.toLowerCase())this.soundFilters.pitch+=e,this.stage.removeLimits||(this.soundFilters.pitch>360&&(this.soundFilters.pitch=360),this.soundFilters.pitch<-360&&(this.soundFilters.pitch=-360))}resetSoundFilters(){this.soundFilters={pitch:0}}getSound(t){if("string"==typeof t){var e=this.soundRefs[t];if(e)return e;t=parseInt(t,10)}var n=this.sounds.length;if(n&&"number"==typeof t&&t==t){var s=Math.round(t-1)%n;return s<0&&(s+=n),this.sounds[s]}}stopSounds(){if(this.node){for(const t of this.activeSounds)t.stopped=!0,t.node&&t.node.disconnect();this.activeSounds.clear(),this.node.disconnect(),this.node=null}}stopSoundsExcept(t){if(this.node)for(const e of this.activeSounds)e.base!==t&&(e.node&&e.node.disconnect(),e.stopped=!0,this.activeSounds.delete(e))}ask(t){var e=this.stage;t?this.visible&&o(this)?(this.say(t),e.promptTitle.style.display="none"):(e.promptTitle.style.display="block",e.promptTitle.textContent=t):e.promptTitle.style.display="none",e.hidePrompt=!1,e.prompter.style.display="block",e.prompt.value="",e.prompt.focus()}say(e,n=!1){return 0===(e=""+e).length?(this.saying=!1,this.bubbleContainer&&(this.bubbleContainer.style.display="none"),++this.sayId):(this.saying=!0,this.thinking=n,this.bubbleContainer||(this.bubbleContainer=document.createElement("div"),this.bubbleContainer.style.maxWidth=127/14+"em",this.bubbleContainer.style.minWidth=48/14+"em",this.bubbleContainer.style.padding=8/14+"em "+10/14+"em",this.bubbleContainer.style.border=3/14+"em solid rgb(160, 160, 160)",this.bubbleContainer.style.borderRadius=10/14+"em",this.bubbleContainer.style.background="#fff",this.bubbleContainer.style.position="absolute",this.bubbleContainer.style.font="bold 1.4em sans-serif",this.bubbleContainer.style.whiteSpace="pre-wrap",this.bubbleContainer.style.wordWrap="break-word",this.bubbleContainer.style.textAlign="center",this.bubbleContainer.style.cursor="default",this.bubbleContainer.style.pointerEvents="auto",this.bubbleContainer.appendChild(this.bubbleText=document.createTextNode("")),this.bubbleContainer.appendChild(this.bubblePointer=document.createElement("div")),this.bubblePointer.style.position="absolute",this.bubblePointer.style.height="1.5em",this.bubblePointer.style.width=44/14+"em",this.bubblePointer.style.background=`url("${t.io.config.localPath}icons.svg")`,this.bubblePointer.style.backgroundSize=384/14+"em "+64/14+"em",this.bubblePointer.style.backgroundPositionY=-4/14+"em",this.stage.ui.appendChild(this.bubbleContainer)),this.bubblePointer.style.backgroundPositionX=(n?-323:-259)/14+"em",this.bubbleContainer.style.display="block",this.bubbleText.nodeValue=e,this.updateBubble(),++this.sayId)}updateBubble(){if(!this.visible||!this.saying)return void(this.bubbleContainer.style.display="none");this.bubbleContainer.style.display="block";const t=this.rotatedBounds(),e=240+t.right;var n=180+t.top;const s=this.bubbleContainer.getBoundingClientRect(),i=(s.bottom-s.top)/this.stage.zoom,r=(s.right-s.left)/this.stage.zoom;if(this.bubblePointer.style.top=(i-6)/14+"em",e+r+2>480){var o=(240-t.left)/14;o>25&&(o=25),this.bubbleContainer.style.right=o+"em",this.bubbleContainer.style.left="auto",this.bubblePointer.style.right=3/14+"em",this.bubblePointer.style.left="auto",this.bubblePointer.style.backgroundPositionY=-36/14+"em"}else this.bubbleContainer.style.left=e/14+"em",this.bubbleContainer.style.right="auto",this.bubblePointer.style.left=3/14+"em",this.bubblePointer.style.right="auto",this.bubblePointer.style.backgroundPositionY=-4/14+"em";n+i+2>360&&(n=360-i-2),n<19&&(n=19),this.bubbleContainer.style.bottom=n/14+"em"}remove(){if(this.bubbleContainer&&this.stage.ui.removeChild(this.bubbleContainer),this.node&&this.isClone&&!this.isStage){for(const t of this.activeSounds)t.node&&t.node.disconnect(),t.stopped=!0;this.activeSounds.clear(),this.node.disconnect(),this.node.connect(this.stage.getAudioNode()),this.node=null}}getAudioNode(){if(this.node)return this.node;if(!t.audio.context)throw new Error("No audio context");return this.node=t.audio.context.createGain(),this.node.gain.value=this.volume,t.audio.connectNode(this.node),this.node}createVariableWatcher(t,e){return null}createListWatcher(t,e){return null}dotPen(){this.stage.renderer.penDot(this.penColor,this.penSize,this.scratchX,this.scratchY)}stamp(){this.stage.renderer.penStamp(this)}addWhenKeyPressedHandler(t,e){this.listeners.whenKeyPressed[t]?this.listeners.whenKeyPressed[t].push(e):this.listeners.whenKeyPressed[t]=[e]}}e.Base=s;e.Stage=class extends s{constructor(){super(),this.stage=this,this.isStage=!0,this.children=[],this.allWatchers=[],this.answer="",this.promptId=0,this.nextPromptId=0,this.hidePrompt=!1,this.zoom=1,this.rawMouseX=0,this.rawMouseY=0,this.mouseX=0,this.mouseY=0,this.mousePressed=!1,this.tempoBPM=60,this.username="",this.counter=0,this.cloudHandler=null,this.cloudVariables=[],this.microphone=null,this.tts=null,this.extensions=[],this.useSpriteFencing=!1,this.removeLimits=!1,this.runtime=new t.runtime.Runtime(this),this.keys=[],this.keys.any=0,this.root=document.createElement("div"),this.root.classList.add("forkphorus-root"),t.config.useWebGL?this.renderer=new t.renderer.webgl.WebGLProjectRenderer(this):this.renderer=new t.renderer.canvas2d.ProjectRenderer2D(this),this.renderer.resize(1),this.renderer.init(this.root),this.canvas=this.renderer.canvas,this.ui=document.createElement("div"),this.root.appendChild(this.ui),this.ui.style.pointerEvents="none",this.canvas.tabIndex=0,this.canvas.style.outline="none",this.prompter=document.createElement("div"),this.ui.appendChild(this.prompter),this.prompter.style.zIndex="1",this.prompter.style.pointerEvents="auto",this.prompter.style.position="absolute",this.prompter.style.left=this.prompter.style.right="1.4em",this.prompter.style.bottom=".6em",this.prompter.style.padding=".5em 3.0em .5em .5em",this.prompter.style.border=".3em solid rgb(46, 174, 223)",this.prompter.style.borderRadius=".8em",this.prompter.style.background="#fff",this.prompter.style.display="none",this.promptTitle=document.createElement("div"),this.prompter.appendChild(this.promptTitle),this.promptTitle.textContent="",this.promptTitle.style.cursor="default",this.promptTitle.style.font="bold 1.3em sans-serif",this.promptTitle.style.margin="0 "+-25/13+"em "+5/13+"em 0",this.promptTitle.style.whiteSpace="pre",this.promptTitle.style.overflow="hidden",this.promptTitle.style.textOverflow="ellipsis",this.prompt=document.createElement("input"),this.prompter.appendChild(this.prompt),this.prompt.style.border="0",this.prompt.style.background="#eee",this.prompt.style.boxSizing="border-box",this.prompt.style.font="1.3em sans-serif",this.prompt.style.padding="0 "+3/13+"em",this.prompt.style.outline="0",this.prompt.style.margin="0",this.prompt.style.width="100%",this.prompt.style.height=20/13+"em",this.prompt.style.display="block",this.prompt.style.borderRadius="0",this.prompt.style.boxShadow="inset "+1/13+"em "+1/13+"em "+2/13+"em rgba(0, 0, 0, .2), inset "+-1/13+"em "+-1/13+"em "+1/13+"em rgba(255, 255, 255, .2)",this.prompt.style.webkitAppearance="none",this.promptButton=document.createElement("div"),this.prompter.appendChild(this.promptButton),this.promptButton.style.width="2.2em",this.promptButton.style.height="2.2em",this.promptButton.style.position="absolute",this.promptButton.style.right=".4em",this.promptButton.style.bottom=".4em",this.promptButton.style.background=`url("${t.io.config.localPath}icons.svg") -22.8em -0.4em`,this.promptButton.style.backgroundSize="38.4em 6.4em",this.addEventListeners()}addEventListeners(){this._onmousedown=this._onmousedown.bind(this),this._onmouseup=this._onmouseup.bind(this),this._onmousemove=this._onmousemove.bind(this),this._ontouchstart=this._ontouchstart.bind(this),this._ontouchend=this._ontouchend.bind(this),this._ontouchmove=this._ontouchmove.bind(this),document.addEventListener("mousedown",this._onmousedown),document.addEventListener("mouseup",this._onmouseup),document.addEventListener("mousemove",this._onmousemove),document.addEventListener("touchstart",this._ontouchstart,{passive:!1}),document.addEventListener("touchend",this._ontouchend),document.addEventListener("touchmove",this._ontouchmove),this.root.addEventListener("wheel",this._onwheel.bind(this)),this.root.addEventListener("keyup",this._onkeyup.bind(this)),this.root.addEventListener("keydown",this._onkeydown.bind(this)),this.promptButton.addEventListener("touchstart",this.submitPrompt.bind(this)),this.promptButton.addEventListener("mousedown",this.submitPrompt.bind(this)),this.prompt.addEventListener("keydown",(t=>{13===t.keyCode&&this.submitPrompt()}))}removeEventListeners(){document.removeEventListener("mousedown",this._onmousedown),document.removeEventListener("mouseup",this._onmouseup),document.removeEventListener("mousemove",this._onmousemove),document.removeEventListener("touchstart",this._ontouchstart),document.removeEventListener("touchend",this._ontouchend),document.removeEventListener("touchmove",this._ontouchmove)}_onwheel(t){t.deltaY>0?this.runtime.trigger("whenKeyPressed","down arrow"):t.deltaY<0&&this.runtime.trigger("whenKeyPressed","up arrow")}keyEventToCode(t){const e=t.key||"";switch(e){case" ":return"space";case"Enter":return"enter";case"ArrowLeft":case"Left":return"left arrow";case"ArrowUp":case"Up":return"up arrow";case"ArrowRight":case"Right":return"right arrow";case"ArrowDown":case"Down":return"down arrow";case"Escape":return"esc";case"Tab":return"tab";case"Backspace":return"backspace";case"Delete":return"delete";case"Shift":return"_shift";case"Control":return"control";case"Insert":return"insert";case"Home":return"home";case"End":return"end";case"PageUp":return"page up";case"PageDown":return"page down"}return 1!==e.length?null:""+e.toLowerCase().charCodeAt(0)}_onkeyup(t){const e=this.keyEventToCode(t);null!==e&&(this.keys[e]&&this.keys.any--,this.keys[e]=!1,t.stopPropagation(),t.target===this.canvas&&t.preventDefault())}_onkeydown(t){const e=this.keyEventToCode(t);null!==e&&("tab"!=e||t.shiftKey)&&(this.keys[e]||this.keys.any++,this.keys[e]=!0,t.ctrlKey||t.altKey||t.metaKey||"esc"===e||(t.stopPropagation(),t.target===this.canvas&&(t.preventDefault(),this.runtime.trigger("whenKeyPressed",e))))}_onmousedown(t){this.runtime.isRunning&&(this.updateMousePosition(t),this.mousePressed=!0,t.target===this.canvas&&(this.clickMouse(),t.preventDefault(),this.canvas.focus()),this.onmousedown(t))}_onmouseup(t){this.runtime.isRunning&&(this.updateMousePosition(t),this.releaseMouse(),this.onmouseup(t))}_onmousemove(t){this.runtime.isRunning&&(this.updateMousePosition(t),this.onmousemove(t))}_ontouchend(t){if(this.runtime.isRunning){this.releaseMouse();for(var e=0;e<t.changedTouches.length;e++){const n=t.changedTouches[e];this.ontouch(t,n)}}}_ontouchstart(t){if(this.runtime.isRunning){this.mousePressed=!0;for(var e=0;e<t.changedTouches.length;e++){const n=t.changedTouches[e];this.updateMousePosition(n),t.target===this.canvas&&this.clickMouse(),this.ontouch(t,n)}t.target===this.canvas&&t.preventDefault()}}_ontouchmove(t){if(this.runtime.isRunning){this.updateMousePosition(t.changedTouches[0]);for(var e=0;e<t.changedTouches.length;e++){const n=t.changedTouches[e];this.ontouch(t,n)}}}ontouch(t,e){}onmousedown(t){}onmouseup(t){}onmousemove(t){}destroy(){this.runtime.stopAll(),this.runtime.pause(),this.stopAllSounds();for(const t of this.extensions)t.destroy();this.renderer.destroy(),this.removeEventListeners()}pauseExtensions(){for(const t of this.extensions)t.onpause()}startExtensions(){for(const t of this.extensions)t.onstart()}updateExtensions(){if(this.extensions.length)for(const t of this.extensions)t.update()}focus(){this.promptId<this.nextPromptId?this.prompt.focus():this.canvas.focus()}updateMousePosition(t){var e=this.canvas.getBoundingClientRect(),n=(t.clientX-e.left)/this.zoom-240,s=180-(t.clientY-e.top)/this.zoom;this.rawMouseX=n,this.rawMouseY=s,n<-240&&(n=-240),n>240&&(n=240),s<-180&&(s=-180),s>180&&(s=180),this.mouseX=Math.round(n),this.mouseY=Math.round(s)}setZoom(e){if(this.zoom!==e){this.renderer.resize(e),this.root.style.width=(480*e|0)+"px",this.root.style.height=(360*e|0)+"px",this.root.style.fontSize=10*e+"px",this.zoom=e;for(const e of this.allWatchers)e instanceof t.sb3.Scratch3ListWatcher&&e.updateList()}}clickMouse(){this.mouseSprite=void 0;for(var t=this.children.length;t--;){var e=this.children[t];if(e.visible&&e.filters.ghost<100&&e.touching("_mouse_"))return void(e.isDraggable?(this.mouseSprite=e,e.mouseDown()):this.runtime.triggerFor(e,"whenClicked"))}this.runtime.triggerFor(this,"whenClicked")}releaseMouse(){this.mousePressed=!1,this.mouseSprite&&(this.mouseSprite.mouseUp(),this.mouseSprite=void 0)}setFilter(t,e){super.setFilter(t,e),this.renderer.onStageFiltersChanged()}resetFilters(){super.resetFilters(),this.renderer.onStageFiltersChanged()}getObject(t){for(var e=0;e<this.children.length;e++){var n=this.children[e];if(n.name===t&&!n.isClone)return n}return"_stage_"===t||t===this.name?this:null}getObjects(t){const e=[];for(var n=0;n<this.children.length;n++)this.children[n].name===t&&e.push(this.children[n]);return e}getPosition(t){switch(t){case"_mouse_":return{x:this.mouseX,y:this.mouseY};case"_random_":return{x:Math.round(480*Math.random()-240),y:Math.round(360*Math.random()-180)}}const e=this.getObject(t);return e?{x:e.scratchX,y:e.scratchY}:null}draw(){this.renderer.drawFrame();for(var t=this.allWatchers.length;t--;){var e=this.allWatchers[t];e.visible&&e.update()}this.hidePrompt&&(this.hidePrompt=!1,this.prompter.style.display="none",this.canvas.focus())}showVideo(e){t.config.supportVideoSensing&&(e?(this.videoElement||(this.videoElement=document.createElement("video"),this.videoElement.onloadedmetadata=()=>{this.videoElement.play()},this.videoElement.style.opacity="0.5",this.root.insertBefore(this.videoElement,this.canvas),navigator.mediaDevices.getUserMedia({video:!0,audio:!1}).then((t=>this.videoElement.srcObject=t))),this.videoElement.style.display="block"):this.videoElement&&(this.videoElement.style.display="none"))}addExtension(t){this.extensions.push(t)}initMicrophone(){this.microphone||(this.microphone=new t.ext.microphone.MicrophoneExtension(this),this.addExtension(this.microphone))}initTextToSpeech(){this.tts||(this.tts=new t.ext.tts.TextToSpeechExtension(this),this.addExtension(this.tts))}setCloudHandler(t){this.cloudHandler=t,this.addExtension(t)}stopAllSounds(){for(var t=this.children,e=t.length;e--;)t[e].stopSounds();this.stopSounds()}removeAllClones(){for(var t=this.children.length;t--;)this.children[t].isClone&&(this.children[t].remove(),this.children.splice(t,1))}moveTo(){}gotoObject(){}forward(){}setDirection(t){}rotatedBounds(){return{top:0,bottom:0,left:0,right:0}}touching(t){return"_mouse_"==t}touchingColor(t){return!1}colorTouchingColor(t,e){return!1}submitPrompt(){this.promptId<this.nextPromptId&&(this.answer=this.prompt.value,this.promptId+=1,this.promptId>=this.nextPromptId&&(this.hidePrompt=!0))}clearPen(){this.renderer.penClear()}};e.Sprite=class extends s{constructor(t){super(),this.isSprite=!0,this.isClone=!1,this.direction=90,this.rotationStyle=0,this.isDraggable=!1,this.isDragging=!1,this.scale=1,this.dragStartX=0,this.dragStartY=0,this.dragOffsetX=0,this.dragOffsetY=0,this.stage=t}mouseDown(){this.dragStartX=this.scratchX,this.dragStartY=this.scratchY,this.dragOffsetX=this.scratchX-this.stage.mouseX,this.dragOffsetY=this.scratchY-this.stage.mouseY,this.isDragging=!0}mouseUp(){this.isDragging&&this.scratchX===this.dragStartX&&this.scratchY===this.dragStartY&&this.stage.runtime.triggerFor(this,"whenClicked"),this.isDragging=!1}rotatedBounds(){const t=this.costumes[this.currentCostumeIndex],e=t.scale*this.scale;var n=-t.rotationCenterX*e,s=t.rotationCenterY*e,i=n+t.width*e,r=s-t.height*e;if(0!==this.rotationStyle)return 1===this.rotationStyle&&this.direction<0&&(n=(i=-n)-t.width*t.scale*this.scale),{left:this.scratchX+n,right:this.scratchX+i,top:this.scratchY+s,bottom:this.scratchY+r};const o=Math.sin(this.direction*Math.PI/180),a=Math.cos(this.direction*Math.PI/180),l=o*n-a*s,h=a*n+o*s,c=o*i-a*s,d=a*i+o*s,u=o*n-a*r,p=a*n+o*r,m=o*i-a*r,f=a*i+o*r;return{left:this.scratchX+Math.min(l,c,u,m),right:this.scratchX+Math.max(l,c,u,m),top:this.scratchY+Math.max(h,d,p,f),bottom:this.scratchY+Math.min(h,d,p,f)}}showRotatedBounds(){var t=this.rotatedBounds(),e=document.createElement("div");e.style.outline="1px solid red",e.style.position="absolute",e.style.left=240+t.left+"px",e.style.top=180-t.top+"px",e.style.width=t.right-t.left+"px",e.style.height=t.top-t.bottom+"px",this.stage.canvas.parentNode.appendChild(e)}createVariableWatcher(t,e){return this.stage.createVariableWatcher(t,e)}forward(t){const e=(90-this.direction)*Math.PI/180;this.moveTo(this.scratchX+t*Math.cos(e),this.scratchY+t*Math.sin(e))}keepInView(){const t=this.rotatedBounds(),e=t.right-t.left,n=t.top-t.bottom,s=Math.min(15,Math.floor(Math.min(e,n)/2));t.right-s<-240&&(this.scratchX-=t.right-s+240),t.left+s>240&&(this.scratchX-=t.left+s-240),t.bottom+s>180&&(this.scratchY-=t.bottom+s-180),t.top-s<-180&&(this.scratchY-=t.top-s+180)}moveTo(t,e){var n=this.scratchX,s=this.scratchY;(n!==t||s!==e||this.isPenDown)&&(this.scratchX=t,this.scratchY=e,this.stage.useSpriteFencing&&this.keepInView(),this.isPenDown&&!this.isDragging&&this.stage.renderer.penLine(this.penColor,this.penSize,n,s,t,e),this.saying&&this.updateBubble())}setDirection(t){if(isFinite(t)){var e=t%360;e>180&&(e-=360),e<=-180&&(e+=360),this.direction=e,this.saying&&this.updateBubble()}}clone(){const t=this._clone();t.isClone=!0;for(const e of Object.keys(this.vars))t.vars[e]=this.vars[e];for(const e of Object.keys(this.lists))t.lists[e]=this.lists[e].slice(0);return t.filters={color:this.filters.color,fisheye:this.filters.fisheye,whirl:this.filters.whirl,pixelate:this.filters.pixelate,mosaic:this.filters.mosaic,brightness:this.filters.brightness,ghost:this.filters.ghost},t.procedures=this.procedures,t.listeners=this.listeners,t.fns=this.fns,t.name=this.name,t.costumes=this.costumes,t.currentCostumeIndex=this.currentCostumeIndex,t.sounds=this.sounds,t.soundRefs=this.soundRefs,t.direction=this.direction,t.instrument=this.instrument,t.isDraggable=this.isDraggable,t.rotationStyle=this.rotationStyle,t.scale=this.scale,t.volume=this.volume,t.scratchX=this.scratchX,t.scratchY=this.scratchY,t.visible=this.visible,t.penSize=this.penSize,t.penColor.copy(this.penColor),t.isPenDown=this.isPenDown,t.watchers=this.watchers,t.listWatchers=this.listWatchers,t}touching(t){if("_mouse_"===t){const t=this.stage.rawMouseX,e=this.stage.rawMouseY;return this.stage.renderer.spriteTouchesPoint(this,t,e)}if("_edge_"===t){const t=this.rotatedBounds();return t.left<=-240||t.right>=240||t.top>=180||t.bottom<=-180}{if(!this.visible)return!1;const e=this.stage.getObjects(t);return this.stage.renderer.spritesIntersect(this,e)}}touchingColor(t){return this.stage.renderer.spriteTouchesColor(this,t)}colorTouchingColor(t,e){return this.stage.renderer.spriteColorTouchesColor(this,t,e)}bounceOffEdge(){var t=this.rotatedBounds(),e=240+t.left,n=180-t.top,s=240-t.right,i=180+t.bottom,r=Math.min(e,n,s,i);if(!(r>0)){var o=this.direction*Math.PI/180,a=Math.sin(o),l=-Math.cos(o);switch(r){case e:a=Math.max(.2,Math.abs(a));break;case n:l=Math.max(.2,Math.abs(l));break;case s:a=-Math.max(.2,Math.abs(a));break;case i:l=-Math.max(.2,Math.abs(l))}this.direction=180*Math.atan2(l,a)/Math.PI+90,this.saying&&this.updateBubble()}}distanceTo(t){const e=this.stage.getPosition(t);if(!e)return 1e4;const n=e.x,s=e.y;return Math.sqrt((this.scratchX-n)*(this.scratchX-n)+(this.scratchY-s)*(this.scratchY-s))}gotoObject(t){const e=this.stage.getPosition(t);if(!e)return 0;this.moveTo(e.x,e.y)}pointTowards(t){const e=this.stage.getPosition(t);if(!e)return 0;const n=e.x-this.scratchX,s=e.y-this.scratchY,i=0===n&&0===s?90:180*Math.atan2(n,s)/Math.PI;isFinite(i)&&(this.direction=i,this.saying&&this.updateBubble())}};class i{constructor(t){this.name=t.name,this.scale=1/t.bitmapResolution,this.rotationCenterX=t.rotationCenterX,this.rotationCenterY=t.rotationCenterY}}e.Costume=i;e.BitmapCostume=class extends i{constructor(t,e){if(super(e),"CANVAS"===t.tagName){const e=t.getContext("2d");if(!e)throw new Error(`Cannot get 2d rendering context of costume image, despite it already being a canvas "${this.name}"`);this.ctx=e}this.image=t,this.width=t.width,this.height=t.height,this.isScalable=!1}getContext(){if(this.ctx)return this.ctx;const t=document.createElement("canvas"),e=t.getContext("2d");if(!e)throw new Error(`cannot get 2d rendering context in getContext on Bitmap "${this.name}"`);return t.width=this.width,t.height=this.height,e.drawImage(this.image,0,0),this.ctx=e,e}getImage(){return this.image}requestSize(t){throw new Error(`requestSize is not implemented on BitmapCostume "${this.name}" isScalable=${this.isScalable}`)}};class r extends i{constructor(t,e){super(e),(t.height<1||t.width<1)&&(t=new Image(1,1)),this.isScalable=!0,this.width=t.width,this.height=t.height,this.svg=t,this.maxScale=this.calculateMaxScale(),this.currentScale=Math.min(1,this.maxScale)}calculateMaxScale(){return r.MAX_SIZE/this.width<r.MAX_SCALE?r.MAX_SIZE/this.width:r.MAX_SIZE/this.height<r.MAX_SCALE?r.MAX_SIZE/this.height:r.MAX_SCALE}render(){const t=Math.floor(Math.max(1,this.width*this.currentScale)),e=Math.floor(Math.max(1,this.height*this.currentScale));if(this.canvas)this.canvas.width=t,this.canvas.height=e;else{const n=document.createElement("canvas");n.width=t,n.height=e;const s=n.getContext("2d");if(!s){const n=t=>Math.round(100*t)/100;throw new Error(`cannot get 2d rendering context in initCanvas on Vector "${this.name}" @ ${n(this.currentScale)}/${n(this.maxScale)} | ${t}x${e}`)}this.canvas=n,this.ctx=s}this.ctx.drawImage(this.svg,0,0,t,e)}requestSize(t){if(r.DISABLE_RASTERIZE)return;const e=Math.min(Math.ceil(t),this.maxScale);this.currentScale<e&&(this.currentScale=e,this.render())}getContext(){return this.ctx||this.render(),this.ctx}getImage(){return r.DISABLE_RASTERIZE?this.svg:(this.canvas||this.render(),this.canvas)}}r.MAX_SCALE=16,r.MAX_SIZE=2048,r.DISABLE_RASTERIZE=!1,e.VectorCostume=r,/^((?!chrome|android).)*safari/i.test(navigator.userAgent)&&(console.log("Vector rasterization is disabled. This may affect performance."),r.DISABLE_RASTERIZE=!0);e.Sound=class{constructor(t){if(this.source=null,!t.buffer)throw new Error("no AudioBuffer");this.name=t.name,this.buffer=t.buffer,this.duration=this.buffer.duration}createSourceNode(){this.source&&this.source.disconnect();const e=t.audio.context.createBufferSource();return this.source=e,this.source.buffer=this.buffer,this.source.addEventListener("ended",(()=>{e.ended=!0})),this.source.start(),this.source}};e.Watcher=class{constructor(t,e){this.valid=!0,this.visible=!0,this.x=0,this.y=0,this.stage=t,this.targetName=e}init(){this.target=this.stage.getObject(this.targetName)||this.stage}setVisible(t){this.visible=t}};function o(t){return t.isSprite}e.Procedure=class{constructor(t,e,n){this.fn=t,this.warp=e,this.inputs=n}},e.isSprite=o}(t.core||(t.core={}))}(P||(P={})),function(t){!function(e){const n={};function s(t,e){return`@font-face { font-family: "${t}"; src: url("${e}"); }`}e.scratch3={Marker:"fonts/Knewave-Regular.woff",Handwriting:"fonts/Handlee-Regular.woff",Pixel:"fonts/Grand9K-Pixel.ttf",Curly:"fonts/Griffy-Regular.woff",Serif:"fonts/SourceSerifPro-Regular.woff","Sans Serif":"fonts/NotoSans-Regular.woff"},e.loadLocalFont=function(e,s){return n[e]?Promise.resolve(n[e]):t.io.getAssetManager().loadFont(s).then((e=>t.io.readers.toDataURL(e))).then((t=>(n[e]=t,t)))},e.addFontRules=function(t,e){const i=[];for(const t of e){const e=(r=t)in n?n[r]:null;e?i.push(s(t,e)):console.warn("unknown font from cache",t)}var r;const o=t.ownerDocument,a=o.createElementNS("http://www.w3.org/2000/svg","defs"),l=o.createElementNS("http://www.w3.org/2000/svg","style");l.innerHTML=i.join("\n"),a.appendChild(l),t.appendChild(l)},e.loadWebFont=function(t){return new FontFaceObserver(t).load()}}(t.fonts||(t.fonts={}))}(P||(P={})),function(t){!function(t){const e=["en","es"];const n={},s={},i=function(){let t=navigator.language;return t.indexOf("-")>-1&&(t=t.substring(0,t.indexOf("-"))),-1===e.indexOf(t)&&(t="en"),t}();function r(t){return n[t]?n[t]:s[t]?s[t]:(console.warn("Missing translation:",t),"## "+t+" ##")}function o(t,e){for(const n of Object.keys(e))t[n]=e[n]}function a(t,e){t===i?o(n,e):"en"===t&&o(s,e)}t.translate=r,t.translateElement=function(t){const e=t.querySelectorAll("[data-i18n]");for(var n=0;n<e.length;n++){const t=e[n],s=t.getAttribute("data-i18n");if(null===s)continue;const i=r(s);t.textContent=i}},t.addTranslations=a,a("en",{"player.controls.turboIndicator":"Turbo Mode","player.controls.fullscreen.title":"Click to fullscreen player, Shift+click to just maximize.","player.controls.flag.title":"Shift+click to enable turbo mode.","player.controls.flag.title.enabled":"Turbo mode is enabled. Shift+click to disable turbo mode.","player.controls.flag.title.disabled":"Turbo mode is disabled. Shift+click to enable turbo mode.","player.errorhandler.error":"An internal error occurred. <a $attrs>Click here</a> to file a bug report.","player.errorhandler.error.doesnotexist":"There is no project with ID $id. It was probably deleted, never existed, or you made a typo.","player.errorhandler.error.doesnotexistlegacy":"The project with ID $id can not be used with legacy mode enabled. Turn off legacy mode to use this project."})}(t.i18n||(t.i18n={}))}(P||(P={})),function(t){!function(e){let n;e.config={localPath:""},-1===["http:","https:"].indexOf(location.protocol)&&(e.config.localPath="https://forkphorus.github.io/"),function(t){t.toArrayBuffer=function(t){return new Promise(((e,n)=>{const s=new FileReader;s.onloadend=function(){e(s.result)},s.onerror=function(t){n(new Error("Could not read object as ArrayBuffer"))},s.readAsArrayBuffer(t)}))},t.toDataURL=function(t){return new Promise(((e,n)=>{const s=new FileReader;s.onloadend=function(){e(s.result)},s.onerror=function(t){n(new Error("Could not read object as data: URL"))},s.readAsDataURL(t)}))},t.toText=function(t){return new Promise(((e,n)=>{const s=new FileReader;s.onloadend=function(){e(s.result)},s.onerror=function(t){n(new Error("Could not read object as text"))},s.readAsText(t)}))}}(n=e.readers||(e.readers={}));var s=new class{constructor(){this.soundbankSource="soundbank/"}loadSoundbankFile(t){return this.loadArrayBuffer(this.soundbankSource+t)}loadFont(t){return this.loadBlob(t)}loadArrayBuffer(t){return new l(e.config.localPath+t).load("arraybuffer")}loadBlob(t){return new l(e.config.localPath+t).load("blob")}};e.getAssetManager=function(){return s},e.setAssetManager=function(t){s=t};const i=new class{constructor(){this.maxConcurrentTasks=20,this.concurrentTasks=0,this.queue=[]}startNextTask(){if(0===this.queue.length)return;if(this.concurrentTasks>=this.maxConcurrentTasks)return;const t=this.queue.shift();this.concurrentTasks++,t()}run(t){return new Promise(((e,n)=>{const s=()=>{t().then((t=>{this.concurrentTasks--,this.startNextTask(),e(t)})).catch((t=>{this.concurrentTasks--,this.startNextTask(),n(t)}))};this.concurrentTasks<this.maxConcurrentTasks?(this.concurrentTasks++,s()):this.queue.push(s)}))}};class r{setLoader(t){this.loader=t}updateLoaderProgress(){this.loader&&this.loader.updateProgress()}}e.AbstractTask=r;class o extends r{constructor(){super(...arguments),this.aborted=!1,this.retries=0,this.maxAttempts=4}async try(e){let n;for(let s=0;s<this.maxAttempts;s++){this.retries=s;try{return await e()}catch(e){if(this.aborted)throw e;n=e;const i=2**s*500*Math.random()+50;console.warn(`Attempt #${s+1} to ${this.getRetryWarningDescription()} failed, trying again in ${i}ms`,e),await t.utils.sleep(i)}}throw n}setMaxAttempts(t){return this.maxAttempts=t,this}getRetryWarningDescription(){return"complete task"}abort(){this.aborted=!0}}e.Retry=o;class a extends Error{constructor(t,e){super(t),this.status=e}}class l extends o{constructor(t){super(),this.shouldIgnoreErrors=!1,this.complete=!1,this.status=0,this.xhr=null,this.urls=Array.isArray(t)?t:[t]}isComplete(){return this.complete}abort(){super.abort(),this.xhr&&this.xhr.abort()}ignoreErrors(){return this.shouldIgnoreErrors=!0,this}getStatus(){return this.status}async _load(){if(this.aborted)return Promise.reject(new Error(`Cannot download ${this.urls[0]} -- aborted.`));const t=t=>new Promise(((e,n)=>{const s=new XMLHttpRequest;s.open("GET",t),s.responseType=this.responseType,this.xhr=s,s.onload=()=>{this.status=s.status,-1!==l.acceptableResponseCodes.indexOf(s.status)||this.shouldIgnoreErrors?e(s.response):n(new a(`HTTP Error ${s.status} while downloading ${this.urls[0]}`,s.status))},s.onloadend=t=>{this.xhr=null,this.complete=!0,this.updateLoaderProgress()},s.onerror=e=>{n(new Error(`Error while downloading ${t} (error) (r=${this.retries} s=${s.readyState}/${s.status}/${s.statusText})`))},s.onabort=e=>{this.aborted=!0,n(new Error(`Error while downloading ${t} (abort)`))},s.send()}));let e;for(const n of this.urls)try{return await t(n)}catch(t){(!e||t instanceof a&&!(e instanceof a))&&(e=t)}throw e}load(t){return this.responseType=t,i.run((()=>this.try((()=>this._load()))))}getRetryWarningDescription(){return`download ${this.urls[0]}`}}l.acceptableResponseCodes=[0,200],e.Request=l;e.Img=class extends o{constructor(t){super(),this.src=t,this.complete=!1}isComplete(){return this.complete}_load(){return this.aborted?Promise.reject(new Error(`Cannot download ${this.src} -- aborted.`)):new Promise(((t,e)=>{const n=new Image;n.onload=()=>{this.complete=!0,this.updateLoaderProgress(),n.onload=null,n.onerror=null,t(n)},n.onerror=()=>{n.onload=null,n.onerror=null,e(new Error(`Failed to load image: ${n.src} (r=${this.retries})`))},n.crossOrigin="anonymous",setTimeout((()=>{n.src=this.src}))}))}load(){return i.run((()=>this.try((()=>this._load()))))}getRetryWarningDescription(){return`download image ${this.src}`}};class h extends r{constructor(){super(...arguments),this.complete=!1,this.aborted=!1}markComplete(){this.complete=!0,this.updateLoaderProgress()}isComplete(){return this.complete}abort(){this.aborted=!0}}e.Manual=h;e.PromiseTask=class extends h{constructor(t){super(),t.then((()=>this.markComplete()))}};e.Loader=class{constructor(){this._tasks=[],this.aborted=!1,this.error=!1}calculateProgress(){if(this.aborted)return 1;const t=this._tasks.length;if(0===t)return 0;let e=0;for(const t of this._tasks)t.isComplete()&&e++;return e/t}updateProgress(){if(this.error)return;const t=this.calculateProgress();this.onprogress(t)}resetTasks(){this._tasks=[],this.updateProgress()}addTask(t){return this._tasks.push(t),t.setLoader(this),t}abort(){this.aborted=!0;for(const t of this._tasks)t.abort()}cleanup(){for(const t of this._tasks)t.setLoader(null);this._tasks.length=0}onprogress(t){}}}(t.io||(t.io={}))}(P||(P={})),function(t){!function(t){class e{constructor(t){this.source=t,this.index=0}parse(){return this.parseValue()}lineInfo(){let t=0,e=0;for(var n=0;n<this.index;n++)"\n"===this.source[n]?(t++,e=0):e++;return{line:t+1,column:e+1}}error(t){const{line:e,column:n}=this.lineInfo();throw new SyntaxError(`JSONParser: ${t} (Line ${e} Column ${n})`)}char(){return this.charAt(this.index)}charAt(t){return t>=this.source.length&&this.error("Unexpected end of input"),this.source[t]}next(){this.index++}expect(t){this.char()!==t&&this.error(`Expected '${t}' but found '${this.char()}'`),this.next()}peek(t=1,e=1){if(1===t)return this.charAt(this.index+e);let n="";for(var s=0;s<t;s++)n+=this.charAt(this.index+e+s);return n}skipWhitespace(){for(;/\s/.test(this.char());)this.next()}parseValue(){this.skipWhitespace();switch(this.char()){case'"':return this.parseString();case"{":return this.parseObject();case"[":return this.parseList();case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"-":return this.parseNumber();default:return this.parseWord()}}parseWord(){if("null"===this.peek(4,0)){for(var t=0;t<4;t++)this.next();return null}if("true"===this.peek(4,0)){for(t=0;t<4;t++)this.next();return!0}if("false"===this.peek(5,0)){for(t=0;t<5;t++)this.next();return!1}if("Infinity"===this.peek(8,0)){for(t=0;t<8;t++)this.next();return 1/0}if("-Infinity"===this.peek(9,0)){for(t=0;t<9;t++)this.next();return-1/0}if("NaN"===this.peek(3,0)){for(t=0;t<3;t++)this.next();return NaN}this.error(`Unknown word (starts with ${this.char()})`)}parseNumber(){let t="";for(;t+=this.char(),/[\d\.e+-]/i.test(this.peek());)this.next();this.next();const e=+t;return Number.isNaN(e)&&this.error("Not a number: "+t),e}parseString(){this.expect('"');let t="";if('"'===this.char())return this.next(),"";for(;;){const n=this.char();if("\\"===n)switch(this.next(),this.char()){case'"':t+='"';break;case"/":t+="/";break;case"\\":t+="\\";break;case"b":t+="\b";break;case"f":t+="\f";break;case"n":t+="\n";break;case"r":t+="\r";break;case"t":t+="\t";break;case"u":{let n="";for(var e=0;e<4;e++){this.next();const t=this.char();/[0-9a-f]/i.test(t)||this.error("Invalid hex code: "+t),n+=t}const s=Number.parseInt(n,16);t+=String.fromCharCode(s);break}default:this.error("Invalid escape code: \\"+this.char())}else t+=n;if('"'===this.peek())break;this.next()}return this.next(),this.expect('"'),t}parseList(){if(this.expect("["),this.skipWhitespace(),"]"===this.char())return this.next(),[];const t=[];for(;;){this.skipWhitespace();const e=this.parseValue();if(t.push(e),this.skipWhitespace(),"]"===this.char())break;this.expect(",")}return this.expect("]"),t}parseObject(){if(this.expect("{"),this.skipWhitespace(),"}"===this.char())return this.next(),{};const t=Object.create(null);for(;;){this.skipWhitespace();const e=this.parseString();this.skipWhitespace(),this.expect(":");const n=this.parseValue();if(t[e]=n,this.skipWhitespace(),"}"===this.char())break;this.expect(",")}return this.expect("}"),t}}t.parse=function(t){if(!/^\s*{/.test(t))throw new Error("The input does not seem to be a JSON object");try{return JSON.parse(t)}catch(n){console.warn("JSON.parse failed. Trying alternative parser",n);try{return new e(t).parse()}catch(t){throw console.warn("Alternative parser failed",t),n}}}}(t.json||(t.json={}))}(P||(P={})),function(t){!function(t){t.parseRotationStyle=function(t){switch(t){case"leftRight":case"left-right":return 1;case"none":case"don't rotate":return 2;case"normal":case"all around":return 0}return console.warn("unknown rotation style",t),0},t.rgbToHSL=function(t,e,n){t/=255,e/=255,n/=255;var s=Math.min(t,e,n),i=Math.max(t,e,n);if(s===i)return[0,0,t];var r,o=i-s,a=(s+i)/2,l=o/(1-Math.abs(2*a-1));switch(i){case t:r=((e-n)/o+6)%6;break;case e:r=(n-t)/o+2;break;case n:r=(t-e)/o+4}return[r*=60,l,a]},t.rgbToHSV=function(t,e,n){t/=255,e/=255,n/=255;var s,i,r=Math.max(t,e,n),o=Math.min(t,e,n),a=r,l=r-o;if(i=0==r?0:l/r,r==o)s=0;else{switch(r){case t:s=(e-n)/l+(e<n?6:0);break;case e:s=(n-t)/l+2;break;case n:s=(t-e)/l+4}s/=6}return[360*s,i,a]},t.hsvToRGB=function(t,e,n){var s,i,r,o=Math.floor(6*t),a=6*t-o,l=n*(1-e),h=n*(1-a*e),c=n*(1-(1-a)*e);switch(o%6){case 0:s=n,i=c,r=l;break;case 1:s=h,i=n,r=l;break;case 2:s=l,i=n,r=c;break;case 3:s=l,i=h,r=n;break;case 4:s=c,i=l,r=n;break;case 5:s=n,i=l,r=h}return[255*s|0,255*i|0,255*r|0]},t.hslToRGB=function(t,e,n){var s,i,r;if(0==e)s=i=r=n;else{function l(t,e,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?t+6*(e-t)*n:n<.5?e:n<2/3?t+(e-t)*(2/3-n)*6:t}var o=n<.5?n*(1+e):n+e-n*e,a=2*n-o;s=l(a,o,t+1/3),i=l(a,o,t),r=l(a,o,t-1/3)}return[255*s,255*i,255*r]},t.hslToHSV=function(t,e,n){var s=n+e*Math.min(n,1-n);return[t,e=0===s?0:2-2*n/s,s]},t.hsvToHSL=function(t,e,n){var s=n-n*e/2;return[t,e=0===s?0:(n-s)/Math.min(2-2*s/n),s]},t.clamp=function(t,e,n){return Math.min(n,Math.max(e,t))},t.settled=function(t){return new Promise(((e,n)=>{t.then((()=>e())).catch((()=>e()))}))},t.sleep=function(t){return new Promise((e=>setTimeout(e,t)))},t.parseColor=function(t){if("number"==typeof t)return t;if("string"==typeof t){const e=+t;if(!isNaN(e))return e;if(t.startsWith("#")){const e=t.substr(1),n=parseInt(e,16);if(6===e.length)return n;if(3===e.length){const t=n>>8&15,e=n>>4&15,s=15&n;return(t<<4|t)<<16|(e<<4|e)<<8|s<<4|s}}}return 0}}(t.utils||(t.utils={}))}(P||(P={})),function(t){!function(e){class n extends Error{constructor(){super(...arguments),this.handledByPlayer=!0}}e.PlayerError=n;class s extends n{constructor(t){super("Project with ID "+t+" does not exist"),this.id=t,this.name="ProjectDoesNotExistError"}}e.ProjectDoesNotExistError=s;class i extends n{constructor(t){super(`Cannot access project with ID ${t}`),this.id=t,this.name="CannotAccessProjectError"}}e.CannotAccessProjectError=i;class r{constructor(){this.active=!0,this.loader=null}cancel(){if(!this.active)throw new Error("cannot cancel: already cancelled");this.active=!1,this.loader&&this.loader.abort()}setLoader(t){if(!this.active)throw new Error("Loading aborted");this.loader=t}isActive(){return this.active}}class o{constructor(){this._listeners=[]}subscribe(t){this._listeners.push(t)}emit(t){for(const e of this._listeners)e(t)}}class a{constructor(t){this.filename=t}load(){return Promise.resolve(this)}getTitle(){return this.filename}getId(){return this.filename}isFromScratch(){return!1}getToken(){return null}isUnshared(){return!1}}class l{load(){return Promise.resolve(this)}getTitle(){return null}getId(){return"#buffer#"}isFromScratch(){return!1}getToken(){return null}isUnshared(){return!1}}class h{constructor(t){this.id=t,this.title=null,this.token=null,this.unshared=!1,this.loadCallbacks=[],this.startedLoading=!1}load(){if(!this.startedLoading){this.startedLoading=!0;const e=new t.io.Request(["https://trampoline.turbowarp.org/proxy/projects/$id".replace("$id",this.id),"https://trampoline.turbowarp.xyz/proxy/projects/$id".replace("$id",this.id),"https://t.unsandboxed.org/proxy/projects/$id".replace("$id",this.id)]);e.setMaxAttempts(1).ignoreErrors().load("json").then((t=>{404===e.getStatus()?this.unshared=!0:(t.title&&(this.title=t.title),t.project_token&&(this.token=t.project_token));for(const t of this.loadCallbacks)t(this);this.loadCallbacks.length=0})).catch((t=>{console.error(t),this.unshared=!0;for(const t of this.loadCallbacks)t(this);this.loadCallbacks.length=0}))}return new Promise((t=>{this.loadCallbacks.push(t)}))}getTitle(){return this.title}getId(){return this.id}isFromScratch(){return!0}getToken(){return this.token}isUnshared(){return this.unshared}}class c{constructor(t={}){this.onprogress=new o,this.onload=new o,this.onstartload=new o,this.oncleanup=new o,this.onthemechange=new o,this.onerror=new o,this.onresume=new o,this.onpause=new o,this.onoptionschange=new o,this.MAGIC={LARGE_Z_INDEX:"9999999999"},this.stage=null,this.projectMeta=null,this.currentLoader=null,this.fullscreenEnabled=!1,this.clickToPlayContainer=null,this.root=document.createElement("div"),this.root.className="player-root",this.playerContainer=document.createElement("div"),this.playerContainer.className="player-stage",this.root.appendChild(this.playerContainer),this.setOptions(Object.assign(Object.assign({},t),c.DEFAULT_OPTIONS)),window.addEventListener("resize",(()=>this.updateFullscreen())),document.addEventListener("fullscreenchange",(()=>this.onfullscreenchange())),document.addEventListener("mozfullscreenchange",(()=>this.onfullscreenchange())),document.addEventListener("webkitfullscreenchange",(()=>this.onfullscreenchange())),this.handleError=this.handleError.bind(this)}enableAttribute(t){this.root.setAttribute(t,"")}disableAttribute(t){this.root.removeAttribute(t)}setAttribute(t,e){e?this.enableAttribute(t):this.disableAttribute(t)}setOptions(t){this.options=Object.assign(Object.assign({},this.options),t),void 0!==t.turbo&&this.setAttribute("turbo",t.turbo),void 0!==t.theme&&(this.root.setAttribute("theme",t.theme),this.onthemechange.emit(t.theme)),this.hasStage()&&this.applyOptionsToStage(),this.onoptionschange.emit(t)}getOptions(){return this.options}addControls(e={}){if(this.controlsContainer)throw new Error("This player already has controls.");let n;const s=t=>{this.throwWithoutStage(),this.stopAll(),this.stage.draw(),t.preventDefault()},i=t=>{this.toggleRunning()},r=t=>{this.throwWithoutStage(),this.setOptions({fullscreenMode:t.shiftKey?"window":"full"}),this.fullscreenEnabled?this.exitFullscreen():this.enterFullscreen()},o=t=>{null!==n&&(n&&clearTimeout(n),this.throwWithoutStage(),t.shiftKey?this.setOptions({turbo:!this.options.turbo}):this.triggerGreenFlag(),this.focus(),t.preventDefault())},a=t=>{n=setTimeout((()=>{n=null,this.setOptions({turbo:!this.options.turbo})}),500)},l=t=>{t.preventDefault()};if(this.controlsContainer=document.createElement("div"),this.controlsContainer.className="player-controls",this.controlsContainer.onmousedown=t=>{t.target!==this.controlsContainer&&t.stopPropagation()},this.controlsContainer.ontouchstart=t=>{t.target!==this.controlsContainer&&t.stopPropagation()},!1!==e.enableFlag){var h=document.createElement("span");h.className="player-button player-flag",h.title=t.i18n.translate("player.controls.flag.title"),this.controlsContainer.appendChild(h),h.addEventListener("click",o),h.addEventListener("touchend",o),h.addEventListener("touchstart",a),h.addEventListener("touchstart",l)}if(!1!==e.enablePause){var c=document.createElement("span");c.className="player-button player-pause",this.controlsContainer.appendChild(c),c.addEventListener("click",i),c.addEventListener("touchend",i),c.addEventListener("touchstart",l)}if(!1!==e.enableStop){var d=document.createElement("span");d.className="player-button player-stop",this.controlsContainer.appendChild(d),d.addEventListener("click",s),d.addEventListener("touchend",s),d.addEventListener("touchstart",l)}if(!1!==e.enableTurbo){var u=document.createElement("span");u.innerText=t.i18n.translate("player.controls.turboIndicator"),u.className="player-label player-turbo",this.controlsContainer.appendChild(u),this.onoptionschange.subscribe((e=>{h&&"boolean"==typeof e.turbo&&(e.turbo?h.title=t.i18n.translate("player.controls.flag.title.enabled"):h.title=t.i18n.translate("player.controls.flag.title.disabled"))}))}if(!1!==e.enableFullscreen){var p=document.createElement("span");p.className="player-button player-fullscreen-btn",p.title=t.i18n.translate("player.controls.fullscreen.title"),this.controlsContainer.appendChild(p),p.addEventListener("click",r),p.addEventListener("touchend",r),p.addEventListener("touchstart",l)}this.root.addEventListener("touchmove",(t=>{this.fullscreenEnabled&&t.preventDefault()})),this.root.insertBefore(this.controlsContainer,this.root.firstChild)}applyOptionsToStage(){this.stage.runtime.framerate!==this.options.fps&&(this.stage.runtime.framerate=this.options.fps,this.isRunning()&&this.stage.runtime.resetInterval()),this.stage.username=this.options.username,this.stage.runtime.isTurbo=this.options.turbo,this.stage.useSpriteFencing=this.options.spriteFencing,this.stage.removeLimits=this.options.removeLimits,this.stage.renderer.imageSmoothingEnabled=this.options.imageSmoothing}generateUsernameIfMissing(){this.options.username||this.setOptions({username:"player"+Math.random().toFixed(10).substr(2,6)})}throwWithoutStage(){if(!this.stage)throw new Error("Missing stage.")}resume(){if(this.throwWithoutStage(),this.isRunning())throw new Error("cannot resume: project is already running");this.stage.runtime.start(),this.enableAttribute("running"),this.onresume.emit()}pause(){if(this.throwWithoutStage(),!this.isRunning())throw new Error("cannot pause: project is already paused");this.stage.runtime.pause(),this.disableAttribute("running"),this.onpause.emit()}isRunning(){return!!this.hasStage()&&this.stage.runtime.isRunning}toggleRunning(){this.throwWithoutStage(),this.stage.runtime.isRunning?this.pause():this.resume()}stopAll(){this.throwWithoutStage(),this.pause(),this.stage.runtime.stopAll()}triggerGreenFlag(){this.throwWithoutStage(),this.isRunning()||this.resume(),this.stage.runtime.stopAll(),this.stage.runtime.triggerGreenFlag(),this.clickToPlayContainer&&this.removeClickToPlayContainer()}cleanup(){for(this.currentLoader&&(this.currentLoader.cancel(),this.currentLoader=null),this.clickToPlayContainer&&this.removeClickToPlayContainer(),this.fullscreenEnabled&&this.exitFullscreen(),this.stage&&(this.stage.destroy(),this.stage=null),this.projectMeta=null;this.playerContainer.firstChild;)this.playerContainer.removeChild(this.playerContainer.firstChild);this.oncleanup.emit()}focus(){this.stage.focus()}hasStage(){return!!this.stage}getStage(){return this.throwWithoutStage(),this.stage}hasProjectMeta(){return!!this.projectMeta}getProjectMeta(){if(!this.projectMeta)throw new Error("no project meta");return this.projectMeta}handleError(t){console.error(t),this.onerror.emit(t)}enterFullscreen(){document.body.classList.add("player-body-fullscreen"),this.root.style.zIndex=this.MAGIC.LARGE_Z_INDEX,this.enableAttribute("fullscreen"),this.fullscreenEnabled=!0,this.hasStage()&&(this.isRunning()||this.stage.draw(),this.options.focusOnLoad&&this.focus()),this.updateFullscreen()}exitFullscreen(){this.setOptions({theme:this.savedTheme}),this.disableAttribute("fullscreen"),this.fullscreenEnabled=!1,document.fullscreenElement!==this.root&&document.webkitFullscreenElement!==this.root||(document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()),this.root.style.paddingLeft="",this.root.style.paddingTop="",this.root.style.zIndex="",this.controlsContainer&&(this.controlsContainer.style.width=""),document.body.classList.remove("player-body-fullscreen"),this.stage&&(this.stage.setZoom(1),this.focus())}updateFullscreen(){if(!this.fullscreenEnabled)return;this.throwWithoutStage();const t=this.controlsContainer?this.controlsContainer.offsetHeight:0;window.scrollTo(0,0);let e=window.innerWidth-2*this.options.fullscreenPadding,n=window.innerHeight-this.options.fullscreenPadding-t;e=Math.min(e,n/.75),e=Math.min(e,this.options.fullscreenMaxWidth),n=.75*e+t,this.controlsContainer&&(this.controlsContainer.style.width=e+"px"),this.root.style.paddingLeft=(window.innerWidth-e)/2+"px",this.root.style.paddingTop=(window.innerHeight-n-this.options.fullscreenPadding)/2+"px",this.root.style.setProperty("--lower-width-by",window.innerWidth-e+"px"),this.root.style.setProperty("--lower-height-by",window.innerHeight-n-this.options.fullscreenPadding+"px"),this.stage.setZoom(e/480)}onfullscreenchange(){("boolean"==typeof document.fullscreen&&document.fullscreen!==this.fullscreenEnabled||"boolean"==typeof document.webkitIsFullScreen&&document.webkitIsFullScreen!==this.fullscreenEnabled)&&this.exitFullscreen()}applyCloudVariablesSocket(e,n){this.generateUsernameIfMissing();const s=new t.ext.cloud.WebSocketCloudHandler(e,this.options.cloudHost,n);e.setCloudHandler(s)}applyCloudVariablesLocalStorage(e,n){const s=new t.ext.cloud.LocalStorageCloudHandler(e,n);e.setCloudHandler(s)}applyCloudVariables(t){const e=this.stage,n=this.projectMeta;if(!n)throw new Error("cannot apply cloud variable settings without projectMeta");if(e.cloudVariables.length>0)switch(t){case"ws":n.isFromScratch()&&this.applyCloudVariablesSocket(e,n.getId());break;case"localStorage":this.applyCloudVariablesLocalStorage(e,n.getId())}}applyAutoplayPolicy(e){switch(e){case"always":this.triggerGreenFlag();break;case"if-audio-playable":t.audio.context&&"running"!==t.audio.context.state?this.showClickToPlayContainer():this.triggerGreenFlag();break;case"never":this.showClickToPlayContainer()}}showClickToPlayContainer(){if(this.clickToPlayContainer)throw new Error("cannot show click-to-play interface: already shown");this.clickToPlayContainer=document.createElement("div"),this.clickToPlayContainer.className="player-click-to-play-container",this.clickToPlayContainer.onclick=()=>{t.audio.context&&"running"!==t.audio.context.state&&t.audio.context.resume(),this.removeClickToPlayContainer(),this.triggerGreenFlag(),this.focus()};const e=document.createElement("div");e.className="player-click-to-play-icon",this.clickToPlayContainer.appendChild(e),this.stage.ui.appendChild(this.clickToPlayContainer)}removeClickToPlayContainer(){if(null===this.clickToPlayContainer)throw new Error("cannot hide click-to-play interface: already hidden");this.stage.ui.removeChild(this.clickToPlayContainer),this.clickToPlayContainer=null}beginLoadingProject(){this.cleanup(),this.onstartload.emit();const t=new r;return this.currentLoader=t,{loaderId:t}}determineProjectType(t){if("objName"in t)return"sb2";if("targets"in t)return"sb3";throw new Error("Unknown project type")}isScratch1Project(t){const e="ScratchV0",n=new Uint8Array(t);for(var s=0;s<e.length;s++)if(String.fromCharCode(n[s])!==e[s])return!1;return!0}convertScratch1Project(t){const e=new ScratchSB1Converter.SB1File(t),n=e.json,s=e.zip.files,i=new JSZip;i.file("project.json",JSON.stringify(n));for(const t of Object.keys(s))i.file(t,s[t].bytes);return i.generateAsync({type:"arraybuffer"})}fetchProject(e,n){let i=this.options.projectHost.replace("$id",e);n&&(i+=`?token=${n}`);const r=new t.io.Request(i);return r.ignoreErrors().load("blob").then((function(t){if(404===r.getStatus())throw new s(e);if(403===r.getStatus())throw new Error("Obtained token but permission was denied anyways. Try refreshing.");return t}))}setStage(t){this.stage=t,this.stage.runtime.handleError=this.handleError,this.applyOptionsToStage(),this.playerContainer.appendChild(t.root),this.options.focusOnLoad&&this.focus(),this.onload.emit(t),this.stage.draw(),this.applyCloudVariables(this.options.cloudVariables),this.applyAutoplayPolicy(this.options.autoplayPolicy)}async loadLoader(t,e){t.setLoader(e),e.onprogress=e=>{t.isActive()&&this.onprogress.emit(e)};const n=await e.load();return this.setStage(n),this.currentLoader=null,e.cleanup(),n}async loadProjectById(e){const{loaderId:n}=this.beginLoadingProject(),s=async e=>{try{const n=await t.io.readers.toText(e),s=t.json.parse(n);switch(this.determineProjectType(s)){case"sb2":return new t.sb2.Scratch2Loader(s);case"sb3":return new t.sb3.Scratch3Loader(s)}}catch(n){let s=await t.io.readers.toArrayBuffer(e);if(this.isScratch1Project(s))s=await this.convertScratch1Project(s);else try{const e=(await JSZip.loadAsync(s)).file("project.json");if(!e)throw new Error("zip is missing project.json");const n=await e.async("text"),i=JSON.parse(n);if("sb3"===this.determineProjectType(i))return new t.sb3.SB3FileLoader(s)}catch(t){}return new t.sb2.SB2FileLoader(s)}};try{const t=new h(e);this.projectMeta=t;const r=this.options.projectHost.startsWith("https://projects.scratch.mit.edu/");let o=null;if(r){if(await t.load(),t.isUnshared())throw new i(e);o=t.getToken()}const a=await this.fetchProject(e,o),l=await s(a);await this.loadLoader(n,l)}catch(t){n.isActive()&&this.handleError(t)}}async loadProjectFromBufferWithType(e,n,s){let i;switch("sb"===s&&(n=await this.convertScratch1Project(n),s="sb2"),s){case"sb2":i=new t.sb2.SB2FileLoader(n);break;case"sb3":i=new t.sb3.SB3FileLoader(n);break;default:throw new Error("Unknown type: "+s)}await this.loadLoader(e,i)}async loadProjectFromFile(e){const{loaderId:n}=this.beginLoadingProject();try{this.projectMeta=new a(e.name);const s=e.name.split(".").pop()||"",i=await t.io.readers.toArrayBuffer(e);switch(s){case"sb":return await this.loadProjectFromBufferWithType(n,i,"sb");case"sb2":return await this.loadProjectFromBufferWithType(n,i,"sb2");case"sb3":return await this.loadProjectFromBufferWithType(n,i,"sb3");default:throw new Error("Unrecognized file extension: "+s)}}catch(t){n.isActive()&&this.handleError(t)}}async loadProjectFromBuffer(t,e){const{loaderId:n}=this.beginLoadingProject();try{return this.projectMeta=new l,await this.loadProjectFromBufferWithType(n,t,e)}catch(t){n.isActive()&&this.handleError(t)}}}c.DEFAULT_OPTIONS={autoplayPolicy:"always",cloudVariables:"ws",fps:30,theme:"light",turbo:!1,username:"",fullscreenMode:"full",fullscreenPadding:8,fullscreenMaxWidth:1/0,imageSmoothing:!1,focusOnLoad:!0,spriteFencing:!1,removeLimits:!1,projectHost:"https://projects.scratch.mit.edu/$id",cloudHost:["wss://stratus.turbowarp.org","wss://stratus.turbowarp.xyz"]},e.Player=c;class d{constructor(t,e={}){this.player=t,this.errorEl=null,this.errorContainer=null,this.generatedErrorLink=null,this.player=t,t.onerror.subscribe(this.onerror.bind(this)),t.oncleanup.subscribe(this.oncleanup.bind(this)),this.errorEl=null,e.container?this.errorContainer=e.container:this.errorContainer=null}stringifyError(t){return t?t.stack?"Message: "+t.message+"\nStack:\n"+t.stack:""+t:"unknown error"}createBugReportLink(t){const e=`${t?"[Error]":"[Bug]"} ${this.getBugReportTitle()}`,n=this.getBugReportBody(t);return d.BUG_REPORT_LINK.replace("$title",encodeURIComponent(e)).replace("$body",encodeURIComponent(n))}getBugReportTitle(){if(!this.player.hasProjectMeta())return"Unknown Project";const t=this.player.getProjectMeta(),e=t.getTitle(),n=t.getId();return e||(n||"Unknown Project")}getBugReportBody(t){const e=[];e.push({title:"Describe the bug, including any steps to reproduce it",body:""}),e.push({title:"Project ID, URL, or file",body:this.getProjectInformation()});let n="";return n+=location.href+"\n",n+=navigator.userAgent+"\n",t&&(n+="```\n"+this.stringifyError(t)+"\n```"),e.push({title:"Debug information \x3c!-- DO NOT EDIT --\x3e",body:n}),e.map((t=>`**${t.title}**\n${t.body}\n`)).join("\n").trim()}getProjectInformation(){if(!this.player.hasProjectMeta())return"no project meta loaded";const t=this.player.getProjectMeta();return t.isFromScratch()?t.getTitle()?"https://scratch.mit.edu/projects/"+t.getId():"https://scratch.mit.edu/projects/"+t.getId()+" (probably unshared)":"Not from Scratch: "+t.getId()}oncleanup(){this.errorEl&&this.errorEl.parentNode&&(this.errorEl.parentNode.removeChild(this.errorEl),this.errorEl=null),this.generatedErrorLink=null}handleError(e){const n=document.createElement("div"),s=this.createBugReportLink(e);this.generatedErrorLink=s;const i='href="'+s+'" target="_blank" ref="noopener"';return n.innerHTML=t.i18n.translate("player.errorhandler.error").replace("$attrs",i),n}handleCannotAccessProjectError(t){const e=document.createElement("div"),n=document.createElement("div");n.textContent="Can't access project token. This usually means the project is unshared, never existed, or the ID is invalid.",n.style.marginBottom="4px",e.appendChild(n);const s=document.createElement("div");s.textContent="Unshared projects are no longer accessible using their project ID due to Scratch API changes. ",s.appendChild(Object.assign(document.createElement("a"),{textContent:"More information",href:"https://docs.turbowarp.org/unshared-projects"})),s.style.marginBottom="4px",s.appendChild(document.createTextNode(".")),e.appendChild(s);const i=document.createElement("div");return i.textContent="If the project was shared recently, it may take a few minutes for this message to go away. If the project is actually shared, please report a bug.",e.appendChild(i),e}handleDoesNotExistError(e){const n=document.createElement("div");return"https://projects.scratch.mit.edu/internalapi/project/$id/get/"===this.player.getOptions().projectHost?n.textContent=t.i18n.translate("player.errorhandler.error.doesnotexistlegacy").replace("$id",e.id):n.textContent=t.i18n.translate("player.errorhandler.error.doesnotexist").replace("$id",e.id),n}onerror(t){const e=document.createElement("div");e.className="player-error",t instanceof i?e.appendChild(this.handleCannotAccessProjectError(t)):t instanceof s?e.appendChild(this.handleDoesNotExistError(t)):e.appendChild(this.handleError(t)),this.errorContainer?this.errorContainer.appendChild(e):this.player.hasStage()?this.player.getStage().ui.appendChild(e):this.player.playerContainer.appendChild(e),this.errorEl=e}}d.BUG_REPORT_LINK="https://github.com/text-based-scratch/bs3.illogicalapple.com/issues/new?template=bug_report.md&labels=bug&title=$title&body=$body&",e.ErrorHandler=d;e.ProgressBar=class{constructor(t,e={}){if(this.el=document.createElement("div"),this.el.className="player-progress",this.bar=document.createElement("div"),this.bar.className="player-progress-fill",this.el.appendChild(this.bar),this.setTheme(t.getOptions().theme),t.onthemechange.subscribe((t=>this.setTheme(t))),t.onprogress.subscribe((t=>this.setProgress(t))),t.onstartload.subscribe((()=>{this.el.setAttribute("state","loading"),this.setProgress(0)})),t.onload.subscribe((()=>{this.el.setAttribute("state","loaded")})),t.oncleanup.subscribe((()=>{this.el.setAttribute("state",""),this.bar.style.width="0%"})),t.onerror.subscribe((()=>{this.el.setAttribute("state","error"),this.bar.style.width="100%"})),"controls"===e.position||void 0===e.position){if(!t.controlsContainer)throw new Error("No controls to put progess bar in.");t.controlsContainer.appendChild(this.el)}else e.position.appendChild(this.el)}setTheme(t){this.el.setAttribute("theme",t)}setProgress(t){this.bar.style.width=10+90*t+"%"}}}(t.player||(t.player={}))}(P||(P={})),function(P){var runtime;(function(runtime_1){var runtime,self,S,R,STACK,C,CALLS,WARP,BASE,THREAD,IMMEDIATE,VISUAL,STOPPED;const epoch=Date.UTC(2e3,0,1),INSTRUMENTS=P.audio.instruments,DRUMS=P.audio.drums,DIGIT=/\d/;var bool=function(t){return 0!=+t&&""!==t&&"false"!==t&&!1!==t},compare=function(t,e){if(("string"!=typeof t||DIGIT.test(t))&&("string"!=typeof e||DIGIT.test(e))){var n=+t,s=+e;if(n==n&&s==s)return n<s?-1:n===s?0:1}var i=(""+t).toLowerCase(),r=(""+e).toLowerCase();return i<r?-1:i===r?0:1},numLess=function(t,e){if("number"==typeof e||DIGIT.test(e)){var n=+e;if(n==n)return t<n}return""+t<(""+e).toLowerCase()},numGreater=function(t,e){if("number"==typeof e||DIGIT.test(e)){var n=+e;if(n==n)return t>n}return""+t>(""+e).toLowerCase()},equal=function(t,e){if(("number"==typeof t||"boolean"==typeof t||DIGIT.test(t))&&("number"==typeof e||"boolean"==typeof t||DIGIT.test(e))){var n=+t,s=+e;if(n==n&&s==s)return n===s}return(""+t).toLowerCase()===(""+e).toLowerCase()},numEqual=function(t,e){if("number"==typeof e||DIGIT.test(e)){var n=+e;return n==n&&t===n}return!1},numEqualExperimental=function(t,e){var n=+e;return n==n&&t===n},numLessExperimental=function(t,e){var n=+e;return n==n&&t<e},numGreaterExperimental=function(t,e){var n=+e;return n==n&&t>e},strEqual=function(t,e){return(t+"").toLowerCase()===(e+"").toLowerCase()},stringContains=function(t,e){return t.toLowerCase().indexOf(e.toLowerCase())>-1},mod=function(t,e){var n=t%e;return n/e<0&&(n+=e),n},random=function(t,e){var n="string"==typeof t&&!isNaN(+t)&&t.indexOf(".")>-1||"string"==typeof e&&!isNaN(+e)&&e.indexOf(".")>-1;if((t=+t||0)>(e=+e||0)){var s=e;e=t,t=s}return n||t%1!=0||e%1!=0?Math.random()*(e-t)+t:Math.floor(Math.random()*(e-t+1))+t},random3=function(t,e){var n="string"==typeof t&&t.indexOf(".")>-1||"string"==typeof e&&e.indexOf(".")>-1;if((t=+t||0)>(e=+e||0)){var s=e;e=t,t=s}return n||t%1!=0||e%1!=0?Math.random()*(e-t)+t:Math.floor(Math.random()*(e-t+1))+t},clone=function(t){const e="_myself_"===t?S:self.getObject(t);if(!e||!P.core.isSprite(e))return;const n=e.clone();self.children.splice(self.children.indexOf(e),0,n),runtime.triggerFor(n,"whenCloned"),n.visible&&(VISUAL=!0)},getVars=function(t){return void 0!==self.vars[t]?self.vars:S.vars},getLists=function(t){return void 0!==self.lists[t]?self.lists:(void 0===S.lists[t]&&(S.lists[t]=[]),S.lists)},listIndex=function(t,e,n){var s=0|e;return s===e?s>0&&s<=n?s-1:-1:"random"===e||"any"===e?Math.random()*n|0:"last"===e?n-1:s>0&&s<=n?s-1:-1},contentsOfList=function(t){for(var e=!0,n=t.length;n--;)if(1!==t[n].length){e=!1;break}return t.join(e?"":" ")},getLineOfList=function(t,e){var n=listIndex(t,e,t.length);return-1!==n?t[n]:""},listContains=function(t,e){for(var n=t.length;n--;)if(equal(t[n],e))return!0;return!1},listIndexOf=function(t,e){for(var n=0;n<t.length;n++)if(equal(t[n],e))return n+1;return 0},appendToList=function(t,e){t.push(e)},deleteLineOfList=function(t,e){if("all"===e)t.length=0;else{var n=listIndex(t,e,t.length);n===t.length-1?t.pop():-1!==n&&t.splice(n,1)}},insertInList=function(t,e,n){var s=listIndex(t,e,t.length+1);s===t.length?t.push(n):-1!==s&&t.splice(s,0,n)},setLineOfList=function(t,e,n){var s=listIndex(t,e,t.length);-1!==s&&(t[s]=n)},watchedAppendToList=function(t,e){appendToList(t,e),t.modified||(t.modified=!0)},watchedDeleteLineOfList=function(t,e){deleteLineOfList(t,e),t.modified||(t.modified=!0)},watchedDeleteAllOfList=function(t){t.length=0,t.modified||(t.modified=!0)},watchedInsertInList=function(t,e,n){insertInList(t,e,n),t.modified||(t.modified=!0)},watchedSetLineOfList=function(t,e,n){setLineOfList(t,e,n),t.modified||(t.modified=!0)},mathFunc=function(t,e){switch(t){case"abs":return Math.abs(e);case"floor":return Math.floor(e);case"sqrt":return Math.sqrt(e);case"ceiling":return Math.ceil(e);case"cos":return Math.cos(e*Math.PI/180);case"sin":return Math.sin(e*Math.PI/180);case"tan":return Math.tan(e*Math.PI/180);case"asin":return 180*Math.asin(e)/Math.PI;case"acos":return 180*Math.acos(e)/Math.PI;case"atan":return 180*Math.atan(e)/Math.PI;case"ln":return Math.log(e);case"log":return Math.log(e)/Math.LN10;case"e ^":return Math.exp(e);case"10 ^":return Math.exp(e*Math.LN10)}return 0},tan3=function(t){return 90===(t-=360*Math.floor(t/360))?1/0:270===t?-1/0:Math.round(1e10*Math.tan(t*Math.PI/180))/1e10},attribute=function(t,e){const n=self.getObject(e);if(!n)return 0;if(P.core.isSprite(n))switch(t){case"x position":return n.scratchX;case"y position":return n.scratchY;case"direction":return n.direction;case"costume #":return n.currentCostumeIndex+1;case"costume name":return n.costumes[n.currentCostumeIndex].name;case"size":return 100*n.scale;case"volume":return 100*n.volume}else switch(t){case"background #":case"backdrop #":return n.currentCostumeIndex+1;case"backdrop name":return n.costumes[n.currentCostumeIndex].name;case"volume":return 100*n.volume}const s=n.vars[t];return void 0!==s?s:0},timeAndDate=function(t){switch(t){case"year":return(new Date).getFullYear();case"month":return(new Date).getMonth()+1;case"date":return(new Date).getDate();case"day of week":return(new Date).getDay()+1;case"hour":return(new Date).getHours();case"minute":return(new Date).getMinutes();case"second":return(new Date).getSeconds()}return 0};function getKeyCode(t){switch((t+="").toLowerCase()){case"space":case" ":return"space";case"left arrow":case"":return"left arrow";case"up arrow":case"":return"up arrow";case"right arrow":case"":return"right arrow";case"down arrow":case"":return"down arrow";case"any":return"any";case"\r":return"enter";case"":return"esc";case"\t":return"tab";case"\b":return"backspace";case"":return"delete";case"":return"_shift"}return""+t.charCodeAt(0)}runtime_1.getKeyCode=getKeyCode;var getKeyCode3=function(t){switch(t.toLowerCase()){case"space":case" ":return"space";case"left arrow":return"left arrow";case"up arrow":return"up arrow";case"right arrow":return"right arrow";case"down arrow":return"down arrow";case"any":return"any";case"enter":return"enter";case"escape":return"esc";case"backspace":return"backspace";case"delete":return"delete";case"insert":return"insert";case"home":return"home";case"end":return"end";case"page up":return"page up";case"page down":return"page down";case"control":return"control";case"shift":return"_shift"}return""+t.toLowerCase().charCodeAt(0)};const audioContext=P.audio.context;if(audioContext)var playNote=function(t,e){for(var n,s=INSTRUMENTS[S.instrument],i=0,r=s.length;i<r&&!((n=s[i]).top>=t||128===n.top);i++);return playSpan(n,t,e)},playSpan=function(t,e,n){return{stopped:!1,node:P.audio.playSpan(t,e,n,S.getAudioNode()),base:BASE}},applySoundEffects=function(t){t.playbackRate.value=Math.pow(2,S.soundFilters.pitch/10/12)},updateSoundEffectsOnAllSounds=function(){for(const t of S.activeSounds)t.node&&applySoundEffects(t.node)},playSound=function(t){const e=t.createSourceNode();return applySoundEffects(e),e.connect(S.getAudioNode()),{stopped:!1,node:e,base:BASE}},startSound=function(t){for(const e of S.activeSounds)if(e.node===t.source){e.stopped=!0;break}const e=t.createSourceNode();applySoundEffects(e),e.connect(S.getAudioNode())};var save=function(){STACK.push(R),R={}},restore=function(){R=STACK.pop()},call=function(t,e,n){if(t)if(STACK.push(R),CALLS.push(C),C={base:t.fn,fn:S.fns[e],args:t.call(n),numargs:[],boolargs:[],stack:STACK=[],warp:t.warp},R={},C.warp||WARP)WARP++,IMMEDIATE=t.fn;else{if(VISUAL)for(var s=CALLS.length,i=5;s--&&i--;)if(CALLS[s].base===t.fn)return void(runtime.queue[THREAD]={sprite:S,base:BASE,fn:t.fn,calls:CALLS,warp:WARP,stopped:!1});IMMEDIATE=t.fn}else IMMEDIATE=S.fns[e]},endCall=function(){CALLS.length&&(WARP&&WARP--,IMMEDIATE=C.fn,C=CALLS.pop(),STACK=C.stack,R=STACK.pop())},cloudVariableChanged=function(t){self.cloudHandler&&self.cloudHandler.variableChanged(t)},parseColor=function(t){return P.utils.parseColor(t)},sceneChange=function(){return runtime.trigger("whenSceneStarts",self.getCostumeName())},broadcast=function(t){return runtime.trigger("whenIReceive",t)},running=function(t){for(var e=0;e<runtime.queue.length;e++)if(runtime.queue[e]&&-1!==t.indexOf(runtime.queue[e].base))return!0;return!1},queue=function(t){WARP?IMMEDIATE=S.fns[t]:forceQueue(t)},forceQueue=function(t){STOPPED||(runtime.queue[THREAD]={sprite:S,base:BASE,fn:S.fns[t],calls:CALLS,warp:WARP,stopped:!1})};class Runtime{constructor(t){this.stage=t,this.queue=[],this.isRunning=!1,this.timerStart=0,this.baseTime=0,this.baseNow=0,this.isTurbo=!1,this.framerate=30,this.currentMSecs=0,this.whenTimerMSecs=0,this.onError=this.onError.bind(this),this.step=this.step.bind(this)}startThread(t,e,n){const s={sprite:t,base:e,fn:e,calls:[{args:[],stack:[{}]}],warp:0,stopped:!1};for(let i=0;i<this.queue.length;i++){const r=this.queue[i];if(r&&r.sprite===t&&r.base===e)return void(n&&(this.queue[i]=s))}this.queue.push(s)}triggerFor(t,e,n){let s,i=!0;switch(e){case"whenClicked":s=t.listeners.whenClicked;break;case"whenCloned":s=t.listeners.whenCloned;break;case"whenGreenFlag":s=t.listeners.whenGreenFlag;break;case"whenKeyPressed":if(i=!1,s=t.listeners.whenKeyPressed[n]||[],"any"!==n){const e=t.listeners.whenKeyPressed.any;e&&(s=s.concat(e))}break;case"whenSceneStarts":s=t.listeners.whenSceneStarts[(""+n).toLowerCase()];break;case"whenIReceive":n=""+n,s=t.listeners.whenIReceive[n]||t.listeners.whenIReceive[n.toLowerCase()];break;case"edgeActivated":s=t.listeners.edgeActivated;break;default:throw new Error("Unknown trigger event: "+e)}if(s)for(let e=0;e<s.length;e++)this.startThread(t,s[e],i);return s||[]}trigger(t,e){let n=[];for(let s=this.stage.children.length;s--;)n=n.concat(this.triggerFor(this.stage.children[s],t,e));return n.concat(this.triggerFor(this.stage,t,e))}triggerGreenFlag(){this.timerStart=this.now(),this.trigger("whenGreenFlag"),this.trigger("edgeActivated")}start(){this.isRunning=!0,this.interval||(window.addEventListener("error",this.onError),this.baseTime=Date.now(),this.interval=setInterval(this.step,1e3/this.framerate),audioContext&&audioContext.resume(),this.stage.startExtensions())}pause(){this.interval&&(this.baseNow=this.now(),clearInterval(this.interval),this.interval=0,window.removeEventListener("error",this.onError),audioContext&&audioContext.suspend(),this.stage.pauseExtensions()),this.isRunning=!1}resetInterval(){if(!this.isRunning)throw new Error("Cannot restart interval when paused");this.interval&&clearInterval(this.interval),this.interval=setInterval(this.step,1e3/this.framerate)}stopAll(){this.stage.hidePrompt=!1,this.stage.prompter.style.display="none",this.stage.promptId=this.stage.nextPromptId=0;for(var t=0;t<this.queue.length;t++){const e=this.queue[t];e&&(e.stopped=!0)}STOPPED=!0,this.stage.resetFilters(),this.stage.stopSounds();for(t=0;t<this.stage.children.length;t++){const e=this.stage.children[t];e.isClone?(e.remove(),this.stage.children.splice(t,1),t-=1):(e.resetFilters(),e.saying&&P.core.isSprite(e)&&e.say(""),e.stopSounds())}}now(){return this.baseNow+Date.now()-this.baseTime}resetTimer(){this.timerStart=this.now(),this.whenTimerMSecs=0}evaluateExpression(t,e){self=this.stage,runtime=this,S=t;try{return e()}catch(t){return}}step(){self=this.stage,runtime=this,VISUAL=!1;for(var t=0;t<this.stage.children.length;t++){const e=this.stage.children[t];e.isDragging&&e.moveTo(e.dragOffsetX+e.stage.mouseX,e.dragOffsetY+e.stage.mouseY)}audioContext&&"suspended"===audioContext.state&&audioContext.resume();const e=Date.now();this.currentMSecs=this.whenTimerMSecs=this.now();const n=this.queue;do{for(THREAD=0;THREAD<n.length;THREAD++){const t=n[THREAD];if(t){for(S=t.sprite,IMMEDIATE=t.fn,BASE=t.base,CALLS=t.calls,C=CALLS.pop(),STACK=C.stack,R=STACK.pop(),WARP=t.warp,STOPPED=t.stopped,t.stopped=!0;IMMEDIATE;){const t=IMMEDIATE;IMMEDIATE=null,t()}STACK.push(R),CALLS.push(C)}}for(let t=n.length;t--;){const e=n[t];e&&!e.stopped||n.splice(t,1)}}while((this.isTurbo||!VISUAL)&&Date.now()-e<1e3/this.framerate&&n.length);this.stage.updateExtensions(),this.stage.draw()}onError(t){clearInterval(this.interval),this.handleError(t.error)}handleError(t){console.error(t)}}function createContinuation(t){for(var e="(function() {\n",n=0,s=0,i=!1,r=0,o=t.length;r<o;){var a=t.indexOf("{",r),l=t.indexOf("}",r),h=t.indexOf("return;",r);if(-1===h&&(h=o),-1===a&&-1===l){i||(e+=t.slice(r,h));break}if(-1===a&&(a=o),-1===l&&(l=o),i)a<l?(s++,r=a+1):(--s||(i=!1),r=l+1);else{if(0===n&&h<a&&h<l){e+=t.slice(r,h);break}a<l?(e+=t.slice(r,a+1),n++,r=a+1):(e+=t.slice(r,l),r=l+1,"} else {"===t.substr(l,8)?n>0?(e+="} else {",r=l+8):(i=!0,s=0):n>0&&(e+="}",n--))}}return scopedEval(e+="})")}function scopedEval(source){return eval(source)}runtime_1.Runtime=Runtime,runtime_1.createContinuation=createContinuation,runtime_1.scopedEval=scopedEval})(runtime=P.runtime||(P.runtime={}))}(P||(P={})),function(t){!function(e){const n="https://cdn.assets.scratch.mit.edu/internalapi/asset/";class s extends t.core.Watcher{constructor(t,e,n){if(super(t,e),this.cmd=n.cmd,this.type=n.type||"var",n.color){var s=(n.color<0?n.color+16777216:n.color).toString(16);this.color="#000000".slice(0,-s.length)+s}else this.color="#ee7d16";this.isDiscrete=null==n.isDiscrete||n.isDiscrete,this.label=n.label||"",this.mode=n.mode||1,this.param=n.param,this.sliderMax=null==n.sliderMax?100:n.sliderMax,this.sliderMin=n.sliderMin||0,this.targetName=n.target,this.visible=null!=n.visible&&n.visible,this.x=n.x||0,this.y=n.y||0}init(){super.init(),this.target&&"getVar:"===this.cmd&&(this.target.watchers[this.param]=this),this.label||(this.label=this.getLabel(),this.target.isSprite&&(this.label=this.target.name+": "+this.label)),this.layout()}getLabel(){switch(this.cmd){case"getVar:":case"timeAndDate":return this.param;case"sensor:":return this.param+" sensor value";case"sensorPressed":return"sensor "+this.param+"?";case"senseVideoMotion":return"video "+this.param}return{costumeIndex:"costume #",xpos:"x position",ypos:"y position",heading:"direction",scale:"size",backgroundIndex:"background #",sceneName:"background name",tempo:"tempo",volume:"volume",answer:"answer",timer:"timer",soundLevel:"loudness",isLoud:"loud?",xScroll:"x scroll",yScroll:"y scroll"}[this.cmd]||""}setVisible(t){super.setVisible(t),this.layout()}update(){var t=0;if(this.target){switch(this.cmd){case"answer":t=this.stage.answer;break;case"backgroundIndex":t=this.stage.currentCostumeIndex+1;break;case"costumeIndex":t=this.target.currentCostumeIndex+1;break;case"getVar:":t=this.target.vars[this.param];break;case"heading":t=this.target.direction;break;case"scale":this.target.isSprite&&(t=100*this.target.scale);break;case"sceneName":t=this.stage.getCostumeName();break;case"senseVideoMotion":break;case"soundLevel":t=this.stage.microphone?this.stage.microphone.getLoudness():-1;break;case"tempo":t=this.stage.tempoBPM;break;case"timeAndDate":t=this.timeAndDate(this.param);break;case"timer":t=Math.round((this.stage.runtime.now()-this.stage.runtime.timerStart)/100)/10;break;case"volume":t=100*this.target.volume;break;case"xpos":t=this.target.scratchX;break;case"ypos":t=this.target.scratchY}"number"==typeof t&&(t<.001||t>.001)&&(t=Math.round(1e3*t)/1e3),this.readout.textContent=""+t,this.slider&&(this.buttonWrap.style.transform="translate("+((+t||0)-this.sliderMin)/(this.sliderMax-this.sliderMin)*100+"%,0)")}}timeAndDate(t){switch(t){case"year":return(new Date).getFullYear();case"month":return(new Date).getMonth()+1;case"date":return(new Date).getDate();case"day of week":return(new Date).getDay()+1;case"hour":return(new Date).getHours();case"minute":return(new Date).getMinutes();case"second":return(new Date).getSeconds()}return 0}layout(){if(this.el)this.el.style.display=this.visible?"block":"none";else if(this.visible){this.el=document.createElement("div"),this.el.dataset.watcher=""+this.stage.allWatchers.indexOf(this),this.el.style.whiteSpace="pre",this.el.style.position="absolute",this.el.style.left=this.el.style.top="0",this.el.style.transform="translate("+(0|this.x)/10+"em,"+(0|this.y)/10+"em)",this.el.style.cursor="default",2===this.mode?(this.el.appendChild(this.readout=document.createElement("div")),this.readout.style.minWidth=38/15+"em",this.readout.style.font="bold 1.5em/"+19/15+" sans-serif",this.readout.style.height=19/15+"em",this.readout.style.borderRadius=4/15+"em",this.readout.style.margin="0.2em 0 0 0",this.readout.style.padding="0 0.3em"):(this.el.appendChild(this.labelEl=document.createElement("div")),this.el.appendChild(this.readout=document.createElement("div")),this.el.style.border=".1em solid rgb(148,145,145)",this.el.style.borderRadius=".4em",this.el.style.background="rgb(193,196,199)",this.el.style.padding=".2em .6em .3em .5em",this.labelEl.textContent=this.label,this.labelEl.style.font="bold 1.1em/1 sans-serif",this.labelEl.style.display="inline-block",this.labelEl.style.verticalAlign=this.readout.style.verticalAlign="middle",this.readout.style.minWidth="3.7em",this.readout.style.padding="0 0.1em",this.readout.style.font="bold 1.0em/1.3 sans-serif",this.readout.style.height="1.3em",this.readout.style.borderRadius="0.4em",this.readout.style.marginLeft="0.6em"),this.readout.style.color="#fff";var t=1/(2===this.mode?15:10);this.readout.style.border=t+"em solid #fff",this.readout.style.boxShadow="inset "+t+"em "+t+"em "+t+"em rgba(0,0,0,.5), inset -"+t+"em -"+t+"em "+t+"em rgba(255,255,255,.5)",this.readout.style.textAlign="center",this.readout.style.background=this.color,this.readout.style.display="inline-block",3===this.mode&&(this.el.appendChild(this.slider=document.createElement("div")),this.slider.appendChild(this.buttonWrap=document.createElement("div")),this.buttonWrap.appendChild(this.button=document.createElement("div")),this.slider.style.height=this.slider.style.borderRadius=".5em",this.slider.style.background="rgb(192,192,192)",this.slider.style.margin=".4em 0 .1em",this.slider.style.boxShadow="inset .125em .125em .125em rgba(0,0,0,.5), inset -.125em -.125em .125em rgba(255,255,255,.5)",this.slider.style.position="relative",this.slider.style.pointerEvents="auto",this.slider.dataset.slider="",this.slider.style.paddingRight=this.button.style.width=this.button.style.height=this.button.style.borderRadius="1.1em",this.button.style.position="absolute",this.button.style.left="0",this.button.style.top="-.3em",this.button.style.background="#fff",this.button.style.boxShadow="inset .3em .3em .2em -.2em rgba(255,255,255,.9), inset -.3em -.3em .2em -.2em rgba(0,0,0,.9), inset 0 0 0 .1em #777",this.button.dataset.button=""),this.stage.ui.appendChild(this.el)}}}e.Scratch2VariableWatcher=s;class i extends t.core.Stage{constructor(){super(...arguments),this.dragging={},this.defaultWatcherX=10,this.defaultWatcherY=10}createVariableWatcher(e,n){const s=this.defaultWatcherX,i=this.defaultWatcherY;return this.defaultWatcherY+=26,this.defaultWatcherY>=450&&(this.defaultWatcherY=10,this.defaultWatcherX+=150),new t.sb2.Scratch2VariableWatcher(this,e.name,{cmd:"getVar:",param:n,x:s,y:i})}say(t,e){return++this.sayId}updateBubble(){}watcherStart(t,e,n){for(var s=n.target;s&&null==s.dataset.watcher;)s=s.parentElement;if(s){var i=this.allWatchers[s.dataset.watcher];this.dragging[t]={watcher:i,offset:(null==n.target.dataset.button?-i.button.offsetWidth/2|0:i.button.getBoundingClientRect().left-e.clientX)-i.slider.getBoundingClientRect().left}}}watcherMove(t,e,n){var s=this.dragging[t];if(s){var i=s.watcher,r=i.slider.offsetWidth,o=i.button.offsetWidth,a=i.sliderMin+Math.max(0,Math.min(1,(e.clientX+s.offset)/(r-o)))*(i.sliderMax-i.sliderMin);i.target.vars[i.param]=i.isDiscrete?Math.round(a):Math.round(100*a)/100,i.update(),n.preventDefault()}}watcherEnd(t,e,n){this.watcherMove(t,e,n),delete this.dragging[t]}ontouch(t,e){const n=t.target;null==n.dataset.button&&null==n.dataset.slider||this.watcherStart(e.identifier,e,t)}onmousedown(t){const e=t.target;null==e.dataset.button&&null==e.dataset.slider||this.watcherStart("mouse",t,t)}onmousemove(t){this.watcherMove("mouse",t,t)}onmouseup(t){this.watcherEnd("mouse",t,t)}}e.Scratch2Stage=i;class r extends t.core.Sprite{_clone(){return new r(this.stage)}}e.Scratch2Sprite=r;class o extends t.io.Loader{loadImage(e){return this.addTask(new t.io.Img(e)).load()}loadFonts(){return Promise.all([this.addTask(new t.io.PromiseTask(t.utils.settled(t.fonts.loadWebFont("Donegal One")))),this.addTask(new t.io.PromiseTask(t.utils.settled(t.fonts.loadWebFont("Gloria Hallelujah")))),this.addTask(new t.io.PromiseTask(t.utils.settled(t.fonts.loadWebFont("Mystery Quest")))),this.addTask(new t.io.PromiseTask(t.utils.settled(t.fonts.loadWebFont("Permanent Marker"))))]).then((()=>{}))}loadBase(e,n){var s,o;return Promise.all([this.loadArray(e.costumes,this.loadCostume.bind(this)).then((t=>s=t)),this.loadArray(e.sounds,this.loadSound.bind(this)).then((t=>o=t))]).then((()=>{const a=new(n?i:r)(null);if(e.variables)for(const t of e.variables)t.isPersistent&&(a.isStage?a.cloudVariables.push(t.name):console.warn("Cloud variable found on a non-stage object. Skipping.")),a.vars[t.name]=t.value;if(e.lists)for(const t of e.lists)t.isPersistent&&console.warn("Cloud lists are not supported"),a.lists[t.listName]=t.contents;if(a.name=e.objName,a.costumes=s,a.currentCostumeIndex=Math.floor(e.currentCostumeIndex),o.forEach((t=>t&&a.addSound(t))),n);else{const n=a;n.scratchX=e.scratchX,n.scratchY=e.scratchY,n.direction=e.direction,n.isDraggable=e.isDraggable,n.rotationStyle=t.utils.parseRotationStyle(e.rotationStyle),n.scale=e.scale,n.visible=e.visible}return a.scripts=e.scripts||[],a}))}loadArray(t,e){return Promise.all((t||[]).map(((t,n)=>e(t,n))))}loadObject(t){return t.cmd?this.loadVariableWatcher(t):t.listName?void 0:this.loadBase(t,!1)}loadVariableWatcher(t){const e=t.target;return new s(null,e,t)}loadCostume(e){const n=[this.loadMD5(e.baseLayerMD5,e.baseLayerID).then((t=>e.$image=t))];return e.textLayerMD5&&n.push(this.loadMD5(e.textLayerMD5,e.textLayerID).then((t=>e.$text=t))),Promise.all(n).then((n=>{var s;if(n.length>1){const t=(s=document.createElement("canvas")).getContext("2d");if(!t)throw new Error("Cannot get 2d rendering context loading costume "+e.costumeName);s.width=Math.max(n[0].width,1),s.height=Math.max(n[0].height,1);for(const e of n)t.drawImage(e,0,0)}else s=n[0];return new t.core.BitmapCostume(s,{name:e.costumeName,bitmapResolution:e.bitmapResolution,rotationCenterX:e.rotationCenterX,rotationCenterY:e.rotationCenterY})}))}loadSound(e){return new Promise(((n,s)=>{this.loadMD5(e.md5,e.soundID,!0).then((s=>{n(new t.core.Sound({name:e.soundName,buffer:s}))})).catch((t=>{n(null),console.warn("Could not load sound: "+t)}))}))}loadSVG(t){const e=new DOMParser;var n=e.parseFromString(t,"image/svg+xml"),s=n.documentElement;s.style||(s=(n=e.parseFromString("<body>"+t,"text/html")).querySelector("svg")),DOMPurify.sanitize(s,{IN_PLACE:!0,USE_PROFILES:{svg:!0}}),s.style.visibility="hidden",s.style.position="absolute",s.style.left="-10000px",s.style.top="-10000px",document.body.appendChild(s);const i=s.viewBox.baseVal;i&&(i.x||i.y)&&(s.width.baseVal.value=i.width-i.x,s.height.baseVal.value=i.height-i.y,i.x=0,i.y=0,i.width=0,i.height=0),a(s,s),document.body.removeChild(s),s.style.visibility=s.style.position=s.style.left=s.style.top="";const r=document.createElement("canvas"),o=r.getContext("2d");if(!o)throw new Error("unable to get rendering context for drawing svg");return canvg.Canvg.from(o,(new XMLSerializer).serializeToString(s),{ignoreMouse:!0,ignoreAnimation:!0,ignoreClear:!0}).then((t=>t.render())).then((()=>r))}load(){var e,n;return this.loadFonts().then((()=>Promise.all([t.audio.loadSoundbankSB2(this),this.loadArray(this.projectData.children,this.loadObject.bind(this)).then((t=>e=t)),this.loadBase(this.projectData,!0).then((t=>n=t))]))).then((()=>{if(this.aborted)throw new Error("Loading aborting.");(e=e.filter((t=>t))).forEach((t=>t.stage=n));const i=e.filter((t=>t instanceof r)),o=e.filter((t=>t instanceof s));return n.children=i,n.allWatchers=o,n.allWatchers.forEach((t=>t.init())),t.sb2.compiler.compile(n),n}))}}e.BaseSB2Loader=o;e.SB2FileLoader=class extends o{constructor(t){super(),this.buffer=t}loadMD5(e,n,s=!1){const i=s?this.zip.file(n+".wav")||this.zip.file(n+".mp3"):this.zip.file(n+".gif")||this.zip.file(n+".png")||this.zip.file(n+".jpg")||this.zip.file(n+".svg");if(!i)throw new Error("cannot find md5: "+e+" (isAudio="+s+")");if(e=i.name,s)return i.async("arraybuffer").then((e=>t.audio.decodeAudio(e)));const r=e.split(".").pop();return"svg"===r?i.async("text").then((t=>this.loadSVG(t))):new Promise(((t,s)=>{var o=new Image;o.onload=function(){t(o)},o.onerror=function(){s(new Error("Failed to load image: "+e+"/"+n))},i.async("binarystring").then((t=>{o.src="data:image/"+("jpg"===r?"jpeg":r)+";base64,"+btoa(t)}))}))}load(){return JSZip.loadAsync(this.buffer).then((t=>{this.zip=t;const e=this.zip.file("project.json");if(!e)throw new Error("project.json is missing");return e.async("text")})).then((e=>{this.projectData=t.json.parse(e)})).then((()=>super.load()))}};function a(t,e){const n={"":"Helvetica",Donegal:"Donegal One",Gloria:"Gloria Hallelujah",Marker:"Permanent Marker",Mystery:"Mystery Quest"},s={Helvetica:1.13,"Donegal One":1.25,"Gloria Hallelujah":1.97,"Permanent Marker":1.43,"Mystery Quest":1.37};if(1===e.nodeType){if("text"===e.nodeName){var i=e.getAttribute("font-family")||"";(i=n[i]||i)&&(e.setAttribute("font-family",i),"Helvetica"===i&&(e.style.fontWeight="bold"));var r=+e.getAttribute("font-size");r||e.setAttribute("font-size",r=18);var o=e.getBBox(),l=e.transform.baseVal.consolidate();if(l){var h=4-.6*l.matrix.a,c=1.1*(e.getAttribute("y")-o.y);e.setAttribute("x",h),e.setAttribute("y",c);var d=e.textContent.split("\n");if(d.length>1){e.textContent=d[0];for(var u=s[i]||1,p=1,m=d.length;p<m;p++){var f=document.createElementNS(null,"tspan");f.textContent=d[p],f.setAttribute("x",""+h),f.setAttribute("y",""+(c+r*p*u)),e.appendChild(f)}}}}else(e.hasAttribute("x")||e.hasAttribute("y"))&&e.hasAttribute("transform")&&(e.setAttribute("x",0),e.setAttribute("y",0));[].forEach.call(e.childNodes,a.bind(null,t))}}e.Scratch2Loader=class extends o{constructor(t){super(),"object"==typeof t?(this.projectData=t,this.projectId=null):this.projectId=t}loadMD5(e,s,i=!1){const r=e.split(".").pop();return"svg"===r?this.addTask(new t.io.Request(n+e+"/get/")).load("text").then((t=>this.loadSVG(t))):"wav"===r?this.addTask(new t.io.Request(n+e+"/get/")).load("arraybuffer").then((e=>t.audio.decodeAudio(e))):this.loadImage(n+e+"/get/")}load(){return this.projectId?this.addTask(new t.io.Request(t.config.PROJECT_API.replace("$id",""+this.projectId))).load("json").then((t=>(this.projectData=t,super.load()))):super.load()}}}(t.sb2||(t.sb2={}))}(P||(P={})),function(t){!function(e){!function(e){class n extends t.core.Procedure{call(t){return t}}e.Scratch2Procedure=n;var s,i=["procDef","whenClicked","whenCloned","whenGreenFlag","whenIReceive","whenKeyPressed","whenSceneStarts","whenSensorGreaterThan"],r=function(t){for(var n=0;n<t.scripts.length;n++)e.compileListener(t,t.scripts[n][2])},o=function(t){s[t]=(s[t]||0)+1};e.compileListener=function(e,s){if(s[0]&&-1!==i.indexOf(s[0][0])){var r=function(){return e.fns.length+_.length},a=function(){var t=r();return _.push(L.length),C=0,t},l=function(t){L+="queue("+t+");\n",L+="return;\n"},h=function(t){L+="forceQueue("+t+");\n",L+="return;\n"},c=function(t){if(t)for(var e=0;e<t.length;e++)x(t[e])},d=function(t){return"string"!=typeof t?"getVars("+m(t)+")["+m(t)+"]":(void 0!==e.stage.vars[t]?"self":"S")+".vars["+m(t)+"]"},u=function(t){return"string"==typeof t&&(t.startsWith("☁ ")&&void 0!==e.stage.vars[t]&&e.stage.cloudVariables.indexOf(t)>-1)},p=function(t){if("string"!=typeof t)return"getLists("+m(t)+")["+m(t)+"]";var n=void 0!==e.stage.lists[t]?"self":"S";return"S"!==n||e.lists[t]||(e.lists[t]=[]),n+".lists["+m(t)+"]"},m=function(t,e,n){var s;return"number"==typeof t||"boolean"==typeof t||null===t?""+t:"string"==typeof t?'"'+t.replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/"/g,'\\"').replace(/\{/g,"\\x7b").replace(/\}/g,"\\x7d")+'"':"getParam"===t[0]?function(t,e,n){if("string"!=typeof t)throw new Error("Dynamic parameters are not supported");if(!A)return"0";var s=A.indexOf(t);if(-1===s)return"0";var i=R[s],r="%n"===i||"%d"===i||"%c"===i?"num":"%b"===i?"bool":"";if("num"===r&&e)return k[s]=!0,"C.numargs["+s+"]";if("bool"===r&&n)return k[s]=!0,"C.boolargs["+s+"]";var o="C.args["+s+"]";return e?"(+"+o+" || 0)":n?"bool("+o+")":o}(t[1],e,n):null!=(s=f(t))||null!=(s=b(t))?s:(s=function(t){return"costumeName"===t[0]?"S.getCostumeName()":"sceneName"===t[0]?"self.getCostumeName()":"readVariable"===t[0]?d(t[1]):"contentsOfList:"===t[0]?"contentsOfList("+p(t[1])+")":"getLine:ofList:"===t[0]?"getLineOfList("+p(t[2])+", "+m(t[1])+")":"concatenate:with:"===t[0]?'("" + '+m(t[1])+" + "+m(t[2])+")":"letter:of:"===t[0]?'(("" + '+m(t[2])+")[("+S(t[1])+' | 0) - 1] || "")':"answer"===t[0]?"self.answer":"getAttribute:of:"===t[0]?"attribute("+m(t[1])+", "+m(t[2])+")":"getUserId"===t[0]?"0":"getUserName"===t[0]?"self.username":void o("Undefined val: "+t[0])}(t),e?"(+"+s+" || 0)":n?"bool("+s+")":s)},f=function(t){if("xpos"===t[0])return"S.scratchX";if("ypos"===t[0])return"S.scratchY";if("heading"===t[0])return"S.direction";if("costumeIndex"===t[0])return"(S.currentCostumeIndex + 1)";if("backgroundIndex"===t[0])return"(self.currentCostumeIndex + 1)";if("scale"===t[0])return"Math.round(S.scale * 100)";if("volume"===t[0])return"(S.volume * 100)";if("tempo"===t[0])return"self.tempoBPM";if("lineCountOfList:"===t[0])return p(t[1])+".length";if("+"===t[0])return"("+S(t[1])+" + "+S(t[2])+")";if("-"===t[0])return"("+S(t[1])+" - "+S(t[2])+")";if("*"===t[0])return"("+S(t[1])+" * "+S(t[2])+")";if("/"===t[0])return"("+S(t[1])+" / "+S(t[2])+")";if("randomFrom:to:"===t[0])return"random("+S(t[1])+", "+S(t[2])+")";if("abs"===t[0])return"Math.abs("+S(t[1])+")";if("sqrt"===t[0])return"Math.sqrt("+S(t[1])+")";if("stringLength:"===t[0])return'("" + '+m(t[1])+").length";if("%"===t[0]||"\\\\"===t[0])return"mod("+S(t[1])+", "+S(t[2])+")";if("rounded"===t[0])return"Math.round("+S(t[1])+")";if("computeFunction:of:"===t[0]){if("object"!=typeof t[1]){switch(""+t[1]){case"abs":return"Math.abs("+S(t[2])+")";case"floor":return"Math.floor("+S(t[2])+")";case"sqrt":return"Math.sqrt("+S(t[2])+")";case"ceiling":return"Math.ceil("+S(t[2])+")";case"cos":return"Math.cos("+S(t[2])+" * Math.PI / 180)";case"sin":return"Math.sin("+S(t[2])+" * Math.PI / 180)";case"tan":return"Math.tan("+S(t[2])+" * Math.PI / 180)";case"asin":return"(Math.asin("+S(t[2])+") * 180 / Math.PI)";case"acos":return"(Math.acos("+S(t[2])+") * 180 / Math.PI)";case"atan":return"(Math.atan("+S(t[2])+") * 180 / Math.PI)";case"ln":return"Math.log("+S(t[2])+")";case"log":return"(Math.log("+S(t[2])+") / Math.LN10)";case"e ^":return"Math.exp("+S(t[2])+")";case"10 ^":return"Math.exp("+S(t[2])+" * Math.LN10)"}return"0"}return"mathFunc("+m(t[1])+", "+S(t[2])+")"}return"mouseX"===t[0]?"self.mouseX":"mouseY"===t[0]?"self.mouseY":"timer"===t[0]?"((runtime.now() - runtime.timerStart) / 1000)":"distanceTo:"===t[0]?"S.distanceTo("+m(t[1])+")":"soundLevel"===t[0]?(e.stage.initMicrophone(),"self.microphone.getLoudness()"):"timestamp"===t[0]?"((Date.now() - epoch) / 86400000)":"timeAndDate"===t[0]?"timeAndDate("+m(t[1])+")":void 0},g=/\d/,b=function(e){if("list:contains:"===e[0])return"listContains("+p(e[1])+", "+m(e[2])+")";if("<"===e[0]||">"===e[0]){var n;let t,i;"string"==typeof e[1]&&g.test(e[1])||"number"==typeof e[1]?(n="<"===e[0],t=e[1],i=e[2]):("string"==typeof e[2]&&g.test(e[2])||"number"==typeof e[2])&&(n=">"===e[0],t=e[2],i=e[1]);var s=+t;return null==t||s!=s?"(compare("+m(e[1])+", "+m(e[2])+") === "+("<"===e[0]?-1:1)+")":(n?"numLess":"numGreater")+"("+s+", "+m(i)+")"}if("="===e[0]){let t,n;"string"==typeof e[1]&&g.test(e[1])||"number"==typeof e[1]?(t=e[1],n=e[2]):("string"==typeof e[2]&&g.test(e[2])||"number"==typeof e[2])&&(t=e[2],n=e[1]);s=+t;return null==t||s!=s?"(equal("+m(e[1])+", "+m(e[2])+"))":"(numEqual("+s+", "+m(n)+"))"}return"&"===e[0]?"("+w(e[1])+" && "+w(e[2])+")":"|"===e[0]?"("+w(e[1])+" || "+w(e[2])+")":"not"===e[0]?"!"+w(e[1]):"mousePressed"===e[0]?"self.mousePressed":"touching:"===e[0]?"S.touching("+m(e[1])+")":"touchingColor:"===e[0]?"S.touchingColor("+m(e[1])+")":"color:sees:"===e[0]?"S.colorTouchingColor("+m(e[1])+", "+m(e[2])+")":"keyPressed:"===e[0]?"!!self.keys["+("object"==typeof e[1]?"getKeyCode("+m(e[1])+")":m(t.runtime.getKeyCode(e[1])))+"]":void 0},w=function(t){if("boolean"==typeof t)return t;if("number"==typeof t||"string"==typeof t)return 0!=+t&&""!==t&&"false"!==t;var e=b(t);return null!=e?e:m(t,!1,!0)},S=function(t){if("number"==typeof t)return t||0;if("boolean"==typeof t||"string"==typeof t)return+t||0;var e=f(t);return null!=e?e:m(t,!0)},E=function(t){L+="save();\n",L+="R.start = runtime.now();\n",L+="R.duration = "+S(t)+" * 60 / self.tempoBPM;\n",L+="var first = !WARP;\n"},y=function(){var t=a();L+="if (!R.sound) R.sound = { stopped: false };",L+="S.activeSounds.add(R.sound);\n",L+="if ((runtime.now() - R.start < R.duration * 1000 || first) && !R.sound.stopped) {\n",L+="  var first;\n",h(t),L+="}\n",L+="S.activeSounds.delete(R.sound);",L+="restore();\n"},v="S.penColor.toHSLA();\n";v+="S.penColor.a = 1;\n";var C=0,x=function(n){if(-1!==["turnRight:","turnLeft:","heading:","pointTowards:","setRotationStyle","lookLike:","nextCostume","say:duration:elapsed:from:","say:","think:duration:elapsed:from:","think:","changeGraphicEffect:by:","setGraphicEffect:to:","filterReset","changeSizeBy:","setSizeTo:","comeToFront","goBackByLayers:"].indexOf(n[0])?C<2?(L+="if (S.visible) VISUAL = true;\n",C=2):t.config.debug&&(L+="/* visual: 2 */\n"):-1!==["forward:","gotoX:y:","gotoSpriteOrMouse:","changeXposBy:","xpos:","changeYposBy:","ypos:","bounceOffEdge","glideSecs:toX:y:elapsed:from:"].indexOf(n[0])?C<1?(L+="if (S.visible || S.isPenDown) VISUAL = true;\n",C=1):t.config.debug&&(L+="/* visual: 1 */\n"):-1!==["showBackground:","startScene","nextBackground","nextScene","startSceneAndWait","show","hide","putPenDown","stampCostume","showVariable:","hideVariable:","doAsk","setVolumeTo:","changeVolumeBy:","setTempoTo:","changeTempoBy:"].indexOf(n[0])&&(C<3?(L+="VISUAL = true;\n",C=3):t.config.debug&&(L+="/* visual: 3 */\n")),"forward:"===n[0])L+="S.forward("+S(n[1])+");\n";else if("turnRight:"===n[0])L+="S.setDirection(S.direction + "+S(n[1])+");\n";else if("turnLeft:"===n[0])L+="S.setDirection(S.direction - "+S(n[1])+");\n";else if("heading:"===n[0])L+="S.setDirection("+S(n[1])+");\n";else if("pointTowards:"===n[0])L+="S.pointTowards("+m(n[1])+");\n";else if("gotoX:y:"===n[0])L+="S.moveTo("+S(n[1])+", "+S(n[2])+");\n";else if("gotoSpriteOrMouse:"===n[0])L+="S.gotoObject("+m(n[1])+");\n";else if("changeXposBy:"===n[0])L+="S.moveTo(S.scratchX + "+S(n[1])+", S.scratchY);\n";else if("xpos:"===n[0])L+="S.moveTo("+S(n[1])+", S.scratchY);\n";else if("changeYposBy:"===n[0])L+="S.moveTo(S.scratchX, S.scratchY + "+S(n[1])+");\n";else if("ypos:"===n[0])L+="S.moveTo(S.scratchX, "+S(n[1])+");\n";else if("bounceOffEdge"===n[0])L+="S.bounceOffEdge();\n";else if("setRotationStyle"===n[0])L+="S.rotationStyle = P.utils.parseRotationStyle("+m(n[1])+");\n";else if("lookLike:"===n[0])L+="S.setCostume("+m(n[1])+");\n";else if("nextCostume"===n[0])L+="S.showNextCostume();\n";else if("showBackground:"===n[0]||"startScene"===n[0])L+="self.setCostume("+m(n[1])+");\n",L+="var threads = sceneChange();\n",L+="if (threads.indexOf(BASE) !== -1) {return;}\n";else if("nextBackground"===n[0]||"nextScene"===n[0])L+="S.showNextCostume();\n",L+="var threads = sceneChange();\n",L+="if (threads.indexOf(BASE) !== -1) {return;}\n";else if("startSceneAndWait"===n[0]){L+="save();\n",L+="self.setCostume("+m(n[1])+");\n",L+="R.threads = sceneChange();\n",L+="if (R.threads.indexOf(BASE) !== -1) {return;}\n";var s=a();L+="if (!running(R.threads)) {\n",h(s),L+="}\n",L+="restore();\n"}else if("say:duration:elapsed:from:"===n[0]){L+="save();\n",L+="R.id = S.say("+m(n[1])+", false);\n",L+="R.start = runtime.now();\n",L+="R.duration = "+S(n[2])+";\n",L+="var first = !WARP;\n";s=a();L+="if (runtime.now() - R.start < R.duration * 1000 || first) {\n",L+="  var first;\n",h(s),L+="}\n",L+="if (S.sayId === R.id) {\n",L+='  S.say("");\n',L+="}\n",L+="restore();\n"}else if("say:"===n[0])L+="S.say("+m(n[1])+", false);\n";else if("think:duration:elapsed:from:"===n[0]){L+="save();\n",L+="R.id = S.say("+m(n[1])+", true);\n",L+="R.start = runtime.now();\n",L+="R.duration = "+S(n[2])+";\n",L+="var first = !WARP;\n";s=a();L+="if (runtime.now() - R.start < R.duration * 1000 || first) {\n",L+="  var first;\n",h(s),L+="}\n",L+="if (S.sayId === R.id) {\n",L+='  S.say("");\n',L+="}\n",L+="restore();\n"}else if("think:"===n[0])L+="S.say("+m(n[1])+", true);\n";else if("changeGraphicEffect:by:"===n[0])L+="S.changeFilter("+m(n[1])+", "+S(n[2])+");\n";else if("setGraphicEffect:to:"===n[0])L+="S.setFilter("+m(n[1])+", "+S(n[2])+");\n";else if("filterReset"===n[0])L+="S.resetFilters();\n";else if("changeSizeBy:"===n[0])L+="var f = S.scale + "+S(n[1])+" / 100;\n",L+="S.scale = f < 0 ? 0 : f;\n";else if("setSizeTo:"===n[0])L+="var f = "+S(n[1])+" / 100;\n",L+="S.scale = f < 0 ? 0 : f;\n";else if("show"===n[0])L+="S.visible = true;\n",L+="if (S.saying) S.updateBubble();\n";else if("hide"===n[0])L+="S.visible = false;\n",L+="if (S.saying) S.updateBubble();\n";else if("comeToFront"===n[0])L+="var i = self.children.indexOf(S);\n",L+="if (i !== -1) self.children.splice(i, 1);\n",L+="self.children.push(S);\n";else if("goBackByLayers:"===n[0])L+="var i = self.children.indexOf(S);\n",L+="if (i !== -1) {\n",L+="  self.children.splice(i, 1);\n",L+="  self.children.splice(Math.max(0, i - "+S(n[1])+"), 0, S);\n",L+="}\n";else if("setVideoState"===n[0])L+="switch ("+m(n[1])+") {",L+='  case "off": self.showVideo(false); break;',L+='  case "on": self.showVideo(true); break;',L+="}";else if("playSound:"===n[0])t.audio.context&&(L+="var sound = S.getSound("+m(n[1])+");\n",L+="if (sound) startSound(sound);\n");else if("doPlaySoundAndWait"===n[0]){if(t.audio.context){L+="var sound = S.getSound("+m(n[1])+");\n",L+="if (sound) {\n",L+="  save();\n",L+="  R.sound = playSound(sound);\n",L+="  S.activeSounds.add(R.sound);\n",L+="  R.start = runtime.now();\n",L+="  R.duration = sound.duration;\n",L+="  var first = true;\n";s=a();L+="  if ((runtime.now() - R.start < R.duration * 1000 || first) && !R.sound.stopped) {\n",L+="    var first;\n",h(s),L+="  }\n",L+="  S.activeSounds.delete(R.sound);\n",L+="  restore();\n",L+="}\n"}}else if("stopAllSounds"===n[0])t.audio.context&&(L+="self.stopAllSounds();\n");else if("playDrum"===n[0])E(n[2]),t.audio.context&&(L+="R.sound = playSpan(DRUMS[Math.round("+S(n[1])+") - 1] || DRUMS[2], 60, 10);\n"),y();else if("rest:elapsed:from:"===n[0])E(n[1]),y();else if("noteOn:duration:elapsed:from:"===n[0])E(n[2]),t.audio.context&&(L+="R.sound = playNote("+S(n[1])+", R.duration);\n"),y();else if("instrument:"===n[0])L+="S.instrument = Math.max(0, Math.min(INSTRUMENTS.length - 1, "+S(n[1])+" - 1)) | 0;";else if("changeVolumeBy:"===n[0]||"setVolumeTo:"===n[0])L+="S.volume = Math.min(1, Math.max(0, "+("changeVolumeBy:"===n[0]?"S.volume + ":"")+S(n[1])+" / 100));\n",L+="if (S.node) S.node.gain.value = S.volume;\n";else if("changeTempoBy:"===n[0])L+="self.tempoBPM += "+S(n[1])+";\n";else if("setTempoTo:"===n[0])L+="self.tempoBPM = "+S(n[1])+";\n";else if("clearPenTrails"===n[0])L+="self.clearPen();\n";else if("putPenDown"===n[0])L+="S.isPenDown = true;\n",L+="S.dotPen();\n";else if("putPenUp"===n[0])L+="S.isPenDown = false;\n";else if("penColor:"===n[0])L+="S.penColor.setRGBA("+S(n[1])+");\n";else if("setPenHueTo:"===n[0])L+=v,L+="S.penColor.x = "+S(n[1])+" * 360 / 200;\n",L+="S.penColor.y = 100;\n";else if("changePenHueBy:"===n[0])L+=v,L+="S.penColor.x += "+S(n[1])+" * 360 / 200;\n",L+="S.penColor.y = 100;\n";else if("setPenShadeTo:"===n[0])L+=v,L+="S.penColor.z = "+S(n[1])+" % 200;\n",L+="if (S.penColor.z < 0) S.penColor.z += 200;\n",L+="S.penColor.y = 100;\n";else if("changePenShadeBy:"===n[0])L+=v,L+="S.penColor.z = (S.penColor.z + "+S(n[1])+") % 200;\n",L+="if (S.penColor.z < 0) S.penColor.z += 200;\n",L+="S.penColor.y = 100;\n";else if("penSize:"===n[0])L+="var f = "+S(n[1])+";\n",L+="S.penSize = f < 1 ? 1 : f;\n";else if("changePenSizeBy:"===n[0])L+="var f = S.penSize + "+S(n[1])+";\n",L+="S.penSize = f < 1 ? 1 : f;\n";else if("stampCostume"===n[0])L+="S.stamp();\n";else if("setVar:to:"===n[0])L+=d(n[1])+" = "+m(n[2])+";\n",u(n[1])&&(L+="cloudVariableChanged("+m(n[1])+");\n");else if("changeVar:by:"===n[0]){var i=d(n[1]);L+=i+" = (+"+i+" || 0) + "+S(n[2])+";\n",u(n[1])&&(L+="cloudVariableChanged("+m(n[1])+");\n")}else if("append:toList:"===n[0])L+="appendToList("+p(n[2])+", "+m(n[1])+");\n";else if("deleteLine:ofList:"===n[0])L+="deleteLineOfList("+p(n[2])+", "+m(n[1])+");\n";else if("insert:at:ofList:"===n[0])L+="insertInList("+p(n[3])+", "+m(n[2])+", "+m(n[1])+");\n";else if("setLine:ofList:to:"===n[0])L+="setLineOfList("+p(n[2])+", "+m(n[1])+", "+m(n[3])+");\n";else if("showVariable:"===n[0]||"hideVariable:"===n[0]){var f="showVariable:"===n[0];if("string"==typeof n[1]){var g=void 0!==e.vars[n[1]]?"S":"self";L+=g+".showVariable("+m(n[1])+", "+f+");\n"}else o("ignoring dynamic variable")}else if("broadcast:"===n[0])L+="var threads = broadcast("+m(n[1])+");\n",L+="if (threads.indexOf(BASE) !== -1) {STOPPED = true;}\n";else if("call"===n[0])if(t.config.debug&&"phosphorus: debug"===n[1])L+="debugger;\n";else{L+="call(S.procedures["+m(n[1])+"], "+r()+", [";for(var b=2;b<n.length;b++)b>2&&(L+=", "),L+=m(n[b]);L+="]);\n",L+="return;\n",a()}else if("doBroadcastAndWait"===n[0]){L+="save();\n",L+="R.threads = broadcast("+m(n[1])+");\n",L+="if (R.threads.indexOf(BASE) !== -1) {return;}\n";s=a();L+="if (running(R.threads)) {\n",h(s),L+="}\n",L+="restore();\n"}else if("doForever"===n[0]){s=a();c(n[1]),h(s)}else if("doForeverIf"===n[0]){s=a();L+="if ("+w(n[1])+") {\n",c(n[2]),L+="}\n",h(s)}else if("doIf"===n[0])L+="if ("+w(n[1])+") {\n",c(n[2]),L+="}\n";else if("doIfElse"===n[0])L+="if ("+w(n[1])+") {\n",c(n[2]),L+="} else {\n",c(n[3]),L+="}\n";else if("doRepeat"===n[0]){L+="save();\n",L+="R.count = "+S(n[1])+";\n";s=a();L+="if (R.count >= 0.5) {\n",L+="  R.count -= 1;\n",c(n[2]),l(s),L+="} else {\n",L+="  restore();\n",L+="}\n"}else if("doReturn"===n[0])L+="endCall();\n",L+="return;\n";else if("doUntil"===n[0]){s=a();L+="if (!"+w(n[1])+") {\n",c(n[2]),l(s),L+="}\n"}else if("doWhile"===n[0]){s=a();L+="if ("+w(n[1])+") {\n",c(n[2]),l(s),L+="}\n"}else if("doWaitUntil"===n[0]){s=a();L+="if (!"+w(n[1])+") {\n",h(s),L+="}\n"}else if("glideSecs:toX:y:elapsed:from:"===n[0]){L+="save();\n",L+="R.start = runtime.now();\n",L+="R.duration = "+S(n[1])+";\n",L+="R.baseX = S.scratchX;\n",L+="R.baseY = S.scratchY;\n",L+="R.deltaX = "+S(n[2])+" - S.scratchX;\n",L+="R.deltaY = "+S(n[3])+" - S.scratchY;\n";s=a();L+="var f = (runtime.now() - R.start) / (R.duration * 1000);\n",L+="if (f > 1 || isNaN(f)) f = 1;\n",L+="S.moveTo(R.baseX + f * R.deltaX, R.baseY + f * R.deltaY);\n",L+="if (f < 1) {\n",h(s),L+="}\n",L+="restore();\n"}else if("stopAll"===n[0])L+="runtime.stopAll();\n",L+="return;\n";else if("stopScripts"===n[0])L+="switch ("+m(n[1])+") {\n",L+='  case "all":\n',L+="    runtime.stopAll();\n",L+="    return;\n",L+='  case "this script":\n',L+="    endCall();\n",L+="    return;\n",L+='  case "other scripts in sprite":\n',L+='  case "other scripts in stage":\n',L+="    S.stopSoundsExcept(BASE);\n",L+="    for (var i = 0; i < runtime.queue.length; i++) {\n",L+="      if (i !== THREAD && runtime.queue[i] && runtime.queue[i].sprite === S) {\n",L+="        runtime.queue[i].stopped = true;\n",L+="        runtime.queue[i].fn = undefined;\n",L+="      }\n",L+="    }\n",L+="    break;\n",L+="}\n";else if("wait:elapsed:from:"===n[0])!function(t){L+="save();\n",L+="R.start = runtime.now();\n",L+="R.duration = "+t+";\n",L+="var first = !WARP;\n";var e=a();L+="if (runtime.now() - R.start < R.duration * 1000 || first) {\n",L+="  var first;\n",h(e),L+="}\n",L+="restore();\n"}(S(n[1]));else if("warpSpeed"===n[0])L+="WARP++;\n",c(n[1]),L+="WARP--;\n";else if("createCloneOf"===n[0])L+="clone("+m(n[1])+");\n";else if("deleteClone"===n[0])L+="if (S.isClone) {\n",L+="  S.remove();\n",L+="  var i = self.children.indexOf(S);\n",L+="  if (i !== -1) self.children.splice(i, 1);\n",L+="  for (var i = 0; i < runtime.queue.length; i++) {\n",L+="    if (runtime.queue[i] && runtime.queue[i].sprite === S) {\n",L+="      runtime.queue[i] = undefined;\n",L+="    }\n",L+="  }\n",L+="  return;\n",L+="}\n";else if("doAsk"===n[0]){L+="R.id = self.nextPromptId++;\n";s=a();L+="if (self.promptId < R.id) {\n",h(s),L+="}\n",L+="S.ask("+m(n[1])+");\n";s=a();L+="if (self.promptId === R.id) {\n",h(s),L+="}\n"}else"timerReset"===n[0]?L+="runtime.timerStart = runtime.now();\n":o("Undefined command: "+n[0])},L="",I=e.fns.length,_=[0];if("procDef"===s[0][0])var A=s[0][2],R=s[0][1].match(/%[snmdcb]/g)||[],k=[];for(let t=1;t<s.length;t++)x(s[t]);if("procDef"===s[0][0]){let t="";for(let e=R.length;e--;)if(k[e]){const n=R[e];"%d"===n||"%n"===n||"%c"===n?t+="C.numargs["+e+"] = +C.args["+e+"] || 0;\n":"%b"===n&&(t+="C.boolargs["+e+"] = bool(C.args["+e+"]);\n")}L=t+L;for(let e=1,n=_.length;e<n;++e)_[e]+=t.length;L+="endCall();\n",L+="return;\n"}for(let n=0;n<_.length;n++)e.fns.push(t.runtime.createContinuation(L.slice(_[n])));var T=e.fns[I];if("whenClicked"===s[0][0])e.listeners.whenClicked.push(T);else if("whenGreenFlag"===s[0][0])e.listeners.whenGreenFlag.push(T);else if("whenCloned"===s[0][0])e.listeners.whenCloned.push(T);else if("whenIReceive"===s[0][0]){var P=s[0][1].toLowerCase();(e.listeners.whenIReceive[P]||(e.listeners.whenIReceive[P]=[])).push(T)}else if("whenKeyPressed"===s[0][0]){const n=t.runtime.getKeyCode(s[0][1]);e.addWhenKeyPressedHandler(n,T)}else if("whenSceneStarts"===s[0][0]){P=s[0][1].toLowerCase();(e.listeners.whenSceneStarts[P]||(e.listeners.whenSceneStarts[P]=[])).push(T)}else if("procDef"===s[0][0]){const t=s[0][4],i=s[0][1];e.procedures[i]?o("procedure already exists: "+i):e.procedures[i]=new n(T,t,A)}else o("Undefined event: "+s[0][0]);if(t.config.debug){var M=s[0][0];"procDef"===M&&(M+=":"+s[0][1]),console.log("compiled sb2 script",M,L)}}},e.compile=function(t){s=Object.create(null),r(t);for(var e=0;e<t.children.length;e++)r(t.children[e]);for(var n in s)console.warn(n+(s[n]>1?" (repeated "+s[n]+" times)":""))}}(e.compiler||(e.compiler={}))}(t.sb2||(t.sb2={}))}(P||(P={})),function(t){!function(e){e.ASSETS_API="https://assets.scratch.mit.edu/internalapi/asset/$md5ext/get/";class n extends t.core.Stage{constructor(){super(...arguments),this.listIds={},this.varIds={}}}e.Scratch3Stage=n;class s extends t.core.Sprite{constructor(){super(...arguments),this.listIds={},this.varIds={}}_clone(){return new s(this.stage)}}e.Scratch3Sprite=s;class i extends t.core.Watcher{constructor(e,n){super(e,n.spriteName||""),this.id=n.id,this.opcode=n.opcode,this.mode=n.mode,this.params=n.params,this.libraryEntry=t.sb3.compiler.watcherLibrary[this.opcode],this.x=n.x,this.y=n.y,this.visible="boolean"!=typeof n.visible||n.visible,this.sliderMin=n.sliderMin||0,this.sliderMax=n.sliderMax||0,void 0!==n.isDiscrete?this.sliderStep=n.isDiscrete?1:.01:this.sliderStep=1,this.libraryEntry||(console.warn("unknown watcher",this.opcode,this),this.valid=!1)}update(){if(this.visible){const t=this.getValue();this.valueEl.textContent!==t&&(this.valueEl.textContent=t),this.sliderInput&&(this.sliderInput.value=t)}}init(){super.init(),this.libraryEntry.init&&this.libraryEntry.init(this),this.updateLayout()}setVisible(t){super.setVisible(t),this.updateLayout()}getLabel(){const t=this.libraryEntry.getLabel(this);return this.target.isStage?t:this.targetName+": "+t}getValue(){const t=this.libraryEntry.evaluate(this);return"number"==typeof t?""+Math.round(1e6*t)/1e6:""+t}setValue(t){this.libraryEntry.set&&(this.libraryEntry.set(this,t),this.update())}updateLayout(){if(this.containerEl)return void(this.containerEl.style.display=this.visible?"flex":"none");if(!this.visible)return;const t=document.createElement("div");t.classList.add("s3-watcher-container"),t.dataset.opcode=this.opcode,t.style.top=this.y/10+"em",t.style.left=this.x/10+"em",t.onmousedown=t=>t.stopPropagation(),t.ontouchstart=t=>t.stopPropagation();const e=document.createElement("div");e.classList.add("s3-watcher-value"),e.textContent=this.getValue(),this.containerEl=t,this.valueEl=e,this.stage.ui.appendChild(t);const n=this.mode;if("large"===n)t.classList.add("s3-watcher-large"),t.appendChild(e);else{const s=document.createElement("div");s.classList.add("s3-watcher-row"),s.classList.add("s3-watcher-row-normal");const i=document.createElement("div");if(i.classList.add("s3-watcher-label"),i.textContent=this.getLabel(),s.appendChild(i),s.appendChild(e),t.classList.add("s3-watcher-container-normal"),t.appendChild(s),"slider"===n){const e=document.createElement("div");e.classList.add("s3-watcher-row-slider");const n=document.createElement("input");n.type="range",n.min=""+this.sliderMin,n.max=""+this.sliderMax,n.step=""+this.sliderStep,n.value=this.getValue(),n.addEventListener("input",this.sliderChanged.bind(this)),this.sliderInput=n,e.appendChild(n),t.appendChild(e)}}}sliderChanged(t){const e=+t.target.value;this.setValue(e)}}e.Scratch3VariableWatcher=i;class r{constructor(){this.value="",this.index=-1,this.y=0,this.visible=!0,this.element=document.createElement("div"),this.indexEl=document.createElement("div"),this.valueEl=document.createElement("div"),this.element.className="s3-list-row",this.indexEl.className="s3-list-index",this.valueEl.className="s3-list-value",this.element.appendChild(this.indexEl),this.element.appendChild(this.valueEl)}setValue(t){t!==this.value&&(this.value=t,this.valueEl.textContent=t)}setIndex(t){t!==this.index&&(this.index=t,this.indexEl.textContent=(t+1).toString())}setY(t){t!==this.y&&(this.y=t,this.element.style.transform="translateY("+t+"px)")}setVisible(t){this.visible!==t&&(this.visible=t,this.element.style.display=t?"":"none")}}e.ListWatcherRow=r;class o extends t.core.Watcher{constructor(t,e){super(t,e.spriteName||""),this.rows=[],this.firstUpdateComplete=!1,this._rowHeight=-1,this.scrollTop=0,this.lastZoomLevel=1,this.scrollAhead=8,this.scrollBack=3,this.scrollDirection=1,this._contentHeight=-1,this.id=e.id,this.params=e.params,this.x=e.x,this.y=e.y,this.visible="boolean"!=typeof e.visible||e.visible,this.width=e.width||100,this.height=e.height||200}shouldUpdate(){return!!this.visible&&(this.lastZoomLevel!==this.stage.zoom||(!this.firstUpdateComplete||this.list.modified))}update(){if(!this.shouldUpdate())return;this.lastZoomLevel!==this.stage.zoom&&(this.contentEl.scrollTop*=this.stage.zoom/this.lastZoomLevel),this.list.modified=!1,this.lastZoomLevel=this.stage.zoom,this.firstUpdateComplete=!0,this.updateList();const t=this.getBottomLabel();this.bottomLabelEl.textContent!==t&&(this.bottomLabelEl.textContent=this.getBottomLabel())}updateList(){if(!this.visible&&-1===this._rowHeight)return;const t=this.list.length*this.getRowHeight()*this.stage.zoom;this.endpointEl.style.transform="translateY("+t+"px)";const e=this.scrollTop,n=e+this.getContentHeight();let s=Math.floor(e/this.getRowHeight()),i=Math.ceil(n/this.getRowHeight());1===this.scrollDirection?(s-=this.scrollBack,i+=this.scrollAhead):(s-=this.scrollAhead,i+=this.scrollBack),s<0&&(s=0),i>this.list.length-1&&(i=this.list.length-1),i-s>50&&(i=s+50);const r=i-s;for(;this.rows.length<=r;)this.addRow();for(var o=s,a=0;o<=i;o++,a++){let t=this.rows[a];t.setIndex(o),t.setValue(this.list[o]),t.setY(o*this._rowHeight*this.stage.zoom),t.setVisible(!0)}for(;a<this.rows.length;)this.rows[a].setVisible(!1),a++}init(){super.init();const t=this.target,e=this.id,n=t.listIds[e];n in this.target.lists||(this.target.lists[n]=l()),this.list=this.target.lists[n],this.target.listWatchers[n]=this,this.visible&&this.updateLayout()}getTopLabel(){return this.target.isStage?this.params.LIST:this.target.name+": "+this.params.LIST}getBottomLabel(){return"length "+this.list.length}getContentHeight(){return-1===this._contentHeight&&(this._contentHeight=this.contentEl.offsetHeight),this._contentHeight}getRowHeight(){if(-1===this._rowHeight){const t=2;0===this.rows.length&&this.addRow();const e=this.rows[0].element.offsetHeight/this.stage.zoom;if(0===e)return 0;this._rowHeight=e+t}return this._rowHeight}addRow(){const t=new r;return this.rows.push(t),this.contentEl.appendChild(t.element),t}updateLayout(){if(!this.containerEl){if(!this.visible)return;this.createLayout()}this.containerEl.style.display=this.visible?"":"none"}setVisible(t){super.setVisible(t),this.updateLayout()}createLayout(){this.containerEl=document.createElement("div"),this.topLabelEl=document.createElement("div"),this.bottomLabelEl=document.createElement("div"),this.middleContainerEl=document.createElement("div"),this.contentEl=document.createElement("div"),this.containerEl.style.top=this.y/10+"em",this.containerEl.style.left=this.x/10+"em",this.containerEl.style.height=this.height/10+"em",this.containerEl.style.width=this.width/10+"em",this.containerEl.classList.add("s3-list-container"),this.containerEl.onmousedown=t=>t.stopPropagation(),this.containerEl.ontouchstart=t=>t.stopPropagation(),this.topLabelEl.textContent=this.getTopLabel(),this.topLabelEl.classList.add("s3-list-top-label"),this.bottomLabelEl.textContent=this.getBottomLabel(),this.bottomLabelEl.classList.add("s3-list-bottom-label"),this.middleContainerEl.classList.add("s3-list-content"),this.contentEl.classList.add("s3-list-rows"),this.contentEl.addEventListener("scroll",(t=>{const e=this.contentEl.scrollTop/this.stage.zoom,n=this.scrollTop-e;n<0?this.scrollDirection=1:n>0&&(this.scrollDirection=0),this.scrollTop=e,this.updateList()})),this.endpointEl=document.createElement("div"),this.endpointEl.className="s3-list-endpoint",this.contentEl.appendChild(this.endpointEl),this.middleContainerEl.appendChild(this.contentEl),this.containerEl.appendChild(this.topLabelEl),this.containerEl.appendChild(this.middleContainerEl),this.containerEl.appendChild(this.bottomLabelEl),this.stage.ui.appendChild(this.containerEl)}}e.Scratch3ListWatcher=o;class a extends t.core.Procedure{call(t){const e={};for(var n=0;n<this.inputs.length;n++)e[this.inputs[n]]=t[n];return e}}function l(){const t=[];return t.modified=!1,t.toString=function(){for(var t=this.length;t--;)if(1!==(""+this[t]).length)return this.join(" ");return this.join("")},t}e.Scratch3Procedure=a,e.createList=l;const h="http://www.w3.org/2000/svg";function c(e,n){if(e.namespaceURI!==h&&(e=function(t){const e=document.implementation.createHTMLDocument().createElementNS(h,"svg");for(const n of t.attributes)e.setAttribute(n.name,n.value);return e.innerHTML=t.innerHTML,e}(e)).firstElementChild&&"g"!==e.firstElementChild.tagName){const t=e.width.baseVal,s=e.height.baseVal;if(t.unitType!==t.SVG_LENGTHTYPE_PERCENTAGE&&s.unitType!==t.SVG_LENGTHTYPE_PERCENTAGE){const i=document.createElementNS(h,"g"),r=e.createSVGTransform();for(const t of e.children)i.appendChild(t);r.setTranslate(-t.value/2,s.value/2),i.transform.baseVal.appendItem(r),n.rotationCenterX-=t.value/2,n.rotationCenterY+=s.value/2,e.appendChild(i)}}if(e.hasAttribute("viewBox")){const t=e.getAttribute("viewBox").split(/ |,/).map((t=>+t));if(t.every((t=>!isNaN(t)))&&4===t.length){const[n,s,i,r]=t,o=Math.max(1,i+n),a=Math.max(1,r+s);e.setAttribute("width",o.toString()),e.setAttribute("height",a.toString())}else console.warn("weird viewBox",e.getAttribute("viewBox"));e.removeAttribute("viewBox")}const s=e.querySelectorAll("text"),i=[],r=t=>{-1===i.indexOf(t)&&i.push(t)};for(var o=0;o<s.length;o++){const e=s[o];let n=(e.getAttribute("font-family")||"").split(",").map((t=>t.trim())),i=!1;for(const e of n){if(t.fonts.scratch3[e]){i=!0,r(e);break}if("sans-serif"===e){i=!0;break}}if(!i){console.warn("unknown fonts",n);const t="Sans Serif";r(t),e.setAttribute("font-family",t)}}t.fonts.addFontRules(e,i);let a=document.createElement("style");return a.appendChild(document.createTextNode("image { image-rendering: pixelated; }")),e.appendChild(a),e}class d extends t.io.Loader{constructor(){super(...arguments),this.needsMusic=!1}getSVG(t,e){return this.getAsText(t).then((n=>{const s=c((new DOMParser).parseFromString(n,"image/svg+xml").documentElement,e);return new Promise(((e,n)=>{const i=new Image;i.onload=t=>{e(i)},i.onerror=e=>{n(new Error("Failed to load SVG: "+t))},i.src="data:image/svg+xml,"+encodeURIComponent((new XMLSerializer).serializeToString(s))}))}))}getBitmapImage(t,e){return this.getAsImage(t,e)}loadCostume(e,n){const s=e.assetId+"."+e.dataFormat,i={name:e.name,bitmapResolution:e.bitmapResolution||1,rotationCenterX:e.rotationCenterX,rotationCenterY:e.rotationCenterY};return"svg"===e.dataFormat?this.getSVG(s,i).then((e=>new t.core.VectorCostume(e,i))):this.getBitmapImage(s,e.dataFormat).then((e=>new t.core.BitmapCostume(e,i)))}getAudioBuffer(e){return this.getAsArrayBuffer(e).then((e=>t.audio.decodeAudio(e))).catch((t=>{throw new Error(`Could not load audio: ${e} (${t})`)}))}loadSound(e){return new Promise(((n,s)=>{this.getAudioBuffer(e.md5ext).then((s=>{n(new t.core.Sound({name:e.name,buffer:s}))})).catch((t=>{console.warn("Could not load sound: "+t),n(null)}))}))}loadWatcher(t,e){return"list"===t.mode?new o(e,t):new i(e,t)}loadTarget(e){const i=new(e.isStage?n:s)(null);for(const t of Object.keys(e.variables)){const n=e.variables[t],s=n[0],r=n[1];if(n.length>2){n[2]&&(e.isStage?i.cloudVariables.push(s):console.warn("Cloud variable found on a non-stage object. Skipping."))}i.vars[s]=r,i.varIds[t]=s}for(const t of Object.keys(e.lists)){const n=e.lists[t],s=n[0],o=n[1];if(i.lists[s])continue;const a=l();for(var r=0;r<o.length;r++)a[r]=o[r];i.lists[s]=a,i.listIds[t]=s}if(i.name=e.name,i.currentCostumeIndex=e.currentCostume,"volume"in e&&(i.volume=e.volume/100),i.sb3data=e,i.isStage);else{const n=i;n.scratchX=e.x,n.scratchY=e.y,n.visible=e.visible,n.direction=e.direction,n.scale=e.size/100,n.isDraggable=e.draggable,n.rotationStyle=t.utils.parseRotationStyle(e.rotationStyle)}const o=Promise.all(e.costumes.map(((t,e)=>this.loadCostume(t,e)))),a=Promise.all(e.sounds.map((t=>this.loadSound(t))));return Promise.all([o,a]).then((t=>{const e=t[0],n=t[1];return i.costumes=e,n.forEach((t=>t&&i.addSound(t))),i}))}loadRequiredAssets(){return Promise.all([this.loadFonts()])}loadSoundbank(){return t.audio.loadSoundbankSB2(this)}loadFonts(){const e=[];for(const n in t.fonts.scratch3){const s=t.utils.settled(t.fonts.loadLocalFont(n,t.fonts.scratch3[n]));e.push(s),this.addTask(new t.io.PromiseTask(s))}return Promise.all(e)}compileTargets(e,n){t.config.debug&&console.time("Scratch 3 compile");for(const n of e){const e=new t.sb3.compiler.Compiler(n);e.compile(),e.needsMusic&&(this.needsMusic=!0)}t.config.debug&&console.timeEnd("Scratch 3 compile")}async load(){if(!this.projectData)throw new Error("Project data is missing or invalid");if(!Array.isArray(this.projectData.targets))throw new Error("Invalid project data: missing targets");await this.loadRequiredAssets(),this.resetTasks();const t=await Promise.all(this.projectData.targets.sort(((t,e)=>t.layerOrder-e.layerOrder)).map((t=>this.loadTarget(t))));if(this.aborted)throw new Error("Loading aborting.");const e=t.filter((t=>t.isStage))[0];if(!e)throw new Error("Project does not have a Stage");const n=t.filter((t=>t.isSprite));return n.forEach((t=>t.stage=e)),e.children=n,this.projectData.monitors&&(e.allWatchers=this.projectData.monitors.map((t=>this.loadWatcher(t,e))).filter((t=>t&&t.valid)),e.allWatchers.forEach((t=>t.init()))),this.compileTargets(t,e),this.needsMusic&&await this.loadSoundbank(),this.projectData=null,e}}e.BaseSB3Loader=d;e.SB3FileLoader=class extends d{constructor(t){super(),this.buffer=t}getAsText(e){const n=this.addTask(new t.io.Manual),s=this.zip.file(e);if(!s)throw new Error("cannot find file as text: "+e);return s.async("text").then((t=>(n.markComplete(),t)))}getAsArrayBuffer(e){const n=this.addTask(new t.io.Manual),s=this.zip.file(e);if(!s)throw new Error("cannot find file as arraybuffer: "+e);return s.async("arraybuffer").then((t=>(n.markComplete(),t)))}getAsBase64(e){const n=this.addTask(new t.io.Manual),s=this.zip.file(e);if(!s)throw new Error("cannot find file as base64: "+e);return s.async("base64").then((t=>(n.markComplete(),t)))}getAsImage(e,n){const s=this.addTask(new t.io.Manual);return this.getAsBase64(e).then((t=>new Promise(((i,r)=>{const o=new Image;o.onload=()=>{s.markComplete(),i(o)},o.onerror=t=>{r(new Error("Failed to load image: "+e+"."+n))},o.src="data:image/"+n+";base64,"+t}))))}load(){return JSZip.loadAsync(this.buffer).then((t=>(this.zip=t,this.getAsText("project.json")))).then((t=>{this.projectData=JSON.parse(t)})).then((()=>super.load()))}};e.Scratch3Loader=class extends d{constructor(t){super(),"object"==typeof t?(this.projectData=t,this.projectId=null):this.projectId=t}getAsText(n){return this.addTask(new t.io.Request(e.ASSETS_API.replace("$md5ext",n))).load("text")}getAsArrayBuffer(n){return this.addTask(new t.io.Request(e.ASSETS_API.replace("$md5ext",n))).load("arraybuffer")}getAsImage(n){return this.addTask(new t.io.Img(e.ASSETS_API.replace("$md5ext",n))).load()}load(){return this.projectId?this.addTask(new t.io.Request(t.config.PROJECT_API.replace("$id",""+this.projectId))).load("json").then((t=>(this.projectData=t,super.load()))):super.load()}}}(t.sb3||(t.sb3={}))}(P||(P={})),function(t){!function(e){!function(n){function s(t){throw new Error("Compile-time assertNever failed.")}class i{constructor(t,e){this.source=t,this.type=e,this.potentialNumber=!0,this.flags=0}enableFlag(t){this.flags|=t}hasFlag(t){return 0!=(this.flags&t)}toString(){return this.source}}n.CompiledInput=i;const r=t=>new i(t,"string"),o=t=>new i(t,"number"),a=t=>new i(t,"any");class l{constructor(t,e){this.compiler=t,this.block=e}get target(){return this.compiler.target}get stage(){return this.compiler.target.stage}getInput(t,e){return this.compiler.compileInput(this.block,t,e)}getField(t){return this.compiler.getField(this.block,t)}fieldInput(t){return this.sanitizedInput(this.getField(t))}sanitizedInput(t){return this.compiler.sanitizedInput(t)}sanitizedString(t){return this.compiler.sanitizedString(t)}getVariableReference(t){return this.compiler.getVariableReference(this.compiler.getVariableField(this.block,t))}getListReference(t){return this.compiler.getListReference(this.compiler.getVariableField(this.block,t))}getVariableScope(t){return this.compiler.findVariable(this.compiler.getVariableField(this.block,t)).scope}isCloudVariable(t){return this.target.stage.cloudVariables.indexOf(this.getField(t))>-1}getListScope(t){return this.compiler.findList(this.compiler.getVariableField(this.block,t)).scope}asType(t,e){return this.compiler.asType(t,e)}evaluateInputOnce(e){const n=t.runtime.scopedEval(`(function() { return ${e}; })`);return this.target.stage.runtime.evaluateExpression(this.target,n)}}n.BlockUtil=l;class h extends l{constructor(){super(...arguments),this.content="",this.substacksQueue=!1}getSubstack(t){const e=this.compiler.labelCount,n=this.compiler.compileSubstackInput(this.block,t);return this.compiler.labelCount!==e&&(this.substacksQueue=!0),n}claimNextLabel(){return this.compiler.labelCount++}addLabel(t){return t||(t=this.claimNextLabel()),this.write(`{{${t}}}`),t}queue(t){this.writeLn(`queue(${t}); return;`)}forceQueue(t){this.writeLn(`forceQueue(${t}); return;`)}visual(t){switch(t){case"drawing":this.writeLn("if (S.visible || S.isPenDown) VISUAL = true;");break;case"visible":this.writeLn("if (S.visible) VISUAL = true;");break;case"always":this.writeLn("VISUAL = true;");break;default:s()}}updateBubble(){this.writeLn("if (S.saying) S.updateBubble()")}waitUntilSettles(t){this.writeLn("save();"),this.writeLn("R.resume = false;"),this.writeLn("var localR = R;"),this.writeLn(`${t}`),this.writeLn("  .then(function() { localR.resume = true; })"),this.writeLn("  .catch(function() { localR.resume = true; });");const e=this.addLabel();this.writeLn("if (!R.resume) {"),this.forceQueue(e),this.writeLn("}"),this.writeLn("restore();")}waitOneTick(){this.writeLn("save();"),this.writeLn("R.start = runtime.currentMSecs;");const t=this.addLabel();this.writeLn("if (runtime.currentMSecs === R.start) {"),this.forceQueue(t),this.writeLn("}"),this.writeLn("restore();")}write(t){this.content+=t}writeLn(t){this.content+=t+"\n"}}n.StatementUtil=h;class c extends l{numberInput(t){return o(t)}stringInput(t){return r(t)}booleanInput(t){return(t=>new i(t,"boolean"))(t)}anyInput(t){return a(t)}}n.InputUtil=c;class d extends l{constructor(t,e,n){super(t,e),this.startingFunction=n}}n.HatUtil=d,n.statementLibrary=Object.create(null),n.inputLibrary=Object.create(null),n.hatLibrary=Object.create(null),n.watcherLibrary=Object.create(null);n.Compiler=class{constructor(t){this.labelCount=0,this.needsMusic=!1,this.costumeAndSoundNames=new Set,this.target=t,this.data=t.sb3data,this.blocks=this.data.blocks;for(const e of t.costumes)this.costumeAndSoundNames.add(e.name);for(const e of t.sounds)this.costumeAndSoundNames.add(e.name)}getHatBlocks(){return Object.keys(this.blocks).filter((t=>this.blocks[t].topLevel))}getStatementCompiler(t){return n.statementLibrary[t]?n.statementLibrary[t]:null}getInputCompiler(t){return n.inputLibrary[t]?n.inputLibrary[t]:null}getHatCompiler(t){return n.hatLibrary[t]?n.hatLibrary[t]:null}getInputFallback(t){switch(t){case"number":case"color":return"0";case"boolean":return"false";case"string":case"any":case"list":return'""'}s()}asType(t,e){switch(e){case"string":return'("" + '+t+")";case"number":return"(+"+t+" || 0)";case"boolean":return"bool("+t+")";case"any":return t;case"list":throw new Error("Converting to 'list' type is not something you're supposed to do");case"color":return"parseColor("+t+")"}s()}convertInputType(t,e){if(t.type===e)return"number"===e&&t.hasFlag(1)?new i("("+t.source+" || 0)",e):t;if("any"===e){if("list"!==t.type)return t;e="string"}return new i(this.asType(t.source,e),e)}sanitizedInput(t){return r(this.sanitizedString(t))}sanitizedString(t){return`"${t=t.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\{/g,"\\x7b").replace(/\}/g,"\\x7d")}"`}sanitizedComment(t){return`/* ${t=t.replace(/\*\//g,"")} */`}findVariable({id:t,name:e}){const n=this.target.stage;return n.varIds.hasOwnProperty(t)?{scope:"self",name:n.varIds[t]}:n.vars.hasOwnProperty(e)?{scope:"self",name:e}:this.target.varIds.hasOwnProperty(t)?{scope:"S",name:this.target.varIds[t]}:this.target.vars.hasOwnProperty(e)?{scope:"S",name:e}:(this.target.vars[t]=0,this.target.varIds[t]=t,{scope:"S",name:t})}findList({id:t,name:n}){const s=this.target.stage;return s.listIds.hasOwnProperty(t)?{scope:"self",name:s.listIds[t]}:s.lists.hasOwnProperty(n)?{scope:"self",name:n}:this.target.listIds.hasOwnProperty(t)?{scope:"S",name:this.target.listIds[t]}:this.target.lists.hasOwnProperty(n)?{scope:"S",name:n}:(this.target.lists[t]=e.createList(),this.target.listIds[t]=t,{scope:"S",name:t})}getVariableReference({id:t,name:e}){const n=this.findVariable({id:t,name:e});return`${n.scope}.vars[${this.sanitizedString(n.name)}]`}getListReference({id:t,name:e}){const n=this.findList({id:t,name:e});return`${n.scope}.lists[${this.sanitizedString(n.name)}]`}isStringLiteralPotentialNumber(t){return/\d|true|false|Infinity/.test(t)}isNameOfCostumeOrSound(t){return this.costumeAndSoundNames.has(t)}compileNativeInput(e,n){const s=e[0];switch(s){case 4:case 5:case 6:case 7:case 8:{const t=+e[1];return isNaN(t)||"string"===n?this.sanitizedInput(""+e[1]):o((l=t,Object.is(l,-0)?"-0":l.toString()))}case 10:{const t=e[1];if("string"!==n&&/\d|Infinity/.test(t)&&!this.isNameOfCostumeOrSound(t)){const e=+t;if(e.toString()===t&&!isNaN(e))return o(e.toString())}const s=this.sanitizedInput(e[1]+"");return s.potentialNumber=this.isStringLiteralPotentialNumber(e[1]),s}case 12:return a(this.getVariableReference({id:e[2],name:e[1]}));case 13:return new i(this.getListReference({id:e[2],name:e[1]}),"list");case 11:return this.sanitizedInput(e[1]);case 9:{const n=e[1],s=t.utils.parseColor(n);return new i(""+s,"color")}default:return this.warn("unknown native",s,e),r('""')}var l}compileInput(e,n,s){if(!e.inputs||!e.inputs[n])return this.warn("missing input",n),new i(this.getInputFallback(s),s);const r=e.inputs[n];if(Array.isArray(r[1])){const t=r[1];return this.convertInputType(this.compileNativeInput(t,s),s)}const o=r[1];if(!o)return new i(this.getInputFallback(s),s);const a=this.blocks[o];if(!a)return new i(this.getInputFallback(s),s);const l=a.opcode,h=this.getInputCompiler(l);if(!h)return this.warn("unknown input",l,a),new i(this.getInputFallback(s),s);let d=h(new c(this,a));return t.config.debug&&(d.source=this.sanitizedComment(a.opcode)+d.source),this.convertInputType(d,s)}getField(t,e){const n=t.fields[e];return n?""+n[0]:(this.warn("missing field",e),"")}getVariableField(t,e){const n=t.fields[e];return n?{id:""+n[1],name:""+n[0]}:(this.warn("missing variable field",e),{id:"",name:""})}compileSubstackInput(t,e){if(!t.inputs[e])return"";const n=t.inputs[e],s=(n[0],n[1]);return null===s?"":this.compileStack(s)}getNewState(){return{isWarp:!1,isProcedure:!1,argumentNames:[]}}compileStack(e){let n="",s=this.blocks[e];for(;;){var i=s.opcode;const e=this.getStatementCompiler(i);if(t.config.debug&&(n+=this.sanitizedComment(s.opcode)),e){const t=new h(this,s);e(t),n+=t.content}else n+="/* unknown statement */",this.warn("unknown statement",i,s);if(!s.next)break;s=this.blocks[s.next]}return n}compileHat(e){const n=this.getHatCompiler(e.opcode);if(!n)return void(this.getInputCompiler(e.opcode)||this.getStatementCompiler(e.opcode)||this.warn("unknown hat block",e.opcode,e));this.labelCount=this.target.fns.length;const s=e.next;if(!s)return;this.state=this.getNewState();let i=`{{${this.labelCount++}}}`;n.precompile&&(i+=n.precompile(this,e)),i+=this.compileStack(s),n.postcompile&&(i=n.postcompile(this,i,e));const r=this.parseScript(i),o=r.script,a=this.target.fns.length;for(let e of Object.keys(r.labels))this.target.fns[e]=t.runtime.createContinuation(o.slice(r.labels[e]));const l=this.target.fns[a],h=new d(this,e,l);n.handle(h),t.config.debug&&this.log(`[${this.target.name}] compiled sb3 script "${e.opcode}"`,i,this.target)}parseScript(t){const e={};let n=0,s=0;for(;;){const i=t.indexOf("{{",n);if(-1===i)break;const r=t.indexOf("}}",n);s+=r+2-i,e[t.substring(i+2,r)]=r+2-s,n=r+2}return{labels:e,script:t.replace(/{{\d+}}/g,"")}}warn(...t){t.unshift(`[sb3 compiler ${this.target.name}]`),console.warn.apply(console,t)}log(...t){t.unshift(`[sb3 compiler ${this.target.name}]`),console.log.apply(console,t)}compile(){const t=this.getHatBlocks();for(const e of t){const t=this.blocks[e];this.compileHat(t)}this.target.sb3data=null}}}(e.compiler||(e.compiler={}))}(t.sb3||(t.sb3={}))}(P||(P={})),function(){const t=P.sb3.compiler.statementLibrary,e=P.sb3.compiler.inputLibrary,n=P.sb3.compiler.hatLibrary,s=P.sb3.compiler.watcherLibrary;t.control_all_at_once=function(t){const e=t.getSubstack("SUBSTACK");t.write(e)},t.control_clear_counter=function(t){t.writeLn("self.counter = 0;")},t.control_create_clone_of=function(t){const e=t.getInput("CLONE_OPTION","any");t.writeLn(`clone(${e});`)},t.control_delete_this_clone=function(t){t.writeLn("if (S.isClone) {"),t.visual("visible"),t.writeLn("  S.remove();"),t.writeLn("  var i = self.children.indexOf(S);"),t.writeLn("  if (i !== -1) self.children.splice(i, 1);"),t.writeLn("  for (var i = 0; i < runtime.queue.length; i++) {"),t.writeLn("    if (runtime.queue[i] && runtime.queue[i].sprite === S) {"),t.writeLn("      runtime.queue[i] = undefined;"),t.writeLn("    }"),t.writeLn("  }"),t.writeLn("  return;"),t.writeLn("}")},t.control_for_each=function(t){const e=t.getVariableReference("VARIABLE"),n=t.getSubstack("SUBSTACK"),s=t.getInput("VALUE","number");t.writeLn("save();"),t.writeLn(`R.times = ${s};`),t.writeLn("R.current = 0;");const i=t.addLabel();t.writeLn("if (R.current < R.times) {"),t.writeLn(`  ${e} = ++R.current;`),t.write(n),t.queue(i),t.writeLn("} else {"),t.writeLn("  restore();"),t.writeLn("}")},t.control_forever=function(t){const e=t.getSubstack("SUBSTACK");if(t.compiler.state.isWarp&&!t.substacksQueue)t.writeLn("while (true) {"),t.write(e),t.writeLn("}");else{const n=t.addLabel();t.write(e),t.queue(n)}},t.control_if=function(t){const e=t.getInput("CONDITION","boolean"),n=t.getSubstack("SUBSTACK");t.writeLn(`if (${e}) {`),t.write(n),t.writeLn("}")},t.control_if_else=function(t){const e=t.getInput("CONDITION","boolean"),n=t.getSubstack("SUBSTACK"),s=t.getSubstack("SUBSTACK2");t.writeLn(`if (${e}) {`),t.write(n),t.writeLn("} else {"),t.write(s),t.writeLn("}")},t.control_incr_counter=function(t){t.writeLn("self.counter++;")},t.control_repeat=function(t){const e=t.getInput("TIMES","any"),n=t.getSubstack("SUBSTACK");if(t.compiler.state.isWarp&&!t.substacksQueue)t.writeLn("save();"),t.writeLn(`R.count = ${e};`),t.writeLn("while (R.count >= 0.5) {"),t.writeLn("  R.count -= 1;"),t.write(n),t.writeLn("}"),t.writeLn("restore();");else{t.writeLn("save();"),t.writeLn(`R.count = ${e};`);const s=t.addLabel();t.writeLn("if (R.count >= 0.5) {"),t.writeLn("  R.count -= 1;"),t.write(n),t.queue(s),t.writeLn("} else {"),t.writeLn("  restore();"),t.writeLn("}")}},t.control_repeat_until=function(t){const e=t.getInput("CONDITION","boolean"),n=t.getSubstack("SUBSTACK");if(t.compiler.state.isWarp&&!t.substacksQueue)t.writeLn(`while (!${e}) {`),t.write(n),t.writeLn("}");else{const s=t.addLabel();t.writeLn(`if (!${e}) {`),t.write(n),t.queue(s),t.writeLn("}")}},t.control_stop=function(t){switch(t.getField("STOP_OPTION")){case"all":t.writeLn("runtime.stopAll(); return;");break;case"this script":t.writeLn("endCall(); return;");break;case"other scripts in sprite":case"other scripts in stage":t.writeLn("S.stopSoundsExcept(BASE);"),t.writeLn("for (var i = 0; i < runtime.queue.length; i++) {"),t.writeLn("  if (i !== THREAD && runtime.queue[i] && runtime.queue[i].sprite === S) {"),t.writeLn("    runtime.queue[i].stopped = true;"),t.writeLn("    runtime.queue[i].fn = undefined;"),t.writeLn("  }"),t.writeLn("}")}},t.control_wait=function(t){const e=t.getInput("DURATION","any");t.visual("always"),t.writeLn("save();"),t.writeLn("R.start = runtime.currentMSecs;"),t.writeLn(`R.duration = ${e};`),t.writeLn("var first = !WARP;");const n=t.addLabel();t.writeLn("if (runtime.currentMSecs - R.start < R.duration * 1000 || first) {"),t.writeLn("  var first;"),t.forceQueue(n),t.writeLn("}"),t.writeLn("restore();")},t.control_wait_until=function(t){const e=t.getInput("CONDITION","boolean"),n=t.addLabel();t.writeLn(`if (!${e}) {`),t.forceQueue(n),t.writeLn("}")},t.control_while=function(t){const e=t.getInput("CONDITION","boolean"),n=t.getSubstack("SUBSTACK");if(t.compiler.state.isWarp&&!t.substacksQueue)t.writeLn(`while (${e}) {`),t.write(n),t.writeLn("}");else{const s=t.addLabel();t.writeLn(`if (${e}) {`),t.write(n),t.queue(s),t.writeLn("}")}},t.data_addtolist=function(t){const e=t.getListReference("LIST"),n=t.getInput("ITEM","any");t.writeLn(`watchedAppendToList(${e}, ${n});`)},t.data_changevariableby=function(t){const e=t.getVariableReference("VARIABLE"),n=t.getInput("VALUE","number");t.writeLn(`${e} = (${t.asType(e,"number")} + ${n});`),t.isCloudVariable("VARIABLE")&&t.writeLn(`cloudVariableChanged(${t.sanitizedString(t.getField("VARIABLE"))})`)},t.data_deletealloflist=function(t){const e=t.getListReference("LIST");t.writeLn(`watchedDeleteAllOfList(${e});`)},t.data_deleteoflist=function(t){const e=t.getListReference("LIST"),n=t.getInput("INDEX","any");t.writeLn(`watchedDeleteLineOfList(${e}, ${n});`)},t.data_hidelist=function(t){const e=t.sanitizedString(t.getField("LIST")),n=t.getListScope("LIST");t.writeLn(`${n}.showList(${e}, false);`)},t.data_hidevariable=function(t){const e=t.sanitizedString(t.getField("VARIABLE")),n=t.getVariableScope("VARIABLE");t.writeLn(`${n}.showVariable(${e}, false);`)},t.data_insertatlist=function(t){const e=t.getListReference("LIST"),n=t.getInput("INDEX","any"),s=t.getInput("ITEM","any");t.writeLn(`watchedInsertInList(${e}, ${n}, ${s});`)},t.data_replaceitemoflist=function(t){const e=t.getListReference("LIST"),n=t.getInput("ITEM","any"),s=t.getInput("INDEX","any");t.writeLn(`watchedSetLineOfList(${e}, ${s}, ${n});`)},t.data_setvariableto=function(t){const e=t.getVariableReference("VARIABLE"),n=t.getInput("VALUE","any");t.writeLn(`${e} = ${n};`),t.isCloudVariable("VARIABLE")&&t.writeLn(`cloudVariableChanged(${t.sanitizedString(t.getField("VARIABLE"))})`)},t.data_showlist=function(t){const e=t.sanitizedString(t.getField("LIST")),n=t.getListScope("LIST");t.writeLn(`${n}.showList(${e}, true);`)},t.data_showvariable=function(t){const e=t.sanitizedString(t.getField("VARIABLE")),n=t.getVariableScope("VARIABLE");t.writeLn(`${n}.showVariable(${e}, true);`)},t.event_broadcast=function(t){const e=t.getInput("BROADCAST_INPUT","any");t.writeLn(`var threads = broadcast(${e});`),t.writeLn("if (threads.indexOf(BASE) !== -1) {STOPPED = true;}")},t.event_broadcastandwait=function(t){const e=t.getInput("BROADCAST_INPUT","any");t.writeLn("save();"),t.writeLn(`R.threads = broadcast(${e});`),t.writeLn("if (R.threads.indexOf(BASE) !== -1) {return;}");const n=t.addLabel();t.writeLn("if (running(R.threads)) {"),t.forceQueue(n),t.writeLn("}"),t.writeLn("restore();")},t.looks_changeeffectby=function(t){const e=t.sanitizedString(t.getField("EFFECT")).toLowerCase(),n=t.getInput("CHANGE","number");t.writeLn(`S.changeFilter(${e}, ${n});`),t.visual("visible")},t.looks_changesizeby=function(t){const e=t.getInput("CHANGE","any");t.writeLn(`var f = S.scale + ${e} / 100;`),t.writeLn("S.scale = f < 0 ? 0 : f;"),t.visual("visible")},t.looks_cleargraphiceffects=function(t){t.writeLn("S.resetFilters();"),t.visual("visible")},t.looks_goforwardbackwardlayers=function(t){const e=t.getField("FORWARD_BACKWARD"),n=t.getInput("NUM","number");t.writeLn("var i = self.children.indexOf(S);"),t.writeLn("if (i !== -1) {"),t.writeLn("  self.children.splice(i, 1);"),"forward"===e?t.writeLn(`  self.children.splice(Math.max(0, Math.min(self.children.length, i + ${n})), 0, S);`):t.writeLn(`  self.children.splice(Math.max(0, Math.min(self.children.length, i - ${n})), 0, S);`),t.writeLn("}")},t.looks_gotofrontback=function(t){const e=t.getField("FRONT_BACK");t.writeLn("var i = self.children.indexOf(S);"),t.writeLn("if (i !== -1) self.children.splice(i, 1);"),"front"===e?t.writeLn("self.children.push(S);"):t.writeLn("self.children.unshift(S);")},t.looks_hide=function(t){t.writeLn("S.visible = false;"),t.updateBubble()},t.looks_nextbackdrop=function(t){t.writeLn("self.showNextCostume();"),t.visual("always"),t.writeLn("var threads = sceneChange();"),t.writeLn("if (threads.indexOf(BASE) !== -1) {return;}")},t.looks_nextcostume=function(t){t.writeLn("S.showNextCostume();"),t.visual("visible")},t.looks_say=function(t){const e=t.getInput("MESSAGE","any");t.writeLn(`S.say(${e}, false);`),t.visual("visible")},t.looks_sayforsecs=function(t){const e=t.getInput("MESSAGE","any"),n=t.getInput("SECS","number");t.writeLn("save();"),t.writeLn(`R.id = S.say(${e}, false);`),t.visual("visible"),t.writeLn("R.start = runtime.now();"),t.writeLn(`R.duration = ${n};`),t.writeLn("var first = true;");const s=t.addLabel();t.writeLn("if (runtime.now() - R.start < R.duration * 1000 || first) {"),t.writeLn("  var first;"),t.forceQueue(s),t.writeLn("}"),t.writeLn("if (S.sayId === R.id) {"),t.writeLn('  S.say("");'),t.writeLn("}"),t.writeLn("restore();")},t.looks_seteffectto=function(t){const e=t.sanitizedString(t.getField("EFFECT")).toLowerCase(),n=t.getInput("VALUE","number");t.writeLn(`S.setFilter(${e}, ${n});`),t.visual("visible")},t.looks_setsizeto=function(t){const e=t.getInput("SIZE","number");t.writeLn(`S.scale = Math.max(0, ${e} / 100);`),t.visual("visible")},t.looks_show=function(t){t.writeLn("S.visible = true;"),t.visual("always"),t.updateBubble()},t.looks_switchbackdropto=function(t){const e=t.getInput("BACKDROP","any");t.writeLn(`self.setCostume(${e});`),t.visual("always"),t.writeLn("var threads = sceneChange();"),t.writeLn("if (threads.indexOf(BASE) !== -1) {return;}")},t.looks_switchbackdroptoandwait=function(t){const e=t.getInput("BACKDROP","any");t.writeLn(`self.setCostume(${e});`),t.visual("always"),t.writeLn("save();"),t.writeLn("R.threads = sceneChange();"),t.writeLn("if (R.threads.indexOf(BASE) !== -1) {return;}");const n=t.addLabel();t.writeLn("if (running(R.threads)) {"),t.forceQueue(n),t.writeLn("}"),t.writeLn("restore();")},t.looks_switchcostumeto=function(t){const e=t.getInput("COSTUME","any");t.writeLn(`S.setCostume(${e});`),t.visual("visible")},t.looks_think=function(t){const e=t.getInput("MESSAGE","any");t.writeLn(`S.say(${e}, true);`),t.visual("visible")},t.looks_thinkforsecs=function(t){const e=t.getInput("MESSAGE","any"),n=t.getInput("SECS","number");t.writeLn("save();"),t.writeLn(`R.id = S.say(${e}, true);`),t.visual("visible"),t.writeLn("R.start = runtime.now();"),t.writeLn(`R.duration = ${n};`),t.writeLn("var first = true;");const s=t.addLabel();t.writeLn("if (runtime.now() - R.start < R.duration * 1000 || first) {"),t.writeLn("  var first;"),t.forceQueue(s),t.writeLn("}"),t.writeLn("if (S.sayId === R.id) {"),t.writeLn('  S.say("");'),t.writeLn("}"),t.writeLn("restore();")},t.motion_changexby=function(t){const e=t.getInput("DX","number");t.writeLn(`S.moveTo(S.scratchX + ${e}, S.scratchY);`),t.visual("drawing")},t.motion_changeyby=function(t){const e=t.getInput("DY","number");t.writeLn(`S.moveTo(S.scratchX, S.scratchY + ${e});`),t.visual("drawing")},t.motion_glidesecstoxy=function(t){const e=t.getInput("SECS","any"),n=t.getInput("X","any"),s=t.getInput("Y","any");t.visual("drawing"),t.writeLn("save();"),t.writeLn("R.start = runtime.now();"),t.writeLn(`R.duration = ${e};`),t.writeLn("R.baseX = S.scratchX;"),t.writeLn("R.baseY = S.scratchY;"),t.writeLn(`R.deltaX = ${n} - S.scratchX;`),t.writeLn(`R.deltaY = ${s} - S.scratchY;`);const i=t.addLabel();t.writeLn("var f = (runtime.now() - R.start) / (R.duration * 1000);"),t.writeLn("if (f > 1 || isNaN(f)) f = 1;"),t.writeLn("S.moveTo(R.baseX + f * R.deltaX, R.baseY + f * R.deltaY);"),t.visual("drawing"),t.writeLn("if (f < 1) {"),t.forceQueue(i),t.writeLn("}"),t.writeLn("restore();")},t.motion_glideto=function(t){const e=t.getInput("SECS","any"),n=t.getInput("TO","any");t.visual("drawing"),t.writeLn("save();"),t.writeLn("R.start = runtime.now();"),t.writeLn(`R.duration = ${e};`),t.writeLn("R.baseX = S.scratchX;"),t.writeLn("R.baseY = S.scratchY;"),t.writeLn(`var to = self.getPosition(${n});`),t.writeLn("if (to) {"),t.writeLn("  R.deltaX = to.x - S.scratchX;"),t.writeLn("  R.deltaY = to.y - S.scratchY;");const s=t.addLabel();t.writeLn("  var f = (runtime.now() - R.start) / (R.duration * 1000);"),t.writeLn("  if (f > 1 || isNaN(f)) f = 1;"),t.writeLn("  S.moveTo(R.baseX + f * R.deltaX, R.baseY + f * R.deltaY);"),t.visual("drawing"),t.writeLn("  if (f < 1) {"),t.forceQueue(s),t.writeLn("  }"),t.writeLn("  restore();"),t.writeLn("}")},t.motion_goto=function(t){const e=t.getInput("TO","any");t.writeLn(`S.gotoObject(${e});`),t.visual("drawing")},t.motion_gotoxy=function(t){const e=t.getInput("X","number"),n=t.getInput("Y","number");t.writeLn(`S.moveTo(${e}, ${n});`),t.visual("drawing")},t.motion_ifonedgebounce=function(t){t.writeLn("S.bounceOffEdge();")},t.motion_movesteps=function(t){const e=t.getInput("STEPS","number");t.writeLn(`S.forward(${e});`),t.visual("drawing")},t.motion_pointindirection=function(t){const e=t.getInput("DIRECTION","number");t.visual("visible"),t.writeLn(`S.setDirection(${e});`)},t.motion_pointtowards=function(t){const e=t.getInput("TOWARDS","any");t.writeLn(`S.pointTowards(${e});`),t.visual("visible")},t.motion_setrotationstyle=function(t){const e=P.utils.parseRotationStyle(t.getField("STYLE"));t.writeLn(`S.rotationStyle = ${e};`),t.visual("visible")},t.motion_setx=function(t){const e=t.getInput("X","number");t.writeLn(`S.moveTo(${e}, S.scratchY);`),t.visual("drawing")},t.motion_sety=function(t){const e=t.getInput("Y","number");t.writeLn(`S.moveTo(S.scratchX, ${e});`),t.visual("drawing")},t.motion_turnleft=function(t){const e=t.getInput("DEGREES","number");t.writeLn(`S.setDirection(S.direction - ${e});`),t.visual("visible")},t.motion_turnright=function(t){const e=t.getInput("DEGREES","number");t.writeLn(`S.setDirection(S.direction + ${e});`),t.visual("visible")},t.music_changeTempo=function(t){const e=t.getInput("TEMPO","number");t.writeLn(`self.tempoBPM += ${e};`)},t.music_playDrumForBeats=function(t){const e=t.getInput("BEATS","number"),n=t.getInput("DRUM","number");t.compiler.needsMusic=!0,t.writeLn("save();"),t.writeLn("R.start = runtime.now();"),t.writeLn(`R.duration = ${e} * 60 / self.tempoBPM;`),t.writeLn("var first = !WARP;"),P.audio.context?t.writeLn(`R.sound = playSpan(DRUMS[Math.round(${n}) - 1] || DRUMS[2], 60, 10);`):t.writeLn("R.sound = { stopped: false };");const s=t.addLabel();t.writeLn("S.activeSounds.add(R.sound);"),t.writeLn("if ((runtime.now() - R.start < R.duration * 1000 || first) && !R.sound.stopped) {"),t.writeLn("  var first;"),t.forceQueue(s),t.writeLn("}"),t.writeLn("S.activeSounds.delete(R.sound);"),t.writeLn("restore();")},t.music_playNoteForBeats=function(t){const e=t.getInput("BEATS","number"),n=t.getInput("NOTE","number");t.compiler.needsMusic=!0,t.writeLn("save();"),t.writeLn("R.start = runtime.now();"),t.writeLn(`R.duration = ${e} * 60 / self.tempoBPM;`),P.audio.context?t.writeLn(`R.sound = playNote(${n}, R.duration);`):t.writeLn("R.sound = { stopped: false };");const s=t.addLabel();t.writeLn("S.activeSounds.add(R.sound);"),t.writeLn("if ((runtime.now() - R.start < R.duration * 1000) && !R.sound.stopped) {"),t.forceQueue(s),t.writeLn("}"),t.writeLn("S.activeSounds.delete(R.sound);"),t.writeLn("restore();")},t.music_restForBeats=function(t){const e=t.getInput("BEATS","number");t.writeLn("save();"),t.writeLn("R.start = runtime.now();"),t.writeLn(`R.duration = ${e} * 60 / self.tempoBPM;`),t.writeLn("var first = !WARP;");const n=t.addLabel();t.writeLn("if (runtime.now() - R.start < R.duration * 1000 || first) {"),t.writeLn("  var first;"),t.forceQueue(n),t.writeLn("}"),t.writeLn("restore();")},t.music_setTempo=function(t){const e=t.getInput("TEMPO","number");t.writeLn(`self.tempoBPM = ${e};`)},t.music_setInstrument=function(t){const e=t.getInput("INSTRUMENT","number");t.writeLn(`S.instrument = Math.max(0, Math.min(INSTRUMENTS.length - 1, ${e} - 1)) | 0;`)},t.pen_changePenColorParamBy=function(t){const e=t.getInput("COLOR_PARAM","string"),n=t.getInput("VALUE","number");t.writeLn(`S.penColor.changeParam(${e}, ${n});`)},t.pen_changePenHueBy=function(t){const e=t.getInput("HUE","number");t.writeLn("S.penColor.toHSLA();"),t.writeLn(`S.penColor.x += ${e} * 360 / 200;`),t.writeLn("S.penColor.y = 100;")},t.pen_changePenShadeBy=function(t){const e=t.getInput("SHADE","number");t.writeLn("S.penColor.toHSLA();"),t.writeLn(`S.penColor.z = (S.penColor.z + ${e}) % 200;`),t.writeLn("if (S.penColor.z < 0) S.penColor.z += 200;"),t.writeLn("S.penColor.y = 100;")},t.pen_changePenSizeBy=function(t){const e=t.getInput("SIZE","number");t.writeLn(`S.penSize = Math.max(1, S.penSize + ${e});`)},t.pen_clear=function(t){t.writeLn("self.clearPen();"),t.visual("always")},t.pen_penDown=function(t){t.writeLn("S.isPenDown = true;"),t.writeLn("S.dotPen();"),t.visual("always")},t.pen_penUp=function(t){t.writeLn("S.isPenDown = false;")},t.pen_setPenColorParamTo=function(t){const e=t.getInput("COLOR_PARAM","string"),n=t.getInput("VALUE","number");t.writeLn(`S.penColor.setParam(${e}, ${n});`)},t.pen_setPenColorToColor=function(t){const e=t.getInput("COLOR","color");t.writeLn(`S.penColor.setShiftedRGBA(${e});`)},t.pen_setPenHueToNumber=function(t){const e=t.getInput("HUE","number");t.writeLn("S.penColor.toHSLA();"),t.writeLn(`S.penColor.x = ${e} * 360 / 200;`),t.writeLn("S.penColor.y = 100;"),t.writeLn("S.penColor.a = 1;")},t.pen_setPenShadeToNumber=function(t){const e=t.getInput("SHADE","number");t.writeLn("S.penColor.toHSLA();"),t.writeLn(`S.penColor.z = ${e} % 200;`),t.writeLn("if (S.penColor.z < 0) S.penColor.z += 200;"),t.writeLn("S.penColor.y = 100;")},t.pen_setPenSizeTo=function(t){const e=t.getInput("SIZE","number");t.writeLn(`S.penSize = Math.max(1, Math.min(${e}, 1200));`)},t.pen_stamp=function(t){t.writeLn("S.stamp();"),t.visual("always")},t.procedures_call=function(t){const e=t.block.mutation,n=e.proccode;if(P.config.debug){if("forkphorus:debugger;"===n)return void t.writeLn("/* forkphorus */ debugger;");if("forkphorus:throw;"===n)return void t.writeLn('/* forkphorus */ throw new Error("Debug intended crash");')}const s=t.claimNextLabel();t.write(`call(S.procedures[${t.sanitizedString(n)}], ${s}, [`);const i=JSON.parse(e.argumentids);for(const e of i)t.write(`${t.getInput(e,"any")}, `);t.writeLn("]); return;"),t.addLabel(s)},t.sound_changeeffectby=function(t){const e=t.sanitizedString(t.getField("EFFECT")),n=t.getInput("VALUE","number");t.writeLn(`S.changeSoundFilter(${e}, ${n});`),t.writeLn("if (updateSoundEffectsOnAllSounds) updateSoundEffectsOnAllSounds();"),t.waitOneTick()},t.sound_changevolumeby=function(t){const e=t.getInput("VOLUME","number");t.writeLn(`S.volume = Math.max(0, Math.min(1, S.volume + ${e} / 100));`),t.writeLn("if (S.node) S.node.gain.value = S.volume;"),t.waitOneTick()},t.sound_cleareffects=function(t){t.writeLn("S.resetSoundFilters();")},t.sound_play=function(t){const e=t.getInput("SOUND_MENU","any");P.audio.context&&(t.writeLn(`var sound = S.getSound(${e});`),t.writeLn("if (sound) startSound(sound);"))},t.sound_playuntildone=function(t){const e=t.getInput("SOUND_MENU","any");if(P.audio.context){t.writeLn(`var sound = S.getSound(${e});`),t.writeLn("if (sound) {"),t.writeLn("  save();"),t.writeLn("  R.sound = playSound(sound);"),t.writeLn("  S.activeSounds.add(R.sound);");const n=t.addLabel();t.writeLn("  if (!R.sound.node.ended && !R.sound.stopped) {"),t.forceQueue(n),t.writeLn("  }"),t.writeLn("  S.activeSounds.delete(R.sound);"),t.writeLn("  restore();"),t.writeLn("}")}},t.sound_seteffectto=function(t){const e=t.sanitizedString(t.getField("EFFECT")),n=t.getInput("VALUE","number");t.writeLn(`S.setSoundFilter(${e}, ${n});`),t.writeLn("if (updateSoundEffectsOnAllSounds) updateSoundEffectsOnAllSounds();"),t.writeLn("if (!self.removeLimits) {"),t.waitOneTick(),t.writeLn("}")},t.sound_setvolumeto=function(t){const e=t.getInput("VOLUME","number");t.writeLn(`S.volume = Math.max(0, Math.min(1, ${e} / 100));`),t.writeLn("if (S.node) S.node.gain.value = S.volume;"),t.writeLn("if (!self.removeLimits) {"),t.waitOneTick(),t.writeLn("}")},t.sound_stopallsounds=function(t){P.audio.context&&t.writeLn("self.stopAllSounds();")},t.sensing_askandwait=function(t){const e=t.getInput("QUESTION","string");t.writeLn("R.id = self.nextPromptId++;");const n=t.addLabel();t.writeLn("if (self.promptId < R.id) {"),t.forceQueue(n),t.writeLn("}"),t.writeLn(`S.ask(${e});`);const s=t.addLabel();t.writeLn("if (self.promptId === R.id) {"),t.forceQueue(s),t.writeLn("}"),t.writeLn('S.say("");'),t.visual("always")},t.sensing_resettimer=function(t){t.writeLn("runtime.resetTimer();")},t.sensing_setdragmode=function(t){"draggable"===t.getField("DRAG_MODE")?t.writeLn("S.isDraggable = true;"):t.writeLn("S.isDraggable = false;")},t.text2speech_setVoice=function(t){const e=t.getInput("VOICE","string");t.stage.initTextToSpeech(),t.writeLn(`self.tts.setVoice(${e});`)},t.text2speech_setLanguage=function(t){const e=t.getInput("LANGUAGE","string");t.stage.initTextToSpeech(),t.writeLn(`self.tts.setLanguage(${e});`)},t.text2speech_speakAndWait=function(t){const e=t.getInput("WORDS","string");t.stage.initTextToSpeech(),t.waitUntilSettles(`self.tts.speak(${e})`)},t.videoSensing_videoToggle=function(t){const e=t.getInput("VIDEO_STATE","string");t.writeLn(`switch (${e}) {`),t.writeLn('  case "off": self.showVideo(false); break;'),t.writeLn('  case "on": self.showVideo(true); break;'),t.writeLn("}")};const i=t=>t.writeLn("/* noop */");t.motion_align_scene=i,t.motion_scroll_right=i,t.motion_scroll_up=i,t.looks_changestretchby=i,t.looks_hideallsprites=i,t.looks_setstretchto=i,e.argument_reporter_boolean=function(t){const e=t.getField("VALUE");if(!t.compiler.state.isProcedure||-1===t.compiler.state.argumentNames.indexOf(e)){const n=e.toLowerCase();return"is compiled?"===n||"is forkphorus?"===n?t.booleanInput("true"):t.numberInput("0")}return t.booleanInput(t.asType(`C.args[${t.sanitizedString(e)}]`,"boolean"))},e.argument_reporter_string_number=function(t){const e=t.getField("VALUE");return t.compiler.state.isProcedure&&-1!==t.compiler.state.argumentNames.indexOf(e)?t.anyInput(`C.args[${t.sanitizedString(e)}]`):t.numberInput("0")},e.control_create_clone_of_menu=function(t){return t.fieldInput("CLONE_OPTION")},e.control_get_counter=function(t){return t.numberInput("self.counter")},e.data_itemoflist=function(t){const e=t.getListReference("LIST"),n=t.getInput("INDEX","any");return t.anyInput(`getLineOfList(${e}, ${n})`)},e.data_itemnumoflist=function(t){const e=t.getListReference("LIST"),n=t.getInput("ITEM","any");return t.numberInput(`listIndexOf(${e}, ${n})`)},e.data_lengthoflist=function(t){const e=t.getListReference("LIST");return t.numberInput(`${e}.length`)},e.data_listcontainsitem=function(t){const e=t.getListReference("LIST"),n=t.getInput("ITEM","any");return t.booleanInput(`listContains(${e}, ${n})`)},e.looks_backdropnumbername=function(t){return"number"===t.getField("NUMBER_NAME")?t.numberInput("(self.currentCostumeIndex + 1)"):t.stringInput("self.costumes[self.currentCostumeIndex].name")},e.looks_backdrops=function(t){return t.fieldInput("BACKDROP")},e.looks_costume=function(t){return t.fieldInput("COSTUME")},e.looks_costumenumbername=function(t){return"number"===t.getField("NUMBER_NAME")?t.numberInput("(S.currentCostumeIndex + 1)"):t.stringInput("S.costumes[S.currentCostumeIndex].name")},e.looks_size=function(t){return t.numberInput("Math.round(S.scale * 100)")},e.makeymakey_menu_KEY=function(t){return t.fieldInput("KEY")},e.makeymakey_menu_SEQUENCE=function(t){return t.fieldInput("SEQUENCE")},e.matrix=function(t){return t.fieldInput("MATRIX")},e.motion_direction=function(t){return t.numberInput("S.direction")},e.motion_glideto_menu=function(t){return t.fieldInput("TO")},e.motion_goto_menu=function(t){return t.fieldInput("TO")},e.motion_pointtowards_menu=function(t){return t.fieldInput("TOWARDS")},e.motion_xposition=function(t){return t.numberInput("S.scratchX")},e.motion_yposition=function(t){return t.numberInput("S.scratchY")},e.music_getTempo=function(t){return t.numberInput("self.tempoBPM")},e.music_menu_DRUM=function(t){return t.fieldInput("DRUM")},e.music_menu_INSTRUMENT=function(t){return t.fieldInput("INSTRUMENT")},e.note=function(t){return t.fieldInput("NOTE")},e.operator_add=function(t){const e=t.getInput("NUM1","number"),n=t.getInput("NUM2","number"),s=t.numberInput(`(${e} + ${n})`);return s.enableFlag(1),s},e.operator_and=function(t){const e=t.getInput("OPERAND1","any"),n=t.getInput("OPERAND2","any");return t.booleanInput(`(${e} && ${n})`)},e.operator_contains=function(t){const e=t.getInput("STRING1","string"),n=t.getInput("STRING2","string");return t.booleanInput(`stringContains(${e}, ${n})`)},e.operator_divide=function(t){const e=t.getInput("NUM1","number"),n=t.getInput("NUM2","number"),s=t.numberInput(`(${e} / ${n})`);return s.enableFlag(1),s},e.operator_equals=function(t){const e=t.getInput("OPERAND1","any"),n=t.getInput("OPERAND2","any");if(!e.potentialNumber||!n.potentialNumber)return t.booleanInput(`strEqual(${e}, ${n})`);if(P.config.experimentalOptimizations){if("number"===e.type)return t.booleanInput(`numEqualExperimental(${e}, ${n})`);if("number"===n.type)return t.booleanInput(`numEqualExperimental(${n}, ${e})`)}return t.booleanInput(`equal(${e}, ${n})`)},e.operator_gt=function(t){const e=t.getInput("OPERAND1","any"),n=t.getInput("OPERAND2","any");return P.config.experimentalOptimizations&&"number"===e.type?t.booleanInput(`numGreaterExperimental(${e}, ${n})`):t.booleanInput(`(compare(${e}, ${n}) === 1)`)},e.operator_join=function(t){const e=t.getInput("STRING1","string"),n=t.getInput("STRING2","string");return t.stringInput(`(${e} + ${n})`)},e.operator_length=function(t){const e=t.getInput("STRING","string");return t.numberInput(`(${e}).length`)},e.operator_letter_of=function(t){const e=t.getInput("STRING","string"),n=t.getInput("LETTER","number");return t.stringInput(`((${e})[(${n} | 0) - 1] || "")`)},e.operator_lt=function(t){const e=t.getInput("OPERAND1","any"),n=t.getInput("OPERAND2","any");return P.config.experimentalOptimizations&&"number"===e.type?t.booleanInput(`numLessExperimental(${e}, ${n})`):t.booleanInput(`(compare(${e}, ${n}) === -1)`)},e.operator_mathop=function(t){const e=t.getField("OPERATOR"),n=t.getInput("NUM","number");switch(e){case"abs":return t.numberInput(`Math.abs(${n})`);case"floor":return t.numberInput(`Math.floor(${n})`);case"sqrt":{const e=t.numberInput(`Math.sqrt(${n})`);return e.enableFlag(1),e}case"ceiling":return t.numberInput(`Math.ceil(${n})`);case"cos":return t.numberInput(`(Math.round(Math.cos(${n} * Math.PI / 180) * 1e10) / 1e10)`);case"sin":return t.numberInput(`(Math.round(Math.sin(${n} * Math.PI / 180) * 1e10) / 1e10)`);case"tan":return t.numberInput(`tan3(${n})`);case"asin":return t.numberInput(`(Math.asin(${n}) * 180 / Math.PI)`);case"acos":return t.numberInput(`(Math.acos(${n}) * 180 / Math.PI)`);case"atan":return t.numberInput(`(Math.atan(${n}) * 180 / Math.PI)`);case"ln":return t.numberInput(`Math.log(${n})`);case"log":return t.numberInput(`(Math.log(${n}) / Math.LN10)`);case"e ^":return t.numberInput(`Math.exp(${n})`);case"10 ^":return t.numberInput(`Math.pow(10, ${n})`);default:return t.numberInput("0")}},e.operator_mod=function(t){const e=t.getInput("NUM1","number"),n=t.getInput("NUM2","number");return t.numberInput(`mod(${e}, ${n})`)},e.operator_multiply=function(t){const e=t.getInput("NUM1","number"),n=t.getInput("NUM2","number"),s=t.numberInput(`(${e} * ${n})`);return s.enableFlag(1),s},e.operator_not=function(t){const e=t.getInput("OPERAND","any");return t.booleanInput(`!${e}`)},e.operator_or=function(t){const e=t.getInput("OPERAND1","any"),n=t.getInput("OPERAND2","any");return t.booleanInput(`(${e} || ${n})`)},e.operator_random=function(t){const e=t.getInput("FROM","string"),n=t.getInput("TO","string");return t.numberInput(`random3(${e}, ${n})`)},e.operator_round=function(t){const e=t.getInput("NUM","number");return t.numberInput(`Math.round(${e})`)},e.operator_subtract=function(t){const e=t.getInput("NUM1","number"),n=t.getInput("NUM2","number"),s=t.numberInput(`(${e} - ${n})`);return s.enableFlag(1),s},e.pen_menu_colorParam=function(t){return t.fieldInput("colorParam")},e.sensing_answer=function(t){return t.stringInput("self.answer")},e.sensing_coloristouchingcolor=function(t){const e=t.getInput("COLOR","color"),n=t.getInput("COLOR2","color");return t.booleanInput(`S.colorTouchingColor(${e}, ${n})`)},e.sensing_current=function(t){switch(t.getField("CURRENTMENU").toLowerCase()){case"year":return t.numberInput("new Date().getFullYear()");case"month":return t.numberInput("(new Date().getMonth() + 1)");case"date":return t.numberInput("new Date().getDate()");case"dayofweek":return t.numberInput("(new Date().getDay() + 1)");case"hour":return t.numberInput("new Date().getHours()");case"minute":return t.numberInput("new Date().getMinutes()");case"second":return t.numberInput("new Date().getSeconds()")}return t.numberInput("0")},e.sensing_dayssince2000=function(t){return t.numberInput("((Date.now() - epoch) / 86400000)")},e.sensing_distanceto=function(t){const e=t.getInput("DISTANCETOMENU","any");return t.numberInput(`S.distanceTo(${e})`)},e.sensing_distancetomenu=function(t){return t.fieldInput("DISTANCETOMENU")},e.sensing_keyoptions=function(t){return t.fieldInput("KEY_OPTION")},e.sensing_keypressed=function(t){const e=t.getInput("KEY_OPTION","string");return t.booleanInput(`!!self.keys[getKeyCode3(${e})]`)},e.sensing_loud=function(t){return t.stage.initMicrophone(),t.booleanInput("(self.microphone.getLoudness() > 10)")},e.sensing_loudness=function(t){return t.stage.initMicrophone(),t.numberInput("self.microphone.getLoudness()")},e.sensing_mousedown=function(t){return t.booleanInput("self.mousePressed")},e.sensing_mousex=function(t){return t.numberInput("self.mouseX")},e.sensing_mousey=function(t){return t.numberInput("self.mouseY")},e.sensing_of=function(t){const e=t.sanitizedString(t.getField("PROPERTY")),n=t.getInput("OBJECT","string");return t.anyInput(`attribute(${e}, ${n})`)},e.sensing_of_object_menu=function(t){return t.fieldInput("OBJECT")},e.sensing_timer=function(t){return t.numberInput("((runtime.now() - runtime.timerStart) / 1000)")},e.sensing_touchingcolor=function(t){const e=t.getInput("COLOR","color");return t.booleanInput(`S.touchingColor(${e})`)},e.sensing_touchingobject=function(t){const e=t.getInput("TOUCHINGOBJECTMENU","string");return t.booleanInput(`S.touching(${e})`)},e.sensing_touchingobjectmenu=function(t){return t.fieldInput("TOUCHINGOBJECTMENU")},e.sound_sounds_menu=function(t){return t.fieldInput("SOUND_MENU")},e.sensing_username=function(t){return t.stringInput("self.username")},e.sound_volume=function(t){return t.numberInput("(S.volume * 100)")},e.text2speech_menu_voices=function(t){return t.fieldInput("voices")},e.text2speech_menu_languages=function(t){return t.fieldInput("languages")},e.translate_menu_languages=function(t){return t.fieldInput("languages")},e.translate_getTranslate=function(t){const e=t.getInput("WORDS","string");t.getInput("LANGUAGE","string");return e},e.translate_getViewerLanguage=function(t){return t.sanitizedInput("English")},e.videoSensing_menu_VIDEO_STATE=function(t){return t.fieldInput("VIDEO_STATE")};const r=t=>t.anyInput("undefined");e.motion_yscroll=r,e.motion_xscroll=r,e.sensing_userid=r,n.control_start_as_clone={handle(t){t.target.listeners.whenCloned.push(t.startingFunction)}},n.event_whenbackdropswitchesto={handle(t){const e=t.getField("BACKDROP").toLowerCase();t.target.listeners.whenSceneStarts[e]||(t.target.listeners.whenSceneStarts[e]=[]),t.target.listeners.whenSceneStarts[e].push(t.startingFunction)}},n.event_whenbroadcastreceived={handle(t){const e=t.getField("BROADCAST_OPTION").toLowerCase();t.target.listeners.whenIReceive[e]||(t.target.listeners.whenIReceive[e]=[]),t.target.listeners.whenIReceive[e].push(t.startingFunction)}},n.event_whenflagclicked={handle(t){t.target.listeners.whenGreenFlag.push(t.startingFunction)}},n.event_whengreaterthan={precompile(t,e){const n=t.getField(e,"WHENGREATERTHANMENU"),s=t.compileInput(e,"VALUE","number");let i="false",r="false";switch(n.toLowerCase()){case"timer":i=`runtime.whenTimerMSecs / 1000 > ${s}`,r=`runtime.whenTimerMSecs / 1000 <= ${s}`;break;case"loudness":t.target.stage.initMicrophone(),i=`self.microphone.getLoudness() > ${s}`,r=`self.microphone.getLoudness() <= ${s}`;break;default:console.warn("unknown WHENGREATERTHANMENU",n)}let o="";return o+="if (!R.init) { R.init = true; R.stalled = false; }\n",o+=`if (R.stalled && (${r})) { R.stalled = false; }\n`,o+=`else if (!R.stalled && (${i})) { R.stalled = true;\n`,o},postcompile:(t,e,n)=>(e+="}\n",e+=`forceQueue(${t.target.fns.length});`),handle(t){t.target.listeners.edgeActivated.push(t.startingFunction)}},n.event_whenkeypressed={handle(t){const e=t.getField("KEY_OPTION"),n=P.runtime.getKeyCode(e);t.target.addWhenKeyPressedHandler(n,t.startingFunction)}},n.event_whenstageclicked={handle(t){t.target.listeners.whenClicked.push(t.startingFunction)}},n.event_whenthisspriteclicked={handle(t){t.target.listeners.whenClicked.push(t.startingFunction)}},n.makeymakey_whenMakeyKeyPressed={handle(t){const e=t.getInput("KEY","string");try{const s=""+t.evaluateInputOnce(e);if("string"!=typeof s)throw new Error("cannot accept type: "+typeof s);var n=function(t){return"up"===(t=t.toLowerCase())||"down"===t||"left"===t||"right"===t?P.runtime.getKeyCode(t+" arrow"):P.runtime.getKeyCode(t)}(s)}catch(e){return void t.compiler.warn("makeymakey key generation error",e)}const s=P.runtime.getKeyCode(n);t.target.addWhenKeyPressedHandler(s,t.startingFunction)}},n.procedures_definition={handle(t){const e=t.block.inputs.custom_block[1],n=t.compiler.blocks[e].mutation,s=n.proccode;if(!t.target.procedures[s]){const e="string"==typeof n.warp?"true"===n.warp:n.warp,i=JSON.parse(n.argumentnames),r=new P.sb3.Scratch3Procedure(t.startingFunction,e,i);t.target.procedures[s]=r}},postcompile:(t,e,n)=>e+"endCall(); return;\n",precompile(t,e){const n=e.inputs.custom_block[1],s=t.blocks[n].mutation,i="string"==typeof s.warp?"true"===s.warp:s.warp,r=JSON.parse(s.argumentnames);return t.state.isProcedure=!0,t.state.argumentNames=r,i&&(t.state.isWarp=!0),""}},s.data_variable={init(t){const e=t.params.VARIABLE;t.target.watchers[e]=t},set(t,e){const n=t.params.VARIABLE;t.target.vars[n]=e},evaluate(t){const e=t.params.VARIABLE;return t.target.vars[e]},getLabel:t=>t.params.VARIABLE},s.looks_backdropnumbername={evaluate(t){const e=t.stage;return"number"===t.params.NUMBER_NAME?e.currentCostumeIndex+1:e.costumes[e.currentCostumeIndex].name},getLabel:t=>"backdrop "+t.params.NUMBER_NAME},s.looks_costumenumbername={evaluate(t){const e=t.target;return"number"===t.params.NUMBER_NAME?e.currentCostumeIndex+1:e.costumes[e.currentCostumeIndex].name},getLabel:t=>"costume "+t.params.NUMBER_NAME},s.looks_size={evaluate:t=>P.core.isSprite(t.target)?100*t.target.scale:100,getLabel:()=>"size"},s.motion_direction={evaluate:t=>P.core.isSprite(t.target)?t.target.direction:0,getLabel:()=>"direction"},s.motion_xposition={evaluate:t=>t.target.scratchX,getLabel:()=>"x position"},s.motion_yposition={evaluate:t=>t.target.scratchY,getLabel:()=>"y position"},s.music_getTempo={evaluate:t=>t.stage.tempoBPM,getLabel:()=>"Music: tempo"},s.sensing_answer={evaluate:t=>t.stage.answer,getLabel:()=>"answer"},s.sensing_current={evaluate(t){switch(t.params.CURRENTMENU.toLowerCase()){case"year":return(new Date).getFullYear();case"month":return(new Date).getMonth()+1;case"date":return(new Date).getDate();case"dayofweek":return(new Date).getDay()+1;case"hour":return(new Date).getHours();case"minute":return(new Date).getMinutes();case"second":return(new Date).getSeconds()}return 0},getLabel(t){const e=t.params.CURRENTMENU.toLowerCase();return"dayofweek"===e?"day of week":e}},s.sensing_loudness={init(t){t.stage.initMicrophone()},evaluate:t=>t.stage.microphone?t.stage.microphone.getLoudness():-1,getLabel:()=>"loudness"},s.sensing_timer={evaluate:t=>(t.stage.runtime.now()-t.stage.runtime.timerStart)/1e3,getLabel:()=>"timer"},s.sensing_username={evaluate:t=>t.stage.username,getLabel:()=>"username"},s.sound_volume={evaluate:t=>100*t.target.volume,getLabel:()=>"volume"}}(),function(t){!function(t){t.Extension=class{constructor(t){this.stage=t}destroy(){}onstart(){}onpause(){}update(){}}}(t.ext||(t.ext={}))}(P||(P={})),function(t){!function(e){!function(e){function n(t){const e={};for(const n of t.cloudVariables)e[n]=t.vars[n];return e}e.getAllCloudVariables=n;class s extends t.ext.Extension{constructor(t,e,n){super(t),this.id=n,this.ws=null,this.queuedVariableChanges=[],this.updateInterval=null,this.reconnectTimeout=null,this.shouldReconnect=!0,this.failures=0,this.hosts=Array.isArray(e)?e:[e],this.logPrefix="[cloud-ws "+this.hosts[0]+"]",this.username=this.stage.username,this.interfaceStatusIndicator=document.createElement("div"),this.interfaceStatusIndicator.className="phosphorus-cloud-status-indicator",t.ui.appendChild(this.interfaceStatusIndicator),this.handleUpdateInterval=this.handleUpdateInterval.bind(this),this.connect()}variableChanged(t){this.queuedVariableChanges.indexOf(t)>-1||(this.queuedVariableChanges.push(t),null===this.updateInterval&&(this.handleUpdateInterval(),this.startUpdateInterval()))}handleUpdateInterval(){if(0===this.queuedVariableChanges.length)return void this.stopUpdateInterval();if(null===this.ws||this.ws.readyState!==this.ws.OPEN||this.ws.bufferedAmount>16384)return;const t=this.queuedVariableChanges.shift(),e=this.getVariable(t);this.send({method:"set",name:t,value:e})}send(t){this.ws&&this.ws.send(JSON.stringify(t))}getVariable(t){return this.stage.vars[t]}setVariable(t,e){this.stage.vars[t]=e}terminateConnection(t=1e3){null!==this.ws&&(this.ws.close(t),this.ws=null)}connect(){if(null!==this.ws)throw new Error("already connected");this.setStatusText("Connecting..."),console.log(this.logPrefix,"connecting"),this.ws=new WebSocket(this.hosts[this.failures%this.hosts.length]),this.shouldReconnect=!0,this.ws.onopen=()=>{console.log(this.logPrefix,"connected"),this.setStatusText("Connected"),this.setStatusVisible(!1),this.failures=0,this.send({method:"handshake",project_id:this.id,user:this.username})},this.ws.onmessage=t=>{try{const e=t.data.split("\n");for(const t of e){const e=JSON.parse(t);this.handleMessage(e)}this.stage.runtime.isRunning||this.stage.draw()}catch(e){console.warn("error parsing cloud server message",t.data,e)}},this.ws.onclose=t=>{const e=t.code;this.ws=null,console.warn(this.logPrefix,"closed",e),4002===e?(this.setStatusText("Username is invalid. Change your username to connect."),this.hideStatusAfterDelay(),console.error(this.logPrefix,"error: Username")):4004===e?(this.setStatusText("Cloud variables are disabled for this project."),this.hideStatusAfterDelay(),console.error(this.logPrefix,"error: Project is disabled.")):this.reconnect()},this.ws.onerror=t=>{console.warn(this.logPrefix,"error",t)}}reconnect(){if(!this.shouldReconnect)return;this.terminateConnection(),this.reconnectTimeout?clearTimeout(this.reconnectTimeout):this.failures++,this.setStatusText("Connection lost, reconnecting...");const t=2**this.failures*1e3*Math.random();console.log(this.logPrefix,"reconnecting in",t),this.reconnectTimeout=setTimeout((()=>{this.reconnectTimeout=null,this.connect()}),t)}disconnect(){console.log(this.logPrefix,"disconnecting"),this.shouldReconnect=!1,this.terminateConnection()}handleMessage(t){if(!function(t){return function(t){return!("object"!=typeof t||!t)&&"string"==typeof t.method}(t)&&"string"==typeof t.name&&void 0!==t.value}(t))return;const{name:e,value:n}=t;if(-1===this.stage.cloudVariables.indexOf(e))throw new Error("invalid variable name");this.setVariable(e,n)}startUpdateInterval(){null===this.updateInterval&&(this.updateInterval=setInterval(this.handleUpdateInterval,66.66666666666667))}stopUpdateInterval(){null!==this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=null)}setStatusText(t){this.interfaceStatusIndicator.textContent=`☁ ${t}`,this.setStatusVisible(!0)}setStatusVisible(t){clearTimeout(this.hideStatusTimeout),this.interfaceStatusIndicator.classList.toggle("phosphorus-cloud-status-indicator-hidden",!t)}hideStatusAfterDelay(){this.hideStatusTimeout=setTimeout((()=>{this.setStatusVisible(!1)}),4e3)}onstart(){this.queuedVariableChanges.length>0&&this.startUpdateInterval()}onpause(){this.stopUpdateInterval()}update(){this.stage.username!==this.username&&(console.log(this.logPrefix,"username changed to",this.stage.username),this.username=this.stage.username,this.terminateConnection(4100),this.reconnect())}destroy(){this.stopUpdateInterval(),this.disconnect()}}e.WebSocketCloudHandler=s;class i extends t.ext.Extension{constructor(t,e){super(t),this.storageKey="cloud-data:"+e,this.load(),this.save=this.save.bind(this)}variableChanged(t){this.save()}load(){try{const t=localStorage.getItem(this.storageKey);if(null===t)return;const e=JSON.parse(t);for(const t of Object.keys(e))this.stage.cloudVariables.indexOf(t)>-1&&(this.stage.vars[t]=e[t])}catch(t){console.warn("cannot read from localStorage",t)}}save(){try{localStorage.setItem(this.storageKey,JSON.stringify(n(this.stage)))}catch(t){console.warn("cannot save to localStorage",t)}}}e.LocalStorageCloudHandler=i}(e.cloud||(e.cloud={}))}(t.ext||(t.ext={}))}(P||(P={})),function(t){!function(e){!function(e){let n=null,s=0;function i(t){if(t.getFloatTimeDomainData)return new Float32Array(t.fftSize);if(t.getByteTimeDomainData)return new Uint8Array(t.fftSize);throw new Error("Analyzer node does not support getFloatTimeDomainData or getByteTimeDomainData")}function r(){if(null===n)return function(){if(0===s){if(!t.audio.context)return console.warn("Cannot connect to microphone without audio context."),void(s=3);if(!navigator.mediaDevices)return console.warn("Cannot access media devices, probably running in insecure (non-HTTPS) context."),void(s=3);s=2,navigator.mediaDevices.getUserMedia({audio:!0}).then((e=>{const r=t.audio.context.createMediaStreamSource(e),o=t.audio.context.createAnalyser();if(!o.getFloatTimeDomainData)throw new Error("Missing API getFloatTimeDomainData");r.connect(o),n={source:r,stream:e,analyzer:o,dataArray:i(o),lastValue:-1,lastCheck:0},s=1})).catch((t=>{console.warn("Cannot connect to microphone: "+t),s=3}))}}(),-1;if(!n.stream.active)return-1;if(Date.now()-n.lastCheck<33.333333333333336)return n.lastValue;let e=0;if(n.dataArray instanceof Float32Array){n.analyzer.getFloatTimeDomainData(n.dataArray);for(let t=0;t<n.dataArray.length;t++)e+=Math.pow(n.dataArray[t],2)}else{n.analyzer.getByteTimeDomainData(n.dataArray);for(let t=0;t<n.dataArray.length;t++)e+=Math.pow((n.dataArray[t]-128)/128,2)}let r=Math.sqrt(e/n.dataArray.length);return-1!==n.lastValue&&(r=Math.max(r,.6*n.lastValue)),n.lastValue=r,r*=1.63,r=Math.sqrt(r),r=Math.round(100*r),r=Math.min(r,100),r}class o extends t.ext.Extension{getLoudness(){return r()}onstart(){n&&function(){if(!n)throw new Error("Microphone not connected; cannot re-init something that does not exist!");const e=t.audio.context.createAnalyser();n.source.disconnect(),n.source.connect(e),n.analyzer=e,n.dataArray.length!==e.fftSize&&(n.dataArray=i(e))}()}}e.MicrophoneExtension=o}(e.microphone||(e.microphone={}))}(t.ext||(t.ext={}))}(P||(P={})),function(t){!function(e){!function(e){let n;!function(t){t[t.Male=0]="Male",t[t.Female=1]="Female",t[t.Unknown=2]="Unknown"}(n=e.Gender||(e.Gender={}));const s=[/Zira/,/female/i],i=[/David/,/\bmale/i],r={ALTO:{gender:n.Female,pitch:1,rate:1},TENOR:{gender:n.Male,pitch:1.5,rate:1},GIANT:{gender:n.Male,pitch:.5,rate:.75},SQUEAK:{gender:n.Female,pitch:2,rate:1.5},KITTEN:{gender:n.Female,pitch:2,rate:1}};class o extends t.ext.Extension{constructor(t){super(t),this.language="en",this.voice="ALTO",this.supported="speechSynthesis"in window,this.supported?speechSynthesis.getVoices():console.warn("TTS extension is not supported in this browser: it requires the speechSynthesis API https://developer.mozilla.org/en-US/docs/Web/API/SpeechSynthesis")}getVoiceGender(t){return s.some((e=>e.test(t.name)))?n.Female:i.some((e=>e.test(t.name)))?n.Male:n.Unknown}getVoiceData(t){const e=r[t],n=e.rate,s=e.pitch,i=r[this.voice].gender,o=speechSynthesis.getVoices(),a=o.filter((t=>t.lang.substr(0,2)===this.language.substr(0,2)));let l=a.filter((t=>this.getVoiceGender(t)===i));0===l.length&&(l=a),0===l.length&&(l=o);return{voice:l.find((t=>t.default))||l[0]||null,pitch:s,rate:n}}setVoice(t){r.hasOwnProperty(t)&&(this.voice=t)}setLanguage(t){this.language=t}speak(t){return this.supported?("KITTEN"===this.voice&&(t=t.replace(/\w+?\b/g,"meow")),new Promise(((e,n)=>{const s=()=>e(),i=new SpeechSynthesisUtterance(t);i.lang=this.language;const{voice:r,rate:o,pitch:a}=this.getVoiceData(this.voice);i.voice=r,i.rate=o,i.pitch=a,i.onerror=s,i.onend=s,speechSynthesis.speak(i),speechSynthesis.resume()}))):Promise.resolve()}onstart(){this.supported&&speechSynthesis.resume()}onpause(){this.supported&&speechSynthesis.pause()}destroy(){this.supported&&speechSynthesis.cancel()}}e.TextToSpeechExtension=o}(e.tts||(e.tts={}))}(t.ext||(t.ext={}))}(P||(P={})),function(t){var e;(function(e){function n(){const t=document.createElement("canvas");t.width=480,t.height=360;const e=t.getContext("2d");if(!e)throw new Error("Cannot get 2d rendering context in create2dCanvas");return e.imageSmoothingEnabled=!1,{canvas:t,ctx:e}}const s=16316656;class i{constructor(){this.noEffects=!1,this.imageSmoothingEnabled=!1;const{canvas:t,ctx:e}=n();this.canvas=t,this.ctx=e}reset(t){this._reset(this.ctx,t)}drawChild(t){this._drawChild(t,this.ctx)}drawObjects(t){for(var e=0;e<t.length;e++){var n=t[e];n.visible&&this.drawChild(n)}}_reset(e,n){const s=n*t.config.scale,i=Math.max(1,480*s),r=Math.max(1,360*s);e.canvas.width=i,e.canvas.height=r,e.scale(s,s)}_drawChild(e,n){const s=e.costumes[e.currentCostumeIndex];if(!s)return;n.save();const i=e.stage.zoom*t.config.scale;n.translate(((e.scratchX+240)*i|0)/i,((180-e.scratchY)*i|0)/i);let o=s.scale;t.core.isSprite(e)&&(0===e.rotationStyle?n.rotate((e.direction-90)*Math.PI/180):1===e.rotationStyle&&e.direction<0&&n.scale(-1,1),o*=e.scale),s.isScalable&&s.requestSize(o*i),n.imageSmoothingEnabled=s.isScalable||this.imageSmoothingEnabled;const a=s.getImage(),l=-s.rotationCenterX*o|0,h=-s.rotationCenterY*o|0,c=s.width*o|0,d=s.height*o|0;if(c<1||d<1)n.restore();else{if(this.noEffects)n.drawImage(a,l,h,c,d);else if(n.globalAlpha=Math.max(0,Math.min(1,1-e.filters.ghost/100)),0!==e.filters.brightness&&0===e.filters.color){const t=c*i,s=d*i;r.canvas.width=t,r.canvas.height=s,r.ctx.save(),r.ctx.imageSmoothingEnabled=!1,r.ctx.translate(0,0),r.ctx.drawImage(a,0,0,t,s),r.ctx.globalCompositeOperation="source-atop",r.ctx.globalAlpha=Math.abs(e.filters.brightness/100),e.filters.brightness>0?r.ctx.fillStyle="white":r.ctx.fillStyle="black",r.ctx.fillRect(0,0,t,s),n.drawImage(r.canvas,l,h,c,d),r.ctx.restore()}else{const t=function(t){let e="";return t.brightness&&(e+="brightness("+(100+t.brightness)+"%) "),t.color&&(t.color===1/0?e+="grayscale(100%) ":e+="hue-rotate("+t.color/200*360+"deg) "),e}(e.filters);""!==t&&(n.filter=t),n.drawImage(a,l,h,c,d)}n.restore()}}}e.SpriteRenderer2D=i;const r=new i,o=new i;e.ProjectRenderer2D=class extends i{constructor(t){super(),this.stage=t,this.zoom=1,this.penScalingEnabled=!0,this.penModified=!1,this.penTargetZoom=-1,this.penZoom=1,this.stageCostumeIndex=-1;const{ctx:e,canvas:s}=n();this.stageContext=e,this.stageLayer=s;const{ctx:i,canvas:r}=n();this.penContext=i,this.penLayer=r}onStageFiltersChanged(){this.renderStageCostume(this.zoom)}renderStageCostume(t){this._reset(this.stageContext,t),this._drawChild(this.stage,this.stageContext)}init(t){t.appendChild(this.stageLayer),t.appendChild(this.penLayer),t.appendChild(this.canvas)}destroy(){}drawFrame(){this.reset(this.zoom),this.drawObjects(this.stage.children),this.stage.currentCostumeIndex!==this.stageCostumeIndex&&(this.stageCostumeIndex=this.stage.currentCostumeIndex,this.renderStageCostume(this.zoom))}drawAllExcept(t,e){t.drawChild(this.stage),t.ctx.drawImage(this.penLayer,0,0,480,360);for(var n=0;n<this.stage.children.length;n++){var s=this.stage.children[n];s.visible&&s!==e&&t.drawChild(s)}}resize(t){this.zoom=t,this.resizePen(t),this.renderStageCostume(this.zoom)}resizePen(t){this.penScalingEnabled&&(t>this.penZoom?(this.penZoom=t,r.canvas.width=this.penLayer.width,r.canvas.height=this.penLayer.height,r.ctx.drawImage(this.penLayer,0,0),this._reset(this.penContext,t),this.penContext.drawImage(r.canvas,0,0,480,360)):this.penModified?this.penTargetZoom=t:(this.penZoom=t,this._reset(this.penContext,t)))}penClear(){this.penModified=!1,-1!==this.penTargetZoom&&(this._reset(this.penContext,this.penTargetZoom),this.penZoom=this.penTargetZoom,this.penTargetZoom=-1),this.penContext.clearRect(0,0,480,360)}penDot(t,e,n,s){this.penModified=!0,this.penContext.fillStyle=t.toCSS(),this.penContext.beginPath(),this.penContext.arc(240+n,180-s,e/2,0,2*Math.PI,!1),this.penContext.fill()}penLine(t,e,n,s,i,r){this.penModified=!0,this.penContext.lineCap="round",1===this.penZoom&&e%2>.5&&e%2<1.5&&(n-=.5,s-=.5,i-=.5,r-=.5),this.penContext.strokeStyle=t.toCSS(),this.penContext.lineWidth=e,this.penContext.beginPath(),this.penContext.moveTo(240+n,180-s),this.penContext.lineTo(240+i,180-r),this.penContext.stroke()}penStamp(t){this.penModified=!0,this._drawChild(t,this.penContext)}spriteTouchesPoint(e,n,s){const i=e.rotatedBounds();if(n<i.left||s<i.bottom||n>i.right||s>i.top||0===e.scale)return!1;const r=e.costumes[e.currentCostumeIndex];var o=(n-e.scratchX)/e.scale,a=(e.scratchY-s)/e.scale;if(0===e.rotationStyle&&90!==e.direction){const t=(90-e.direction)*Math.PI/180,n=o,s=Math.sin(t),i=Math.cos(t);o=i*n-s*a,a=s*n+i*a}else 1===e.rotationStyle&&e.direction<0&&(o=-o);let l=Math.round(o/r.scale+r.rotationCenterX),h=Math.round(a/r.scale+r.rotationCenterY);return r instanceof t.core.VectorCostume&&(l*=r.currentScale,h*=r.currentScale),!(!Number.isFinite(l)||!Number.isFinite(h))&&0!==r.getContext().getImageData(l,h,1,1).data[3]}spritesIntersect(t,e){const n=t.rotatedBounds();for(var s=0;s<e.length;s++){const o=e[s];if(!o.visible||t===o)continue;const a=o.rotatedBounds();if(n.bottom>=a.top||a.bottom>=n.top||n.left>=a.right||a.left>=n.right)continue;const l=Math.max(n.left,a.left),h=Math.min(n.top,a.top),c=Math.min(n.right,a.right)-l,d=h-Math.max(n.bottom,a.bottom);if(c<1||d<1||c!=c||d!=d)continue;r.canvas.width=c,r.canvas.height=d,r.ctx.save(),r.noEffects=!0,r.ctx.translate(-(l+240),-(180-h)),r.drawChild(t),r.ctx.globalCompositeOperation="source-in",r.drawChild(o),r.noEffects=!1,r.ctx.restore();const u=r.ctx.getImageData(0,0,c,d).data,p=u.length;for(var i=0;i<p;i+=4)if(u[i+3])return!0}return!1}spriteTouchesColor(t,e){const n=t.rotatedBounds(),i=n.right-n.left,o=n.top-n.bottom;if(i<1||o<1||i!=i||o!=o)return!1;r.canvas.width=i,r.canvas.height=o,r.ctx.fillStyle="white",r.ctx.fillRect(0,0,i,o),r.ctx.save(),r.ctx.translate(-(240+n.left),-(180-n.top)),this.drawAllExcept(r,t),r.ctx.globalCompositeOperation="destination-in",r.noEffects=!0,r.drawChild(t),r.noEffects=!1,r.ctx.restore();const a=r.ctx.getImageData(0,0,i,o).data;e&=s;const l=a.length;for(var h=0;h<l;h+=4)if(((a[h]<<16|a[h+1]<<8|a[h+2])&s)===e&&a[h+3])return!0;return!1}spriteColorTouchesColor(t,e,n){var i=t.rotatedBounds();const a=i.right-i.left,l=i.top-i.bottom;if(a<1||l<1||a!=a||l!=l)return!1;r.canvas.width=o.canvas.width=a,r.canvas.height=o.canvas.height=l,r.ctx.save(),o.ctx.save(),r.ctx.translate(-(240+i.left),-(180-i.top)),o.ctx.translate(-(240+i.left),-(180-i.top)),this.drawAllExcept(r,t),o.noEffects=!0,o.drawChild(t),o.noEffects=!1,r.ctx.restore(),o.ctx.restore();var h=r.ctx.getImageData(0,0,a,l).data,c=o.ctx.getImageData(0,0,a,l).data;e&=s,n&=s;for(var d=h.length,u=0;u<d;u+=4){var p=((c[u]<<16|c[u+1]<<8|c[u+2])&s)===e&&c[u+3],m=((h[u]<<16|h[u+1]<<8|h[u+2])&s)===n&&h[u+3];if(p&&m)return!0}return!1}}})((e=t.renderer||(t.renderer={})).canvas2d||(e.canvas2d={}))}(P||(P={})),function(t){!function(t){t.multiply=function(t,e){const n=t[0],s=t[1],i=t[2],r=t[3],o=t[4],a=t[5],l=t[6],h=t[7],c=t[8],d=e[0],u=e[1],p=e[2],m=e[3],f=e[4],g=e[5],b=e[6],w=e[7],S=e[8];t[0]=d*n+u*r+p*l,t[1]=d*s+u*o+p*h,t[2]=d*i+u*a+p*c,t[3]=m*n+f*r+g*l,t[4]=m*s+f*o+g*h,t[5]=m*i+f*a+g*c,t[6]=b*n+w*r+S*l,t[7]=b*s+w*o+S*h,t[8]=b*i+w*a+S*c},t.translation=function(t,e){return[1,0,0,0,1,0,t,e,1]},t.rotation=function(t){const e=t*Math.PI/180,n=Math.cos(e),s=Math.sin(e);return[n,-s,0,s,n,0,0,0,1]},t.scaling=function(t,e){return[t,0,0,0,e,0,0,0,1]},t.projection=function(t,e){return[2/t,0,0,0,-2/e,0,-1,1,1]}}(t.m3||(t.m3={}))}(P||(P={})),function(t){!function(e){!function(e){const n=t.m3.scaling(-1,1);class s{constructor(t,e){this.gl=t,this.program=e,this.uniformLocations={},this.attributeLocations={};const n=t.getProgramParameter(e,this.gl.ACTIVE_UNIFORMS);for(let s=0;s<n;s++){const n=t.getActiveUniform(e,s);if(!n)throw new Error("uniform at index "+s+" does not exist");const i=n.name,r=t.getUniformLocation(e,i);if(!r)throw new Error("uniform named "+i+" does not exist");this.uniformLocations[i]=r}const s=t.getProgramParameter(e,this.gl.ACTIVE_ATTRIBUTES);for(let n=0;n<s;n++){const s=t.getActiveAttrib(e,n);if(!s)throw new Error("attribute at index "+n+" does not exist");this.attributeLocations[s.name]=t.getAttribLocation(e,s.name)}}uniform1f(t,e){const n=this.getUniform(t);this.gl.uniform1f(n,e)}uniform2f(t,e,n){const s=this.getUniform(t);this.gl.uniform2f(s,e,n)}uniform4f(t,e,n,s,i){const r=this.getUniform(t);this.gl.uniform4f(r,e,n,s,i)}uniformMatrix3(t,e){const n=this.getUniform(t);this.gl.uniformMatrix3fv(n,!1,e)}hasUniform(t){return this.uniformLocations.hasOwnProperty(t)}getUniform(t){if(!this.hasUniform(t))throw new Error("uniform of name "+t+" does not exist");return this.uniformLocations[t]}attributeBuffer(t,e){if(!this.hasAttribute(t))throw new Error("attribute of name "+t+" does not exist");const n=this.attributeLocations[t];this.gl.enableVertexAttribArray(n),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e),this.gl.vertexAttribPointer(n,2,this.gl.FLOAT,!1,0,0)}hasAttribute(t){return this.attributeLocations.hasOwnProperty(t)}getAttribute(t){if(!this.hasAttribute(t))throw new Error("attribute of name "+t+" does not exist");return this.attributeLocations[t]}}class i{constructor(){this.globalScaleMatrix=t.m3.scaling(1,1),this.costumeTextures=new Map,this.canvas=function(){const t=document.createElement("canvas");return t.width=480,t.height=360,t}();const e=this.canvas.getContext("webgl",this.getContextOptions());if(!e)throw new Error("cannot get webgl rendering context");this.gl=e,this.noFiltersShader=this.createShader(i.vertexShader,i.fragmentShader,[]),this.allFiltersShader=this.createShader(i.vertexShader,i.fragmentShader,["ENABLE_BRIGHTNESS","ENABLE_COLOR","ENABLE_GHOST","ENABLE_FISHEYE","ENABLE_MOSAIC","ENABLE_PIXELATE"]),this.gl.enable(this.gl.BLEND),this.gl.blendFuncSeparate(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.quadBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.quadBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),this.gl.STATIC_DRAW),this.reset(1)}getContextOptions(){return{alpha:!1}}compileShader(t,e,n){if(n)for(const t of n)e="#define "+t+"\n"+e;const s=this.gl.createShader(t);if(!s)throw new Error("Cannot create shader");if(this.gl.shaderSource(s,e),this.gl.compileShader(s),!this.gl.getShaderParameter(s,this.gl.COMPILE_STATUS)){const t=this.gl.getShaderInfoLog(s);throw this.gl.deleteShader(s),new Error("Shader compilation error: "+t)}return s}compileProgram(t,e,n){const s=this.compileShader(this.gl.VERTEX_SHADER,t,n),i=this.compileShader(this.gl.FRAGMENT_SHADER,e,n),r=this.gl.createProgram();if(!r)throw new Error("Cannot create program");if(this.gl.attachShader(r,s),this.gl.attachShader(r,i),this.gl.linkProgram(r),!this.gl.getProgramParameter(r,this.gl.LINK_STATUS)){const t=this.gl.getProgramInfoLog(r);throw this.gl.deleteProgram(r),new Error("Program compilation error: "+t)}return r}createShader(t,e,n){const i=this.compileProgram(t,e,n);return new s(this.gl,i)}convertToTexture(t){const e=this.gl.createTexture();if(!e)throw new Error("Cannot create texture");return this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),e}destroy(){const t=this.gl.getExtension("WEBGL_lose_context");t&&t.loseContext()}reset(e){this.canvas.width=480*e,this.canvas.height=360*e,this.gl.viewport(0,0,480*e,360*e),this.globalScaleMatrix[0]!==e&&(this.globalScaleMatrix=t.m3.scaling(e,e)),this.gl.clearColor(1,1,1,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}useShader(t){this.gl.useProgram(t.program),this.shader=t}drawChild(e){const s=e.costumes[e.currentCostumeIndex];if(!this.costumeTextures.has(s)){const t=s.getImage(),e=this.convertToTexture(t);this.costumeTextures.set(s,e)}this.gl.bindTexture(this.gl.TEXTURE_2D,this.costumeTextures.get(s)),this.shader.attributeBuffer("a_position",this.quadBuffer);const i=t.m3.projection(this.canvas.width,this.canvas.height);if(t.m3.multiply(i,this.globalScaleMatrix),t.m3.multiply(i,t.m3.translation(240+e.scratchX|0,180-e.scratchY|0)),t.core.isSprite(e)&&(0===e.rotationStyle&&90!==e.direction?t.m3.multiply(i,t.m3.rotation(90-e.direction)):1===e.rotationStyle&&e.direction<0&&t.m3.multiply(i,n),1!==e.scale&&t.m3.multiply(i,t.m3.scaling(e.scale,e.scale))),1!==s.scale&&t.m3.multiply(i,t.m3.scaling(s.scale,s.scale)),t.m3.multiply(i,t.m3.translation(-s.rotationCenterX,-s.rotationCenterY)),t.m3.multiply(i,t.m3.scaling(s.width,s.height)),this.shader.uniformMatrix3("u_matrix",i),this.shader.hasUniform("u_opacity")&&this.shader.uniform1f("u_opacity",1-e.filters.ghost/100),this.shader.hasUniform("u_brightness")&&this.shader.uniform1f("u_brightness",e.filters.brightness/100),this.shader.hasUniform("u_color")&&this.shader.uniform1f("u_color",e.filters.color/200),this.shader.hasUniform("u_mosaic")){const n=Math.round((Math.abs(e.filters.mosaic)+10)/10);this.shader.uniform1f("u_mosaic",t.utils.clamp(n,1,512))}this.shader.hasUniform("u_whirl")&&this.shader.uniform1f("u_whirl",e.filters.whirl*Math.PI/-180),this.shader.hasUniform("u_fisheye")&&this.shader.uniform1f("u_fisheye",Math.max(0,(e.filters.fisheye+100)/100)),this.shader.hasUniform("u_pixelate")&&this.shader.uniform1f("u_pixelate",Math.abs(e.filters.pixelate)/10),this.shader.hasUniform("u_size")&&this.shader.uniform2f("u_size",s.width,s.height),this.gl.drawArrays(this.gl.TRIANGLES,0,6)}drawTextureOverlay(e){const n=this.noFiltersShader;this.gl.useProgram(n.program),this.gl.bindTexture(this.gl.TEXTURE_2D,e),n.attributeBuffer("a_position",this.quadBuffer);const s=t.m3.projection(this.canvas.width,this.canvas.height);t.m3.multiply(s,this.globalScaleMatrix),t.m3.multiply(s,t.m3.translation(240,180)),t.m3.multiply(s,t.m3.scaling(1,1)),t.m3.multiply(s,t.m3.translation(-240,-180)),t.m3.multiply(s,t.m3.scaling(480,360)),n.uniformMatrix3("u_matrix",s),this.gl.drawArrays(this.gl.TRIANGLES,0,6)}}i.vertexShader="\n    attribute vec2 a_position;\n\n    uniform mat3 u_matrix;\n\n    varying vec2 v_texcoord;\n\n    void main() {\n      gl_Position = vec4((u_matrix * vec3(a_position, 1)).xy, 0, 1);\n      v_texcoord = a_position;\n    }\n    ",i.fragmentShader="\n    precision mediump float;\n\n    varying vec2 v_texcoord;\n\n    uniform sampler2D u_texture;\n\n    #ifdef ENABLE_BRIGHTNESS\n      uniform float u_brightness;\n    #endif\n    #ifdef ENABLE_COLOR\n      uniform float u_color;\n    #endif\n    #ifdef ENABLE_GHOST\n      uniform float u_opacity;\n    #endif\n    #ifdef ENABLE_MOSAIC\n      uniform float u_mosaic;\n    #endif\n    #ifdef ENABLE_WHIRL\n      uniform float u_whirl;\n    #endif\n    #ifdef ENABLE_FISHEYE\n      uniform float u_fisheye;\n    #endif\n    #ifdef ENABLE_PIXELATE\n      uniform float u_pixelate;\n      uniform vec2 u_size;\n    #endif\n    #ifdef ENABLE_COLOR_TEST\n      uniform vec3 u_colorTest;\n    #endif\n\n    const float minimumAlpha = 1.0 / 250.0;\n    const vec2 vecCenter = vec2(0.5, 0.5);\n\n    // http://lolengine.net/blog/2013/07/27/rgb-to-hsv-in-glsl\n    vec3 rgb2hsv(vec3 c) {\n      vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\n      vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);\n      vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);\n      float d = q.x - min(q.w, q.y);\n      float e = 1.0e-10;\n      return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\n    }\n    vec3 hsv2rgb(vec3 c) {\n      vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\n      vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n      return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n    }\n\n    void main() {\n      // varyings cannot be modified\n      vec2 texcoord = v_texcoord;\n\n      #ifdef ENABLE_MOSAIC\n      if (u_mosaic != 1.0) {\n        texcoord = fract(u_mosaic * v_texcoord);\n      }\n      #endif\n\n      #ifdef ENABLE_PIXELATE\n      if (u_pixelate != 0.0) {\n        vec2 texelSize = u_size / u_pixelate;\n        texcoord = (floor(texcoord * texelSize) + vecCenter) / texelSize;\n      }\n      #endif\n\n      #ifdef ENABLE_WHIRL\n      {\n        const float radius = 0.5;\n        vec2 offset = texcoord - vecCenter;\n        float offsetMagnitude = length(offset);\n        float whirlFactor = max(1.0 - (offsetMagnitude / radius), 0.0);\n        float whirlActual = u_whirl * whirlFactor * whirlFactor;\n        float sinWhirl = sin(whirlActual);\n        float cosWhirl = cos(whirlActual);\n        mat2 rotationMatrix = mat2(\n          cosWhirl, -sinWhirl,\n          sinWhirl, cosWhirl\n        );\n        texcoord = rotationMatrix * offset + vecCenter;\n      }\n      #endif\n\n      #ifdef ENABLE_FISHEYE\n      {\n        vec2 vec = (texcoord - vecCenter) / vecCenter;\n        float vecLength = length(vec);\n        float r = pow(min(vecLength, 1.0), u_fisheye) * max(1.0, vecLength);\n        vec2 unit = vec / vecLength;\n        texcoord = vecCenter + r * unit * vecCenter;\n      }\n      #endif\n\n      vec4 color = texture2D(u_texture, texcoord);\n      #ifndef DISABLE_MINIMUM_ALPHA\n      if (color.a < minimumAlpha) {\n        discard;\n      }\n      #endif\n\n      #ifdef ENABLE_GHOST\n        color.a *= u_opacity;\n      #endif\n\n      #ifdef ENABLE_COLOR\n      if (u_color != 0.0) {\n        vec3 hsv = rgb2hsv(color.rgb);\n        // hsv.x = hue\n        // hsv.y = saturation\n        // hsv.z = value\n\n        // scratch forces all colors to have some minimal amount saturation so there is a visual change\n        const float minValue = 0.11 / 2.0;\n        const float minSaturation = 0.09;\n        if (hsv.z < minValue) hsv = vec3(0.0, 1.0, minValue);\n        else if (hsv.y < minSaturation) hsv = vec3(0.0, minSaturation, hsv.z);\n\n        hsv.x = mod(hsv.x + u_color, 1.0);\n        if (hsv.x < 0.0) hsv.x += 1.0;\n        color = vec4(hsv2rgb(hsv), color.a);\n      }\n      #endif\n\n      #ifdef ENABLE_BRIGHTNESS\n        color.rgb = clamp(color.rgb + vec3(u_brightness), 0.0, 1.0);\n      #endif\n\n      #ifdef ENABLE_COLOR_TEST\n        if (color.rgb != u_colorTest) {\n          color = vec4(0.0, 0.0, 0.0, 0.0);\n        }\n      #endif\n\n      gl_FragColor = color;\n    }\n    ";class r extends i{constructor(){super(),this.gl.enable(this.gl.SCISSOR_TEST),this.gl.scissor(0,0,480,360),this.gl.clearColor(0,0,0,0),this.touchingShader=this.createShader(r.vertexShader,i.fragmentShader,["DISABLE_MINIMUM_ALPHA"]),this.shapeFiltersShader=this.createShader(r.vertexShader,i.fragmentShader,["ENABLE_FISHEYE","ENABLE_PIXELATE","ENABLE_MOSAIC"]),this.touchingColorShader=this.createShader(r.vertexShader,i.fragmentShader,["DISABLE_MINIMUM_ALPHA","ENABLE_COLOR_TEST"])}getContextOptions(){return{alpha:!0}}spritesIntersect(t,e){const n=t.rotatedBounds();for(const o of e){if(!o.visible||t===o)continue;const e=o.rotatedBounds();if(n.bottom>=e.top||e.bottom>=n.top||n.left>=e.right||e.left>=n.right)continue;const a=Math.max(n.left,e.left),l=Math.min(n.top,e.top),h=Math.min(n.right,e.right),c=Math.max(n.bottom,e.bottom),d=Math.max(h-a,1),u=Math.max(l-c,1);this.gl.scissor(240+a,180+c,d,u),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.useShader(this.allFiltersShader),this.drawChild(t),this.gl.blendFunc(this.gl.DST_ALPHA,this.gl.ZERO),this.useShader(this.touchingShader),this.drawChild(o),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);var s=new Uint8Array(d*u*4);this.gl.readPixels(240+a,180+c,d,u,this.gl.RGBA,this.gl.UNSIGNED_BYTE,s),this.gl.scissor(0,0,480,360);for(var i=s.length,r=0;r<i;r+=4)if(s[r+3])return!0}return!1}spriteTouchesPoint(t,e,n){const s=t.rotatedBounds();if(e<s.left||n<s.bottom||e>s.right||n>s.top||0===t.scale)return!1;const i=240+e|0,r=180+n|0;this.gl.scissor(i,r,1,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.useShader(this.shapeFiltersShader),this.drawChild(t);const o=new Uint8Array(4);return this.gl.readPixels(i,r,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,o),this.gl.scissor(0,0,480,360),0!==o[3]}}class o extends i{constructor(){super(),this.dirty=!1,this.penCoords=new Float32Array(65536),this.penLines=new Float32Array(32768),this.penColors=new Float32Array(65536),this.penCoordsIndex=0,this.penLinesIndex=0,this.penColorsIndex=0,this.penShader=this.createShader(o.PEN_VERTEX_SHADER,o.PEN_FRAGMENT_SHADER),this.positionBuffer=this.gl.createBuffer(),this.lineBuffer=this.gl.createBuffer(),this.colorBuffer=this.gl.createBuffer(),this.gl.viewport(0,0,this.canvas.width,this.canvas.height)}getContextOptions(){return{alpha:!0,preserveDrawingBuffer:!0}}pendingPenOperations(){return this.penLinesIndex>0}drawPendingOperations(){const t=this.gl;this.dirty=!0,this.useShader(this.penShader),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferData(t.ARRAY_BUFFER,this.penCoords,t.STREAM_DRAW),t.vertexAttribPointer(this.penShader.getAttribute("a_vertexData"),4,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this.penShader.getAttribute("a_vertexData")),t.bindBuffer(t.ARRAY_BUFFER,this.lineBuffer),t.bufferData(t.ARRAY_BUFFER,this.penLines,t.STREAM_DRAW),t.vertexAttribPointer(this.penShader.getAttribute("a_lineData"),2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this.penShader.getAttribute("a_lineData")),t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.bufferData(t.ARRAY_BUFFER,this.penColors,t.STREAM_DRAW),t.vertexAttribPointer(this.penShader.getAttribute("a_color"),4,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this.penShader.getAttribute("a_color")),t.drawArrays(t.TRIANGLES,0,(this.penCoordsIndex+1)/4),this.penCoordsIndex=0,this.penLinesIndex=0,this.penColorsIndex=0}buffersCanFit(t){return this.penCoordsIndex+t>this.penCoords.length}getCircleResolution(t){return Math.max(Math.ceil(t),3)}penLine(t,e,n,s,i,r){const o=this.getCircleResolution(e);this.buffersCanFit(24*(o+1))&&this.drawPendingOperations(),this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=i,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=r,this.penCoordsIndex++,this.penLines[this.penLinesIndex]=-Math.PI/2,this.penLinesIndex++,this.penLines[this.penLinesIndex]=e/2,this.penLinesIndex++,this.penCoords[this.penCoordsIndex]=i,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=r,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s,this.penCoordsIndex++,this.penLines[this.penLinesIndex]=Math.PI/2,this.penLinesIndex++,this.penLines[this.penLinesIndex]=e/2,this.penLinesIndex++,this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=i,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=r,this.penCoordsIndex++,this.penLines[this.penLinesIndex]=Math.PI/2,this.penLinesIndex++,this.penLines[this.penLinesIndex]=e/2,this.penLinesIndex++,this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=i,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=r,this.penCoordsIndex++,this.penLines[this.penLinesIndex]=Math.PI/2,this.penLinesIndex++,this.penLines[this.penLinesIndex]=e/2,this.penLinesIndex++,this.penCoords[this.penCoordsIndex]=i,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=r,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s,this.penCoordsIndex++,this.penLines[this.penLinesIndex]=-Math.PI/2,this.penLinesIndex++,this.penLines[this.penLinesIndex]=e/2,this.penLinesIndex++,this.penCoords[this.penCoordsIndex]=i,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=r,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s,this.penCoordsIndex++,this.penLines[this.penLinesIndex]=Math.PI/2,this.penLinesIndex++,this.penLines[this.penLinesIndex]=e/2,this.penLinesIndex++;for(var a=0;a<o;a++)this.penCoords[this.penCoordsIndex]=i,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=r,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s,this.penCoordsIndex++,this.penLines[this.penLinesIndex]=0,this.penLinesIndex++,this.penLines[this.penLinesIndex]=0,this.penLinesIndex++,this.penCoords[this.penCoordsIndex]=i,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=r,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s,this.penCoordsIndex++,this.penLines[this.penLinesIndex]=Math.PI/2+a/o*Math.PI,this.penLinesIndex++,this.penLines[this.penLinesIndex]=e/2,this.penLinesIndex++,this.penCoords[this.penCoordsIndex]=i,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=r,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s,this.penCoordsIndex++,this.penLines[this.penLinesIndex]=Math.PI/2+(a+1)/o*Math.PI,this.penLinesIndex++,this.penLines[this.penLinesIndex]=e/2,this.penLinesIndex++,this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=i,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=r,this.penCoordsIndex++,this.penLines[this.penLinesIndex]=0,this.penLinesIndex++,this.penLines[this.penLinesIndex]=0,this.penLinesIndex++,this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=i,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=r,this.penCoordsIndex++,this.penLines[this.penLinesIndex]=Math.PI/2+a/o*Math.PI,this.penLinesIndex++,this.penLines[this.penLinesIndex]=e/2,this.penLinesIndex++,this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=i,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=r,this.penCoordsIndex++,this.penLines[this.penLinesIndex]=Math.PI/2+(a+1)/o*Math.PI,this.penLinesIndex++,this.penLines[this.penLinesIndex]=e/2,this.penLinesIndex++;const[l,h,c,d]=t.toParts();for(a=0;a<6*o+6;a++)this.penColors[this.penColorsIndex]=l,this.penColorsIndex++,this.penColors[this.penColorsIndex]=h,this.penColorsIndex++,this.penColors[this.penColorsIndex]=c,this.penColorsIndex++,this.penColors[this.penColorsIndex]=d,this.penColorsIndex++}penDot(t,e,n,s){const i=this.getCircleResolution(e);this.buffersCanFit(12*i)&&this.drawPendingOperations();for(var r=1;r<i;r++)this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penLines[this.penLinesIndex]=0,this.penLinesIndex++,this.penLines[this.penLinesIndex]=0,this.penLinesIndex++,this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=n+1,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s+1,this.penCoordsIndex++,this.penLines[this.penLinesIndex]=Math.PI/2+(r-1)/i*2*Math.PI,this.penLinesIndex++,this.penLines[this.penLinesIndex]=e/2,this.penLinesIndex++,this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=n+1,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s+1,this.penCoordsIndex++,this.penLines[this.penLinesIndex]=Math.PI/2+r/i*2*Math.PI,this.penLinesIndex++,this.penLines[this.penLinesIndex]=e/2,this.penLinesIndex++;this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penLines[this.penLinesIndex]=0,this.penLinesIndex++,this.penLines[this.penLinesIndex]=0,this.penLinesIndex++,this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=n+1,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s+1,this.penCoordsIndex++,this.penLines[this.penLinesIndex]=Math.PI/2+(i-1)/i*2*Math.PI,this.penLinesIndex++,this.penLines[this.penLinesIndex]=e/2,this.penLinesIndex++,this.penCoords[this.penCoordsIndex]=n,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=n+1,this.penCoordsIndex++,this.penCoords[this.penCoordsIndex]=s+1,this.penCoordsIndex++,this.penLines[this.penLinesIndex]=Math.PI/2,this.penLinesIndex++,this.penLines[this.penLinesIndex]=e/2,this.penLinesIndex++;const[o,a,l,h]=t.toParts();for(r=0;r<3*i;r++)this.penColors[this.penColorsIndex]=o,this.penColorsIndex++,this.penColors[this.penColorsIndex]=a,this.penColorsIndex++,this.penColors[this.penColorsIndex]=l,this.penColorsIndex++,this.penColors[this.penColorsIndex]=h,this.penColorsIndex++}penStamp(t){this.dirty=!0,this.pendingPenOperations()&&this.drawPendingOperations(),this.useShader(this.allFiltersShader),this.drawChild(t)}penClear(){this.dirty=!0,this.penCoordsIndex=0,this.penLinesIndex=0,this.penColorsIndex=0,this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}}o.PEN_VERTEX_SHADER="\n    precision mediump float;\n\n    // [0] = x1\n    // [1] = y1\n    // [2] = x2\n    // [3] = y2\n    attribute vec4 a_vertexData;\n    // [0] = thickened vertex direction\n    // [1] = thickened vertex distance\n    attribute vec2 a_lineData;\n    // [0] = red\n    // [1] = green\n    // [2] = blue\n    // [3] = alpha\n    attribute vec4 a_color;\n\n    varying vec4 v_color;\n\n    void main() {\n      vec2 lineDir = normalize(a_vertexData.zw - a_vertexData.xy);\n\n      mat2 rot;\n      rot[0] = vec2(cos(a_lineData.x), sin(a_lineData.x));\n      rot[1] = vec2(-sin(a_lineData.x), cos(a_lineData.x));\n\n      lineDir *= rot * a_lineData.y;\n\n      vec2 p = (a_vertexData.xy + lineDir);\n      p.x /= 240.0;\n      p.y /= 180.0;\n\n      gl_Position = vec4(p, 0.0, 1.0);\n      v_color = vec4(a_color.xyz / 255.0, a_color.w);\n    }",o.PEN_FRAGMENT_SHADER="\n    precision mediump float;\n\n    varying vec4 v_color;\n\n    void main() {\n      gl_FragColor = v_color;\n    }";e.WebGLProjectRenderer=class extends i{constructor(e){super(),this.stage=e,this.zoom=1,this.collisionRenderer=new r,this.penRenderer=new o,this.fallbackRenderer=new t.renderer.canvas2d.ProjectRenderer2D(e)}drawFrame(){this.penRenderer.pendingPenOperations()&&this.penRenderer.drawPendingOperations(),this.penRenderer.dirty&&(this.updatePenTexture(),this.penRenderer.dirty=!1),this.reset(this.zoom),this.useShader(this.allFiltersShader),this.drawChild(this.stage),this.penTexture&&(this.drawTextureOverlay(this.penTexture),this.useShader(this.allFiltersShader));for(var t=0;t<this.stage.children.length;t++){var e=this.stage.children[t];e.visible&&this.drawChild(e)}this.gl.flush()}init(t){t.appendChild(this.canvas)}destroy(){super.destroy(),this.penRenderer.destroy(),this.collisionRenderer.destroy()}onStageFiltersChanged(){}penLine(t,e,n,s,i,r){this.penRenderer.penLine(t,e,n,s,i,r)}penDot(t,e,n,s){this.penRenderer.penDot(t,e,n,s)}penStamp(t){this.penRenderer.penStamp(t)}penClear(){this.penRenderer.penClear()}updatePenTexture(){this.penTexture?(this.gl.bindTexture(this.gl.TEXTURE_2D,this.penTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.penRenderer.canvas)):this.penTexture=this.convertToTexture(this.penRenderer.canvas)}resize(e){this.zoom=e*t.config.scale}spriteTouchesPoint(t,e,n){return this.collisionRenderer.spriteTouchesPoint(t,e,n)}spritesIntersect(t,e){return this.collisionRenderer.spritesIntersect(t,e)}spriteTouchesColor(t,e){return this.fallbackRenderer.spriteTouchesColor(t,e)}spriteColorTouchesColor(t,e,n){return this.fallbackRenderer.spriteColorTouchesColor(t,e,n)}}}(e.webgl||(e.webgl={}))}(t.renderer||(t.renderer={}))}(P||(P={}));
//# sourceMappingURL=index.6c7bd701.js.map
